<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Drawing Play â€“ Primary Steps</title>
<link rel="icon" href="assets/primary-steps-icon-512.png">
<style>

  :root{
    --bg0:#0b0d12; --bg1:#0f1320;
    --panel:#121621; --panel2:#0d1c36;
    --text:#eef2ff; --muted:rgba(238,242,255,.72);
    --line:rgba(255,255,255,.12);
    --accent:#7dd3fc; --accent2:#a78bfa; --good:#34d399; --bad:#fb7185;
    --ring:rgba(125,211,252,.30);
    --shadow:0 18px 40px rgba(0,0,0,.35);
    --r:18px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 700px at 20% 10%, rgba(125,211,252,.18), transparent 55%),
      radial-gradient(900px 600px at 80% 0%, rgba(167,139,250,.16), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    min-height:100vh;
  }

  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(10px);
    background: rgba(18,22,33,.72);
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1100px;margin:0 auto;padding:14px 16px;}
  .top{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  .brand{display:flex; align-items:center; gap:10px; min-width:0; text-decoration:none; color:var(--text);}
  .brand img{height:52px;width:auto;display:block; filter: drop-shadow(0 16px 30px rgba(125,211,252,.10));}
  .brand .title{font-weight:850; letter-spacing:.2px; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .brand .sub{display:block; font-size:12px; color:var(--muted); margin-top:2px}
  nav{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
  nav a{
    color:var(--text); text-decoration:none; font-weight:700; font-size:13px;
    padding:8px 10px; border-radius:12px;
    border:1px solid transparent;
    opacity:.92;
  }
  nav a:hover{border-color:var(--line); background:rgba(255,255,255,.04); opacity:1;}
  nav a.active{border-color:rgba(125,211,252,.35); background:rgba(125,211,252,.10); opacity:1;}

  .hero{padding:22px 16px 10px;}
  .hwrap{max-width:1100px;margin:0 auto;}
  h1{margin:0 0 6px; font-size:32px; letter-spacing:-.4px;}
  p.lead{margin:0; color:var(--muted); max-width:85ch; font-size:14px; line-height:1.45;}

  .grid{
    max-width:1100px; margin:14px auto 28px; padding:0 16px;
    display:grid; grid-template-columns: 1.15fr .85fr; gap:14px;
  }
  @media (max-width: 980px){ .grid{grid-template-columns:1fr; } nav{justify-content:flex-start;} }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:var(--r);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card .head{
    padding:14px 14px 10px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .pill{
    font-size:12px; font-weight:850;
    padding:6px 10px; border-radius:999px;
    background: rgba(125,211,252,.14);
    border:1px solid rgba(125,211,252,.25);
    color: var(--text);
    white-space:nowrap;
  }
  .body{padding:14px;}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .btn{
    appearance:none; border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    color:var(--text); font-weight:850;
    padding:10px 12px; border-radius:14px;
    cursor:pointer;
    text-decoration:none;
    display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{background: rgba(255,255,255,.08);}
  .btn.primary{
    border-color: rgba(125,211,252,.35);
    background: linear-gradient(180deg, rgba(125,211,252,.18), rgba(125,211,252,.07));
  }
  .btn.good{
    border-color: rgba(52,211,153,.35);
    background: linear-gradient(180deg, rgba(52,211,153,.18), rgba(52,211,153,.06));
  }
  .btn.danger{
    border-color: rgba(251,113,133,.35);
    background: linear-gradient(180deg, rgba(251,113,133,.18), rgba(251,113,133,.06));
  }

  .field{display:flex; flex-direction:column; gap:6px; min-width:240px;}
  label{font-size:12px; color:var(--muted); font-weight:800; letter-spacing:.02em;}
  select{
    width:100%;
    appearance:none;
    border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    font-weight:800;
    cursor:pointer;
    outline:none;
  }
  select:focus{box-shadow: 0 0 0 6px var(--ring);}

  .stat{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px; border-radius:14px;
    border:1px dashed rgba(238,242,255,.22);
    color: var(--muted);
  }
  .small{font-size:12px;color:var(--muted);}
  .msg{
    padding:10px 12px; border-radius:14px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color: var(--muted);
    margin-top:10px;
  }
  .msg.good{border-color:rgba(52,211,153,.35); background: rgba(52,211,153,.10); color: rgba(238,242,255,.92);}
  .msg.bad{border-color:rgba(251,113,133,.35); background: rgba(251,113,133,.10); color: rgba(238,242,255,.92);}

  /* Game stage */
  .stage{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
    background:
      radial-gradient(900px 500px at 10% 0%, rgba(125,211,252,.10), transparent 60%),
      linear-gradient(180deg, rgba(13,28,54,.65), rgba(13,28,54,.35));
  }

  /* Game cards selector */
  .selectorGrid{
    display:grid; grid-template-columns:1fr; gap:10px;
  }
  .gameCard{
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    border-radius:16px;
    padding:12px;
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .gameCard strong{display:block; font-size:14px; font-weight:950;}
  .gameCard .desc{font-size:12px; color:var(--muted); line-height:1.35; margin-top:4px;}
  .gameCard .tag{
    font-size:12px; font-weight:950;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    color: var(--muted);
    background: rgba(0,0,0,.10);
    white-space:nowrap;
  }
  .gameCard.active{
    border-color: rgba(125,211,252,.40);
    background: rgba(125,211,252,.08);
  }

  /* Connect 4 */
  .c4Wrap{display:grid; gap:12px; justify-items:center;}
  .c4Board{
    width:min(420px, 100%);
    aspect-ratio: 7 / 6;
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap:10px;
    padding:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
  }
  .c4Cell{
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    position:relative;
  }
  .c4Disc{
    width:100%; height:100%;
    border-radius:999px;
    transform: scale(.82);
    background: rgba(255,255,255,.06);
    box-shadow: inset 0 10px 20px rgba(0,0,0,.28);
  }
  .c4Disc.r{ background: rgba(251,113,133,.70); }
  .c4Disc.y{ background: rgba(253,224,71,.65); }
  .c4Top{
    width:min(420px, 100%);
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:10px;
  }
  .c4Top button{
    height:42px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.04);
    color:var(--text);
    font-weight:950;
    cursor:pointer;
  }
  .c4Top button:hover{background: rgba(255,255,255,.07);}
  .seg{
    display:flex; gap:8px; flex-wrap:wrap;
    padding:6px; border:1px solid var(--line);
    border-radius:16px; background:rgba(255,255,255,.03);
  }
  .seg button{border-radius:12px; padding:9px 12px;}
  .seg button.on{border-color:rgba(125,211,252,.45); background:rgba(125,211,252,.12);}

  /* Shape Sort */
  .shapeWrap{display:grid; gap:12px;}
  .bins{
    display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;
  }
  @media (max-width: 560px){ .bins{grid-template-columns:1fr;} .brand .title{display:none;} }

  .bin{
    border:1px dashed rgba(238,242,255,.22);
    border-radius:16px;
    padding:12px;
    min-height:120px;
    display:flex; flex-direction:column; gap:10px;
    background: rgba(0,0,0,.10);
  }
  .binTitle{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .binTitle strong{font-size:13px; font-weight:950;}
  .binTitle .mini{font-size:12px; color:var(--muted); font-weight:900;}
  .dropArea{
    flex:1;
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    display:flex; align-items:center; justify-content:center;
    background: rgba(255,255,255,.04);
  }
  .tray{
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:12px;
    background: rgba(0,0,0,.10);
  }
  .shapes{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .shape{
    width:56px; height:56px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    display:flex; align-items:center; justify-content:center;
    cursor:grab;
    user-select:none;
    touch-action:none;
  }

.meter{
  width:100%;
  height:12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.18);
  overflow:hidden;
}
.meter > span{
  display:block;
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(52,211,153,.55), rgba(125,211,252,.55), rgba(167,139,250,.55));
}
.celebrate{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:20;
  overflow:hidden;
}
.conf{
  position:absolute;
  width:10px; height:10px;
  border-radius:3px;
  opacity:.9;
  animation: confettiFall 900ms ease-out forwards;
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.25));
}
@keyframes confettiFall{
  from{ transform: translateY(-20px) rotate(0deg); opacity:0; }
  15%{ opacity:1; }
  to{ transform: translateY(240px) rotate(260deg); opacity:0; }
}

  .shape:active{cursor:grabbing;}
  .shape svg{width:34px; height:34px; display:block;}
  .bin.over{outline: 2px solid rgba(125,211,252,.45); outline-offset: 2px;}

  /* Coin game answer buttons (shared) */
  .choices{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px;}
  @media (max-width: 560px){ .choices{grid-template-columns:1fr;} }
  .choice{
    border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    border-radius:16px;
    padding:12px;
    cursor:pointer;
    user-select:none;
    text-align:left;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-weight:950;
    color:var(--text);
  }
  .choice:hover{background: rgba(255,255,255,.08);}
  .choice .tag{
    font-size:12px; font-weight:950;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    color: var(--muted);
    background: rgba(0,0,0,.10);
    white-space:nowrap;
  }


  /* Coin Piggy polish */
  .pigWrap{ position:relative; width:100%; }
  
  .bellyLayer{
    position:absolute;
    left:20%;
    top:42%;
    width:58%;
    height:44%;
    pointer-events:none;
    z-index:4;
    filter: drop-shadow(0 14px 22px rgba(0,0,0,.22));
  }
  .bellyItem{
    position:absolute;
    width:38px; height:38px;
    border-radius:999px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
  }
  .bellyItem.note{
    width:64px; height:38px;
    border-radius:12px;
  }
  .bellyItem img{
    width:100%; height:100%;
    object-fit:cover;
    transform: scale(1.02);
  }
  .moneyImg{
    width:56px; height:56px; border-radius:999px; object-fit:cover;
    border:1px solid rgba(255,255,255,.14);
    box-shadow: 0 10px 22px rgba(0,0,0,.28);
  }
  .moneyImg.note{
    width:92px; height:56px; border-radius:14px;
  }
.pigDrop{
    position:absolute;
    left:44%;
    top:17%;
    width:24%;
    height:12%;
    border-radius:16px;
    border:1px dashed rgba(238,242,255,.22);
    background: rgba(255,255,255,.03);
    display:flex;
    align-items:center;
    justify-content:center;
    color: var(--muted);
    font-weight:950;
    font-size:12px;
    user-select:none;
    touch-action:none;
  }

.meter{
  width:100%;
  height:12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.18);
  overflow:hidden;
}
.meter > span{
  display:block;
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(52,211,153,.55), rgba(125,211,252,.55), rgba(167,139,250,.55));
}
.celebrate{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:20;
  overflow:hidden;
}
.conf{
  position:absolute;
  width:10px; height:10px;
  border-radius:3px;
  opacity:.9;
  animation: confettiFall 900ms ease-out forwards;
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.25));
}
@keyframes confettiFall{
  from{ transform: translateY(-20px) rotate(0deg); opacity:0; }
  15%{ opacity:1; }
  to{ transform: translateY(240px) rotate(260deg); opacity:0; }
}

  .pigDrop::after{
    content:"Drop money here";
    opacity:.85;
  }
  .pigDrop.over{
    outline:2px solid rgba(125,211,252,.55);
    outline-offset:2px;
    background: rgba(125,211,252,.10);
    color: rgba(238,242,255,.92);
  }
  .coinTray{
    display:flex; gap:10px; flex-wrap:wrap;
    padding-top:10px;
  }
  .coinToken{
    width:72px; height:72px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    box-shadow: inset 0 12px 22px rgba(0,0,0,.30);
    display:flex; align-items:center; justify-content:center;
    cursor:grab;
    user-select:none;
    touch-action:none;
    transition: transform .12s ease, background .12s ease;
  }
  .coinToken:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
  .coinToken:active{ cursor:grabbing; transform: translateY(0px) scale(.98); }
  .coinToken.selected{ outline:2px solid rgba(125,211,252,.55); outline-offset:2px; }
  .flyCoin{
    position:absolute;
    width:58px; height:58px;
    pointer-events:none;
    z-index:5;
    will-change: transform, opacity;
    animation: coinDrop .38s ease-in forwards;
  }
  @keyframes coinDrop{
    0%{ transform: translate3d(var(--x0), var(--y0), 0) scale(1); opacity:1; }
    80%{ transform: translate3d(var(--x1), var(--y1), 0) scale(.98); opacity:1; }
    100%{ transform: translate3d(var(--x1), calc(var(--y1) + 10px), 0) scale(.96); opacity:0; }
  }



/* Drawing-specific */
.stage {
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(15,19,32,.55);
  padding: 12px;
}

.canvasWrap {
  position: relative;
  width: 100%;
  max-width: 820px;
  margin: 0 auto;
}
canvas {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: #ffffff;
  box-shadow: 0 18px 45px rgba(0,0,0,.28);
  touch-action: none;
}
.overlayLabel {
  position:absolute;
  left:12px; top:12px;
  padding:8px 10px;
  border-radius:999px;
  background: rgba(18,22,33,.85);
  border: 1px solid rgba(255,255,255,.14);
  font-weight: 850;
  font-size: 12px;
  color: var(--text);
}

.palette {
  display:flex;
  gap:10px;
  flex-wrap: wrap;
  align-items: center;
}
.swatch {
  width:34px;
  height:34px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 10px 24px rgba(0,0,0,.18);
  cursor:pointer;
}
.swatch.active {
  outline: 3px solid rgba(125,211,252,.55);
  outline-offset: 2px;
}

.sliderRow {
  display:flex;
  gap:10px;
  align-items: center;
  flex-wrap: wrap;
}
.range {
  appearance:none;
  width:min(320px, 100%);
}
.range::-webkit-slider-thumb {
  appearance:none;
  width:20px; height:20px;
  border-radius:999px;
  background: rgba(125,211,252,.95);
  border:1px solid rgba(255,255,255,.35);
}

.gallery {
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:10px;
}
@media (max-width: 520px) {
  .gallery { grid-template-columns: 1fr; }
}
.thumb {
  display:flex;
  gap:10px;
  align-items:center;
  padding:12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  cursor:pointer;
}
.thumb:hover { background: rgba(255,255,255,.08); }
.iconBox {
  width:44px; height:44px;
  border-radius: 14px;
  display:grid; place-items:center;
  background: rgba(125,211,252,.14);
  border: 1px solid rgba(125,211,252,.25);
  font-size: 18px;
}
.thumb .tmeta p { margin:0; }
.thumb .tmeta .tname { font-weight: 900; }
.thumb .tmeta .tdesc { color: var(--muted); font-size: 13px; }

.kbd {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: var(--text);
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <a class="brand" href="index.html" aria-label="Primary Steps home">
        <img src="assets/primary-steps-logo.png" alt="Primary Steps logo" onerror="this.style.display='none'">
        <div>
          <div class="title">Primary Steps</div>
          <span class="sub">Simple, calm learning activities</span>
        </div>
      </a>
      <nav aria-label="Primary">
        <a href="index.html">Home</a>
        <a href="letters.html">Letters</a>
        <a href="numbers.html">Numbers</a>
        <a href="phonics.html">Phonics</a>
        <a href="maths.html">Maths</a>
        <a href="memory.html">Memory</a>
        <a href="games.html" class="active">Games</a>
        <a href="puzzles.html">Puzzles</a>
        <a href="handwriting.html">Handwriting</a>
        <a href="clock.html">Clock</a>
        <a href="progress.html">Progress</a>
        <a href="settings.html">Settings</a>
      </nav>
    </div>
  </div>
</header>

<main class="container">
  <section class="hero">
    <h1 id="title">Drawing</h1>
    <p id="lead">Use your finger or mouse to draw. Choose a tool on the right.</p>
  </section>

  <section class="grid">
    <!-- LEFT: Canvas -->
    <div class="card">
      <div class="head">
        <div class="pill" id="pill">Play</div>
        <div class="controls">
          <button class="btn" id="newBtn">New</button>
          <button class="btn" id="undoBtn">Undo</button>
          <button class="btn" id="clearBtn">Clear</button>
          <button class="btn primary" id="saveBtn" title="Download your picture">Save</button>
        </div>
      </div>
      <div class="body">
        <div class="stage">
          <div class="canvasWrap">
            <div class="overlayLabel" id="overlayLabel" style="display:none;">Colouring</div>
            <canvas id="canvas" width="1200" height="800"></canvas>
          </div>
          <div class="msg" id="msg">Tip: Press <span class="kbd">E</span> for eraser, <span class="kbd">B</span> for brush.</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Options -->
    <div class="card">
      <div class="head">
        <div class="pill">Options</div>
      </div>
      <div class="body">
        <div id="colouringPicker" style="display:none;">
          <div class="row" style="margin-bottom:10px;">
            <button class="btn primary" id="pickAnother">Pick another picture</button>
          </div>
          <div class="gallery" id="gallery"></div>
          <div class="spacer"></div>
        </div>

        <div class="row">
          <button class="btn primary" id="toolBrush">Brush</button>
          <button class="btn" id="toolMarker">Marker</button>
          <button class="btn" id="toolSpray">Spray</button>
          <button class="btn" id="toolEraser">Eraser</button>
        </div>

        <div class="spacer"></div>

        <div class="palette" id="palette"></div>

        <div class="spacer"></div>

        <div class="sliderRow">
          <div class="pill">Size: <strong><span id="sizeLabel">14</span></strong></div>
          <input class="range" id="size" type="range" min="4" max="60" value="14">
        </div>

        <div class="spacer"></div>

        <div class="row">
          <label class="switch">
            <input type="checkbox" id="sound" checked>
            <span>Sound</span>
          </label>
          <label class="switch">
            <input type="checkbox" id="smooth" checked>
            <span>Smooth lines</span>
          </label>
        </div>

        <div class="spacer"></div>

        <div class="small" style="color:var(--muted);line-height:1.4;">
          <strong>Colouring:</strong> pick a picture, then colour on top.<br>
          <strong>Tip:</strong> Use <span class="kbd">Undo</span> if you make a mistake.
        </div>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  const params = new URLSearchParams(location.search);
  const activity = (params.get('activity') || 'freedraw').toLowerCase();

  const ui = {
    title: document.getElementById('title'),
    lead: document.getElementById('lead'),
    pill: document.getElementById('pill'),
    msg: document.getElementById('msg'),
    canvas: document.getElementById('canvas'),
    overlayLabel: document.getElementById('overlayLabel'),
    palette: document.getElementById('palette'),
    size: document.getElementById('size'),
    sizeLabel: document.getElementById('sizeLabel'),
    sound: document.getElementById('sound'),
    smooth: document.getElementById('smooth'),
    newBtn: document.getElementById('newBtn'),
    undoBtn: document.getElementById('undoBtn'),
    clearBtn: document.getElementById('clearBtn'),
    saveBtn: document.getElementById('saveBtn'),
    toolBrush: document.getElementById('toolBrush'),
    toolMarker: document.getElementById('toolMarker'),
    toolSpray: document.getElementById('toolSpray'),
    toolEraser: document.getElementById('toolEraser'),
    colouringPicker: document.getElementById('colouringPicker'),
    gallery: document.getElementById('gallery'),
    pickAnother: document.getElementById('pickAnother'),
  };

  const ctx = ui.canvas.getContext('2d', { willReadFrequently: false });

  // tiny click sound (silent data uri, safe fallback)
  const clickSound = new Audio();
  clickSound.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YQAAAAA=";
  function ping(){ if(ui.sound.checked){ try{ clickSound.currentTime=0; clickSound.play(); }catch(e){} } }

  const TOOLS = {
    brush:  { name:'Brush',  alpha:1.0, cap:'round', join:'round', scatter:0 },
    marker: { name:'Marker', alpha:0.55, cap:'round', join:'round', scatter:0 },
    spray:  { name:'Spray',  alpha:0.22, cap:'round', join:'round', scatter:18 },
    eraser: { name:'Eraser', alpha:1.0, cap:'round', join:'round', scatter:0, erase:true },
  };
  let toolKey = 'brush';

  const COLORS = ['#111827','#ef4444','#f97316','#facc15','#22c55e','#06b6d4','#3b82f6','#8b5cf6','#ec4899','#ffffff'];
  let color = COLORS[6];

  const undoStack = [];
  const MAX_UNDO = 25;

  function pushUndo(){
    try{
      if(undoStack.length >= MAX_UNDO) undoStack.shift();
      undoStack.push(ctx.getImageData(0,0,ui.canvas.width, ui.canvas.height));
      ui.undoBtn.disabled = undoStack.length === 0;
    }catch(e){}
  }
  function undo(){
    const snap = undoStack.pop();
    if(!snap) return;
    ctx.putImageData(snap, 0, 0);
    ui.undoBtn.disabled = undoStack.length === 0;
    ping();
  }

  function setMsg(kind, html){
    ui.msg.className = 'msg' + (kind ? ' ' + kind : '');
    ui.msg.innerHTML = html || '';
  }

  function resizeCanvasToCSS(){
    const rect = ui.canvas.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const w = Math.round(rect.width * dpr);
    const h = Math.round((rect.width * 2/3) * dpr);
    if (w < 300 || h < 200) return;

    const old = document.createElement('canvas');
    old.width = ui.canvas.width;
    old.height = ui.canvas.height;
    old.getContext('2d').drawImage(ui.canvas, 0, 0);

    ui.canvas.width = w;
    ui.canvas.height = h;

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,w,h);
    ctx.drawImage(old, 0, 0, w, h);
  }

  let drawing = false;
  let last = null;

  function getPos(e){
    const rect = ui.canvas.getBoundingClientRect();
    const t = (e.touches && e.touches[0]) ? e.touches[0] : e;
    const x = (t.clientX - rect.left) * (ui.canvas.width / rect.width);
    const y = (t.clientY - rect.top) * (ui.canvas.height / rect.height);
    return {x, y};
  }

  function setStrokeStyle(){
    const size = Number(ui.size.value);
    const t = TOOLS[toolKey];
    ctx.lineWidth = size;
    ctx.lineCap = t.cap;
    ctx.lineJoin = t.join;
    ctx.globalAlpha = t.alpha;

    if(t.erase){
      ctx.globalCompositeOperation = 'destination-out';
      ctx.strokeStyle = 'rgba(0,0,0,1)';
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = color;
    }
  }

  function drawSegment(a, b){
    setStrokeStyle();
    const t = TOOLS[toolKey];
    const smooth = ui.smooth.checked;

    if(t.scatter > 0){
      const size = Number(ui.size.value);
      for(let i=0;i<t.scatter;i++){
        const ang = Math.random() * Math.PI * 2;
        const rad = Math.random() * (size * 0.9);
        const x = b.x + Math.cos(ang) * rad;
        const y = b.y + Math.sin(ang) * rad;
        ctx.beginPath();
        ctx.arc(x, y, Math.max(1, size * 0.08), 0, Math.PI*2);
        ctx.fillStyle = t.erase ? 'rgba(0,0,0,1)' : color;
        ctx.fill();
      }
      return;
    }

    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    if(smooth){
      const midX = (a.x + b.x) / 2;
      const midY = (a.y + b.y) / 2;
      ctx.quadraticCurveTo(a.x, a.y, midX, midY);
    } else {
      ctx.lineTo(b.x, b.y);
    }
    ctx.stroke();
  }

  function beginStroke(p){
    pushUndo();
    drawing = true;
    last = p;
    drawSegment(p, p);
  }
  function endStroke(){ drawing = false; last = null; }

  function clearCanvas(){
    pushUndo();
    ctx.globalCompositeOperation = 'source-over';
    ctx.globalAlpha = 1;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,ui.canvas.width, ui.canvas.height);
    if(activity === 'colouring') drawOutline(currentOutlineKey);
    ping();
  }

  function saveImage(){
    const link = document.createElement('a');
    link.download = (activity === 'colouring' ? 'colouring' : 'drawing') + '.png';
    link.href = ui.canvas.toDataURL('image/png');
    link.click();
  }

  // Outline templates (black line art)
  const OUTLINES = {
    bird: {
      name:'Bird', icon:'ðŸ¦',
      draw:(ctx,w,h)=>{
        const s = Math.min(w,h);
        ctx.save();
        ctx.translate(w*0.15, h*0.18);
        ctx.scale(s/900, s/900);
        ctx.lineWidth = 10; ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.strokeStyle='#111827';

        ctx.beginPath(); ctx.ellipse(330, 420, 220, 160, -0.2, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(280, 420);
        ctx.quadraticCurveTo(380, 300, 520, 360);
        ctx.quadraticCurveTo(430, 450, 300, 450);
        ctx.stroke();

        ctx.beginPath(); ctx.ellipse(520, 330, 90, 80, 0, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(600, 330); ctx.lineTo(700, 300); ctx.lineTo(610, 360); ctx.closePath(); ctx.stroke();
        ctx.beginPath(); ctx.arc(545, 320, 10, 0, Math.PI*2); ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(140, 420);
        ctx.quadraticCurveTo(70, 380, 40, 320);
        ctx.quadraticCurveTo(110, 350, 160, 370);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(380, 560); ctx.lineTo(360, 640);
        ctx.moveTo(450, 560); ctx.lineTo(470, 640);
        ctx.stroke();

        ctx.restore();
      }
    },
    car: {
      name:'Car', icon:'ðŸš—',
      draw:(ctx,w,h)=>{
        const s = Math.min(w,h);
        ctx.save();
        ctx.translate(w*0.08, h*0.25);
        ctx.scale(s/900, s/900);
        ctx.lineWidth = 10; ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.strokeStyle='#111827';

        ctx.beginPath();
        ctx.moveTo(120, 420);
        ctx.quadraticCurveTo(200, 260, 340, 260);
        ctx.lineTo(520, 260);
        ctx.quadraticCurveTo(620, 260, 700, 340);
        ctx.quadraticCurveTo(780, 360, 820, 420);
        ctx.lineTo(820, 520);
        ctx.quadraticCurveTo(820, 560, 780, 560);
        ctx.lineTo(120, 560);
        ctx.quadraticCurveTo(80, 560, 80, 520);
        ctx.lineTo(80, 460);
        ctx.quadraticCurveTo(80, 420, 120, 420);
        ctx.closePath();
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(310, 280);
        ctx.lineTo(520, 280);
        ctx.quadraticCurveTo(590, 280, 640, 330);
        ctx.lineTo(360, 330);
        ctx.quadraticCurveTo(330, 330, 310, 300);
        ctx.closePath();
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(260, 560, 70, 0, Math.PI*2);
        ctx.arc(650, 560, 70, 0, Math.PI*2);
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(260, 560, 28, 0, Math.PI*2);
        ctx.arc(650, 560, 28, 0, Math.PI*2);
        ctx.stroke();

        ctx.restore();
      }
    },
    butterfly: {
      name:'Butterfly', icon:'ðŸ¦‹',
      draw:(ctx,w,h)=>{
        const s = Math.min(w,h);
        ctx.save();
        ctx.translate(w*0.18, h*0.12);
        ctx.scale(s/900, s/900);
        ctx.lineWidth = 10; ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.strokeStyle='#111827';

        ctx.beginPath();
        ctx.moveTo(350, 150);
        ctx.quadraticCurveTo(320, 350, 350, 560);
        ctx.quadraticCurveTo(380, 350, 350, 150);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(340, 150); ctx.quadraticCurveTo(280, 80, 240, 60);
        ctx.moveTo(360, 150); ctx.quadraticCurveTo(420, 80, 460, 60);
        ctx.stroke();

        ctx.beginPath();
        ctx.ellipse(220, 320, 180, 220, -0.2, 0, Math.PI*2);
        ctx.ellipse(480, 320, 180, 220, 0.2, 0, Math.PI*2);
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(220, 320, 60, 0, Math.PI*2);
        ctx.arc(480, 320, 60, 0, Math.PI*2);
        ctx.stroke();

        ctx.restore();
      }
    },
    cat: {
      name:'Cat', icon:'ðŸ±',
      draw:(ctx,w,h)=>{
        const s = Math.min(w,h);
        ctx.save();
        ctx.translate(w*0.18, h*0.12);
        ctx.scale(s/900, s/900);
        ctx.lineWidth = 10; ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.strokeStyle='#111827';

        ctx.beginPath(); ctx.ellipse(350, 320, 220, 200, 0, 0, Math.PI*2); ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(220, 200); ctx.lineTo(170, 80); ctx.lineTo(290, 150); ctx.closePath();
        ctx.moveTo(480, 200); ctx.lineTo(530, 80); ctx.lineTo(410, 150); ctx.closePath();
        ctx.stroke();

        ctx.beginPath();
        ctx.ellipse(280, 320, 40, 55, 0, 0, Math.PI*2);
        ctx.ellipse(420, 320, 40, 55, 0, 0, Math.PI*2);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(350, 380);
        ctx.lineTo(320, 410);
        ctx.lineTo(380, 410);
        ctx.closePath();
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(350, 410);
        ctx.quadraticCurveTo(330, 440, 300, 440);
        ctx.moveTo(350, 410);
        ctx.quadraticCurveTo(370, 440, 400, 440);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(180, 390); ctx.lineTo(290, 390);
        ctx.moveTo(180, 420); ctx.lineTo(290, 405);
        ctx.moveTo(520, 390); ctx.lineTo(410, 390);
        ctx.moveTo(520, 420); ctx.lineTo(410, 405);
        ctx.stroke();

        ctx.restore();
      }
    }
  };
  let currentOutlineKey = 'bird';

  function drawOutline(key){
    currentOutlineKey = key;
    const w = ui.canvas.width, h = ui.canvas.height;
    ctx.globalCompositeOperation = 'source-over';
    ctx.globalAlpha = 1;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,w,h);
    OUTLINES[key].draw(ctx,w,h);
    setMsg('', `Colouring: <strong>${OUTLINES[key].name}</strong>. Pick colours and colour it in!`);
  }

  function buildGallery(){
    ui.gallery.innerHTML = '';
    Object.entries(OUTLINES).forEach(([k,v])=>{
      const div = document.createElement('div');
      div.className = 'thumb';
      div.innerHTML = `
        <div class="iconBox">${v.icon}</div>
        <div class="tmeta">
          <p class="tname">${v.name}</p>
          <p class="tdesc">Tap to choose</p>
        </div>
      `;
      div.addEventListener('click', ()=>{
        ping();
        pushUndo();
        drawOutline(k);
        ui.colouringPicker.style.display = 'none';
      });
      ui.gallery.appendChild(div);
    });
  }

  function setTool(k){
    toolKey = k;
    [ui.toolBrush, ui.toolMarker, ui.toolSpray, ui.toolEraser].forEach(b=>b.classList.remove('primary'));
    (k==='brush'?ui.toolBrush:k==='marker'?ui.toolMarker:k==='spray'?ui.toolSpray:ui.toolEraser).classList.add('primary');
    ping();
  }

  function setColor(c){
    color = c;
    [...ui.palette.querySelectorAll('.swatch')].forEach(s=>s.classList.remove('active'));
    const active = ui.palette.querySelector(`[data-color="${c}"]`);
    if(active) active.classList.add('active');
    if(toolKey==='eraser') setTool('brush');
    ping();
  }

  function buildPalette(){
    ui.palette.innerHTML = '';
    COLORS.forEach(c=>{
      const s = document.createElement('div');
      s.className = 'swatch';
      s.style.background = c;
      s.dataset.color = c;
      s.title = c;
      s.addEventListener('click', ()=> setColor(c));
      ui.palette.appendChild(s);
    });
  }

  function onDown(e){ e.preventDefault(); beginStroke(getPos(e)); }
  function onMove(e){
    if(!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    if(last) drawSegment(last, p);
    last = p;
  }
  function onUp(e){ if(!drawing) return; e.preventDefault(); endStroke(); }

  ui.canvas.addEventListener('pointerdown', onDown);
  ui.canvas.addEventListener('pointermove', onMove);
  ui.canvas.addEventListener('pointerup', onUp);
  ui.canvas.addEventListener('pointercancel', onUp);
  ui.canvas.addEventListener('pointerleave', onUp);

  ui.size.addEventListener('input', ()=>{ ui.sizeLabel.textContent = ui.size.value; });
  ui.undoBtn.addEventListener('click', undo);
  ui.clearBtn.addEventListener('click', clearCanvas);
  ui.saveBtn.addEventListener('click', saveImage);

  ui.toolBrush.addEventListener('click', ()=>setTool('brush'));
  ui.toolMarker.addEventListener('click', ()=>setTool('marker'));
  ui.toolSpray.addEventListener('click', ()=>setTool('spray'));
  ui.toolEraser.addEventListener('click', ()=>setTool('eraser'));

  ui.newBtn.addEventListener('click', ()=>{
    if(activity === 'colouring'){
      ui.colouringPicker.style.display = '';
      ui.overlayLabel.style.display = '';
      buildGallery();
      setMsg('', 'Pick a picture, then colour it in.');
    } else {
      clearCanvas();
      setMsg('good', 'Fresh page âœ…');
    }
  });

  ui.pickAnother?.addEventListener('click', ()=>{
    ui.colouringPicker.style.display = '';
    buildGallery();
  });

  window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase() === 'e') setTool('eraser');
    if(e.key.toLowerCase() === 'b') setTool('brush');
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='z') undo();
  });

  // init
  buildPalette();
  setColor(color);
  setTool('brush');
  ui.sizeLabel.textContent = ui.size.value;
  ui.undoBtn.disabled = true;

  setTimeout(()=>{
    resizeCanvasToCSS();
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,ui.canvas.width, ui.canvas.height);

    if(activity === 'colouring'){
      ui.title.textContent = 'Colouring';
      ui.lead.innerHTML = 'Pick a picture and colour it in using the tools on the right.';
      ui.pill.textContent = 'Colouring';
      ui.overlayLabel.style.display = '';
      ui.colouringPicker.style.display = '';
      buildGallery();
      setMsg('', 'Pick a picture to start.');
    } else {
      ui.title.textContent = 'Free Drawing';
      ui.lead.innerHTML = 'Draw anything you like with colours, brushes and an eraser.';
      ui.pill.textContent = 'Free Draw';
      setMsg('', 'Tip: choose a colour and start drawing.');
    }
  }, 80);

  window.addEventListener('resize', ()=>{
    resizeCanvasToCSS();
  });
})();
</script>
</body>
</html>
