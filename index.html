<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="512x512" href="assets/primary-steps-icon-512.png">
  <link rel="apple-touch-icon" sizes="512x512" href="assets/primary-steps-icon-512.png">
  <meta name="theme-color" content="#0b3a79">
<title>Primary Steps</title>
  <meta name="description" content="Primary Steps ‚Äî calm, fun learning for primary school children." />

  <style>
    :root{
      --bg:#f5f7fa;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --shadow: 0 10px 24px rgba(0,0,0,0.08);
      --shadow2: 0 4px 14px rgba(0,0,0,0.06);
      --radius:18px;
      --accent:#2f80ed;
      --accent2:#0f172a;
      --good:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --tap:76px;
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* Header */
    header{
      position: sticky;
      top:0;
      z-index: 50;
      background:#fff;
      box-shadow: var(--shadow2);
    }
    .topbar{
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }
    .logoWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 2px 0;
      flex: 0 0 auto;
    }
    .brandText{
      min-width:0;
    }
    .brandText h1{
      margin:0;
      font-size: 1.2rem;
      line-height: 1.1;
      letter-spacing: .2px;
    }
    .brandText p{
      margin:4px 0 0;
      color: var(--muted);
      font-size: .95rem;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 55vw;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      background:#f8fafc;
      border-radius: 999px;
      font-weight: 700;
      color: var(--accent2);
      user-select:none;
    }
    .pill small{ color: var(--muted); font-weight: 700; }
    .btn{
      border:0;
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      background: var(--accent);
      color:#fff;
      box-shadow: 0 6px 14px rgba(47,128,237,0.25);
    }
    .btn.secondary{
      background: var(--accent2);
      box-shadow: 0 6px 14px rgba(15,23,42,0.18);
    }
    .btn.ghost{
      background:#fff;
      color: var(--accent2);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn:active{ transform: translateY(1px); }

    /* Main */
    main{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 60px;
    }
    .intro{
      margin: 14px auto 10px;
      color: var(--muted);
      line-height: 1.5;
      max-width: 850px;
    }

    /* Cards */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 14px;
      margin-top: 14px;
    }
    .card{
      background: var(--card);
      border: 1px solid rgba(226,232,240,0.9);
      border-radius: var(--radius);
      padding: 16px 16px;
      box-shadow: var(--shadow2);
      cursor:pointer;
      text-decoration:none;
      color:inherit;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      transition: transform .12s ease, box-shadow .12s ease;
      min-height: 72px;
    }
    .card:hover{
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    .card .left{
      display:flex; gap:10px; align-items:center; min-width:0;
    }
    .badge{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      background:#f1f5f9;
      border: 1px solid var(--line);
      font-size: 20px;
      flex:0 0 auto;
    }
    .card h3{ margin:0; font-size: 1.05rem; }
    .card p{ margin:2px 0 0; color: var(--muted); font-size: .92rem; line-height:1.3; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 46ch; }
    .chip{
      flex:0 0 auto;
      padding: 8px 10px;
      border-radius: 999px;
      background:#0f172a;
      color:#fff;
      font-weight: 800;
      font-size: .9rem;
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    /* Screens */
    .screen{
      display:none;
      margin-top: 16px;
      background: var(--card);
      border: 1px solid rgba(226,232,240,0.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 16px;
    }
    .screen.active{ display:block; }
    .screenHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .screenHeader h2{
      margin: 0;
      font-size: 1.25rem;
    }
    .screenHeader .sub{
      margin: 6px 0 0;
      color: var(--muted);
      line-height: 1.4;
      max-width: 70ch;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .panel{
      background:#f8fafc;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      margin-top: 12px;
    }

    .feedback{
      min-height: 24px;
      font-weight: 900;
      margin-top: 8px;
    }
    .feedback.good{ color: var(--good); }
    .feedback.bad{ color: var(--bad); }
    .feedback.warn{ color: var(--warn); }

    /* Game buttons */
    .options{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .optBtn{
      border: 2px solid var(--line);
      background:#fff;
      border-radius: 16px;
      padding: 16px 12px;
      min-height: var(--tap);
      cursor:pointer;
      font-weight: 900;
      font-size: 34px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform .1s ease, border-color .1s ease;
      user-select:none;
    }
    .optBtn:hover{ transform: translateY(-1px); }
    .optBtn:active{ transform: translateY(1px); }

    .mini{
      font-size: 18px;
      font-weight: 900;
      padding: 12px;
      min-height: 54px;
    }

    /* Memory */
    .memoryGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .memCard{
      border: 2px solid var(--line);
      background:#fff;
      border-radius: 16px;
      min-height: 72px;
      cursor:pointer;
      font-weight: 900;
      font-size: 28px;
      display:grid;
      place-items:center;
      user-select:none;
      transition: transform .08s ease;
    }
    .memCard:active{ transform: translateY(1px); }

    /* Phonics */
    .phonicsRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .soundBtn{
      border: 2px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 12px 14px;
      cursor:pointer;
      font-weight: 900;
      min-width: 70px;
      user-select:none;
    }
    .buildBox{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 12px;
      border-radius: 16px;
      background:#fff;
      border: 2px dashed #cbd5e1;
      min-height: 56px;
      align-items:center;
      margin-top: 10px;
    }
    .tile{
      padding: 10px 12px;
      border-radius: 14px;
      background:#0f172a;
      color:#fff;
      font-weight: 900;
      user-select:none;
    }

    /* Maths */
    .tabs{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .tab{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 10px 14px;
      cursor:pointer;
      font-weight: 900;
      user-select:none;
    }
    .tab.active{
      background: var(--accent2);
      color:#fff;
      border-color: var(--accent2);
    }
    .mathRow{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .questionBig{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
    }
    .qText{
      font-size: 1.4rem;
      font-weight: 1000;
      letter-spacing: .3px;
    }
    .clockWrap{
      display:flex;
      gap: 14px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    canvas#clockCanvas{
      width: 220px;
      height: 220px;
      border-radius: 999px;
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: var(--shadow2);
    }

    /* Handwriting */

/* Games */
/* Money Game (UK) */
    .moneyWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .moneyTop{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .moneyTarget{
      background: radial-gradient(900px 240px at 20% 0%, rgba(34,197,94,0.10), transparent 65%),
                  linear-gradient(180deg, #ffffff, #f8fafc);
      border: 1px solid rgba(226,232,240,0.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 12px 14px;
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      flex: 1 1 320px;
      min-width: 280px;
    }
    .moneyTarget .label{
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .2px;
    }
    .moneyTarget .value{
      font-size: 1.5rem;
      font-weight: 1000;
    }
    .moneyTarget .sub{
      color: var(--muted);
      font-weight: 800;
      font-size: .95rem;
      margin-top: 2px;
    }
    .moneyStage{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 860px){
      .moneyStage{ grid-template-columns: 1fr; }
    }

    .pigBank{
      position: relative;
      border-radius: var(--radius);
      border: 1px solid rgba(226,232,240,0.95);
      background: radial-gradient(1200px 320px at 20% 0%, rgba(139,92,246,0.10), transparent 65%),
                  radial-gradient(900px 280px at 90% 10%, rgba(47,128,237,0.10), transparent 60%),
                  linear-gradient(180deg, #ffffff, #f8fafc);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:hidden;
      min-height: 320px;
    }
    .pigRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
      gap:10px;
    }
    .totalPill{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background:#0f172a;
      color:#fff;
      font-weight: 1000;
      box-shadow: 0 12px 26px rgba(15,23,42,0.25);
    }
    .coinDropArea{
      margin-top: 12px;
      border-radius: 18px;
      border: 2px dashed rgba(203,213,225,0.9);
      background: rgba(255,255,255,0.75);
      min-height: 120px;
      padding: 12px;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .coinToken{
      width: 56px;
      height: 56px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-weight: 1000;
      border: 2px solid rgba(15,23,42,0.16);
      box-shadow: inset 0 10px 18px rgba(255,255,255,0.22),
                  inset 0 -14px 22px rgba(0,0,0,0.18),
                  0 14px 26px rgba(15,23,42,0.10);
      user-select:none;
    }
    .coinToken.small{ width: 48px; height: 48px; font-size: .95rem; }
    .coinToken.note{
      width: 92px;
      height: 52px;
      border-radius: 14px;
      font-size: 1.05rem;
      border: 2px solid rgba(15,23,42,0.16);
      background: linear-gradient(180deg, rgba(255,255,255,0.25), rgba(0,0,0,0.06));
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 0 10px;
    }

    .coinPalette{
      border-radius: var(--radius);
      border: 1px solid rgba(226,232,240,0.95);
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      box-shadow: var(--shadow2);
      padding: 14px;
    }
    .paletteGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .paletteGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    .coinBtn{
      border:0;
      background: transparent;
      padding: 0;
      cursor:pointer;
    }
    .coinBtn:active{ transform: translateY(1px); }

    .coin-1p{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.10) 45%, rgba(0,0,0,0.35) 100%), #b45309; color:#fff; }
    .coin-2p{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.10) 45%, rgba(0,0,0,0.35) 100%), #c2410c; color:#fff; }
    .coin-5p{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.10) 45%, rgba(0,0,0,0.35) 100%), #94a3b8; color:#0f172a; }
    .coin-10p{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.10) 45%, rgba(0,0,0,0.35) 100%), #a3a3a3; color:#0f172a; }
    .coin-20p{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.10) 45%, rgba(0,0,0,0.35) 100%), #9ca3af; color:#0f172a; }
    .coin-50p{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.10) 45%, rgba(0,0,0,0.35) 100%), #bdbdbd; color:#0f172a; }
    .coin-100p{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.10) 45%, rgba(0,0,0,0.35) 100%), #f59e0b; color:#0f172a; }
    .coin-200p{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.10) 45%, rgba(0,0,0,0.35) 100%), #fbbf24; color:#0f172a; }

    .note-500{ background: linear-gradient(180deg, rgba(255,255,255,0.25), rgba(0,0,0,0.06)), #22c55e; color:#0f172a; }
    .note-1000{ background: linear-gradient(180deg, rgba(255,255,255,0.25), rgba(0,0,0,0.06)), #3b82f6; color:#0f172a; }

    .moneyActions{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
      margin-top: 10px;
    }
    .moneyMsg{

      margin-top: 10px;
      min-height: 24px;
      font-weight: 1000;
    }

    .coinBtn[draggable="true"]{ -webkit-user-drag: element; }
    .coinToken.dragging{ opacity: .65; transform: scale(0.98); }
    .coinDropArea.dragOver{
      border-color: rgba(34,197,94,0.8);
      box-shadow: 0 0 0 4px rgba(34,197,94,0.12) inset;
      background: rgba(34,197,94,0.06);
    }
    .coinDropArea .coinToken{
      cursor: pointer;
    }
    .coinDropArea .coinToken:hover{
      transform: translateY(-1px);
      box-shadow: inset 0 10px 18px rgba(255,255,255,0.22),
                  inset 0 -14px 22px rgba(0,0,0,0.18),
                  0 18px 28px rgba(15,23,42,0.14);
    }
    .coinDropArea .coinToken.removing{
      animation: popOut 220ms ease-in forwards;
    }
    @keyframes popOut{
      from{ transform: scale(1); opacity:1; }
      to{ transform: scale(0.85) translateY(6px); opacity:0; }
    }

    .clink{
      position:absolute;
      pointer-events:none;
      font-weight: 1000;
      background: rgba(15,23,42,0.92);
      color:#fff;
      padding: 8px 10px;
      border-radius: 999px;
      box-shadow: 0 16px 28px rgba(15,23,42,0.25);
      transform: translate(-50%, -50%);
      animation: clinkFloat 520ms ease-out forwards;
    }
    @keyframes clinkFloat{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(0.92); }
      20%{ opacity:1; transform: translate(-50%,-60%) scale(1.0); }
      100%{ opacity:0; transform: translate(-50%,-110%) scale(1.05); }
    }

.gameShell{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .gameHeaderBar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .gameBoard{
      background: radial-gradient(1000px 260px at 20% 0%, rgba(47,128,237,0.10), transparent 60%),
                  linear-gradient(180deg, #ffffff, #f8fafc);
      border: 1px solid rgba(226,232,240,0.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }

    /* Connect 4 */
    .c4Grid{
      display:grid;
      grid-template-columns: repeat(7, minmax(0,1fr));
      gap: 10px;
      padding: 12px;
      border-radius: 18px;
      background: #0f172a;
      box-shadow: inset 0 10px 24px rgba(255,255,255,0.06);
    }
    .c4Cell{
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.08) 45%, rgba(0,0,0,0.35) 100%);
      border: 2px solid rgba(255,255,255,0.18);
      cursor:pointer;
    }
    .c4Cell.red{
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.10) 45%, rgba(0,0,0,0.40) 100%), #ef4444;
      box-shadow: inset 0 10px 18px rgba(255,255,255,0.12), inset 0 -14px 22px rgba(0,0,0,0.25);
    }
    .c4Cell.yellow{
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.12) 45%, rgba(0,0,0,0.40) 100%), #f59e0b;
      box-shadow: inset 0 10px 18px rgba(255,255,255,0.14), inset 0 -14px 22px rgba(0,0,0,0.25);
    }

    /* Mini Tetris */
    .tetrisWrap{
      display:flex;
      gap: 14px;
      align-items:flex-start;
      flex-wrap: wrap;
    }
    canvas#tetrisCanvas{
      border-radius: 18px;
      border: 1px solid rgba(226,232,240,0.95);
      background: #0b1220;
      box-shadow: var(--shadow);
      touch-action:none;
    }
    .tetrisControls{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      width: 260px;
      max-width: 100%;
    }
    .tBtn{
      border: 1px solid rgba(226,232,240,0.95);
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      border-radius: 16px;
      padding: 14px 12px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(15,23,42,0.08);
      user-select:none;
    }

/* Handwriting Premium */
    .traceTools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
    }
    .toolGroup{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toolChip{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      border: 1px solid rgba(226,232,240,0.95);
      box-shadow: 0 10px 22px rgba(15,23,42,0.08);
      user-select:none;
      font-weight: 900;
    }
    .seg{
      display:flex;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background:#fff;
      box-shadow: 0 8px 18px rgba(15,23,42,0.06);
    }
    .seg button{
      border:0;
      background:transparent;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 900;
      color: var(--accent2);
      min-width: 52px;
    }
    .seg button.active{
      background: linear-gradient(180deg, rgba(47,128,237,0.18), rgba(47,128,237,0.06));
      color: var(--accent2);
    }

    .traceStage{
      position: relative;
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(226,232,240,0.95);
      background: radial-gradient(1200px 300px at 20% 0%, rgba(47,128,237,0.10), transparent 60%),
                  radial-gradient(900px 220px at 90% 10%, rgba(139,92,246,0.10), transparent 60%),
                  linear-gradient(180deg, #ffffff, #f8fafc);
      padding: 12px;
    }

    canvas#traceCanvas{
      width: 100%;
      max-width: 980px;
      height: 320px;
      border-radius: 16px;
      background: rgba(255,255,255,0.9);
      border: 2px dashed rgba(203,213,225,0.9);
      touch-action:none;
      display:block;
      margin: 0 auto;
    }

    .traceOverlay{
      position:absolute;
      inset: 12px;
      border-radius: 16px;
      pointer-events:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .traceGuide{
      width: min(820px, 92%);
      height: 86%;
      opacity: 0.55;
      filter: drop-shadow(0 16px 24px rgba(15,23,42,0.12));
    }

    .traceFooterHint{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 10px;
      color: var(--muted);
      font-weight: 700;
    }


    .traceWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    canvas#traceCanvas{
      width: 100%;
      max-width: 860px;
      height: 260px;
      border-radius: var(--radius);
      background:#fff;
      border: 2px dashed #cbd5e1;
      touch-action:none;
    }
    .hint{
      color: var(--muted);
      line-height: 1.45;
      margin: 6px 0 0;
    }

    /* Modal */
    .backdrop{
      position:fixed;
      inset:0;
      background: rgba(15,23,42,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 100;
    }
    .backdrop.show{ display:flex; }
    .modal{
      background:#fff;
      border-radius: 22px;
      width: min(560px, 100%);
      box-shadow: var(--shadow);
      border: 1px solid rgba(226,232,240,0.9);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .modalHeader h3{ margin:0; font-size: 1.1rem; }
    .modalBody{ padding: 14px 16px; }
    .formRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .formRow:last-child{ border-bottom:0; }
    .formRow label{ font-weight: 900; }
    .formRow small{ color: var(--muted); display:block; margin-top: 4px; font-weight: 700; }
    select, input[type="checkbox"]{
      transform: scale(1.1);
    }
    .modalFooter{
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    footer{
      text-align:center;
      color:#64748b;
      padding: 18px 16px 34px;
    }

    @media (max-width: 520px){
      .brandText p{ max-width: 60vw; }
      .options{ grid-template-columns: 1fr; }
      .memoryGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
      .qText{ font-size: 1.25rem; }
      canvas#clockCanvas{ width: 200px; height: 200px; }
      :root{ --tap: 74px; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; }
    }
    .reduceMotion *{ transition:none !important; }
  
/* === Primary Steps (Logo-matched blue premium theme) === */
    :root{
      --accent: #1d6fe8;
      --accentDeep:#0b2a5b;
      --accentGlow: rgba(29,111,232,0.32);
      --accentGlow2: rgba(92,167,255,0.22);
      --line: rgba(226,232,240,0.95);
      --muted: #445063;
      --radius: 20px;
      --shadow: 0 18px 55px rgba(15,23,42,0.12);
      --shadow2: 0 14px 34px rgba(15,23,42,0.10);
    }

    body{
      background:
        radial-gradient(1200px 420px at 18% 0%, rgba(29,111,232,0.20), transparent 62%),
        radial-gradient(980px 360px at 84% 10%, rgba(92,167,255,0.18), transparent 58%),
        linear-gradient(180deg, #f6fbff, #eef6ff);
      color:#0f172a;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,0.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      box-shadow: 0 10px 30px rgba(15,23,42,0.06);
    }

    .brand{
      display:flex;
      gap: 14px;
      align-items:center;
    }

    .logo{
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(248,250,252,0.92));
      border: 1px solid rgba(226,232,240,0.95);
      box-shadow:
        0 22px 50px rgba(15,23,42,0.12),
        0 18px 48px var(--accentGlow);
      overflow:hidden;
    }
    #brandLogo{
      width: 92%;
      height: 92%;
      object-fit: contain;
      filter: drop-shadow(0 12px 18px rgba(15,23,42,0.18));
      transform: translateY(1px);
    }

    .homePanel{
      border-radius: 28px;
      border: 1px solid rgba(226,232,240,0.95);
      background:
        radial-gradient(1200px 360px at 22% 0%, rgba(29,111,232,0.12), transparent 60%),
        radial-gradient(900px 300px at 86% 10%, rgba(92,167,255,0.10), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,0.94), rgba(248,250,252,0.94));
      box-shadow: var(--shadow);
      padding: 26px;
    }

    /* Fix cards: prevent button overlap & make premium */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 14px;
      align-items: stretch;
    }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }

    a.card{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 16px 16px;
      border-radius: 22px;
      border: 1px solid rgba(226,232,240,0.95);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(248,250,252,0.92));
      box-shadow: var(--shadow2);
      text-decoration:none;
      color: inherit;
      min-height: 102px;
      position: relative;
      overflow:hidden;
    }
    a.card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(820px 220px at 10% 0%, rgba(29,111,232,0.14), transparent 55%),
        radial-gradient(820px 220px at 92% 12%, rgba(92,167,255,0.12), transparent 55%);
      opacity:.95;
      pointer-events:none;
    }
    a.card > *{ position: relative; }
    a.card:hover{ transform: translateY(-1px); box-shadow: 0 24px 60px rgba(15,23,42,0.14); }
    a.card:active{ transform: translateY(0px); }

    .card .left{
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .card .badge{
      width: 50px;
      height: 50px;
      border-radius: 18px;
      display:grid;
      place-items:center;
      font-size: 1.2rem;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(241,245,249,0.92));
      border: 1px solid rgba(226,232,240,0.95);
      box-shadow: 0 12px 24px rgba(15,23,42,0.10);
      flex: 0 0 auto;
    }
    .card h3{
      margin:0;
      font-size: 1.10rem;
      font-weight: 1000;
      letter-spacing: .1px;
      color: var(--accentDeep);
    }
    .card p{
      margin: 3px 0 0 0;
      color: var(--muted);
      font-weight: 850;
      font-size: 0.95rem;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
      max-width: 280px;
    }
    .card .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 1000;
      background: linear-gradient(180deg, rgba(11,42,91,0.96), rgba(11,42,91,0.90));
      color:#fff;
      box-shadow: 0 18px 36px rgba(11,42,91,0.20);
      min-width: 92px;
      flex: 0 0 auto;
      white-space: nowrap;
    }

    /* Buttons: blue premium */
    .btn{
      border-radius: 999px;
      border: 1px solid rgba(226,232,240,0.95);
      padding: 10px 14px;
      font-weight: 1000;
      background: linear-gradient(180deg, rgba(29,111,232,0.18), rgba(29,111,232,0.08));
      color: var(--accentDeep);
      box-shadow: 0 14px 26px rgba(15,23,42,0.08);
    }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(11,42,91,0.96), rgba(11,42,91,0.90));
      color:#fff;
      border-color: rgba(11,42,91,0.28);
      box-shadow: 0 18px 36px rgba(11,42,91,0.18);
    }
    .btn.ghost{
      background: rgba(255,255,255,0.76);
      color: var(--accentDeep);
    }
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logoWrap">
        <img src="assets/primary-steps-logo.png" alt="Primary Steps" class="siteLogo" />
      </div>
      <div class="brandText">
        <h1>Primary Steps</h1>
        <p>Calm, fun learning for primary school children</p>
      </div>
    </div>

    <div class="actions">
      <div class="pill" title="Stars are saved on this device">
        ‚≠ê <span id="topStars">0</span>
        <small>stars</small>
      </div>
      <button class="btn ghost" id="openSettings" type="button">Settings</button>
      <button class="btn secondary" id="goHome" type="button">Home</button>
    </div>
  </div>
</header>

<main>
  <p class="intro">
    Pick an activity. Keep sessions short and repeatable ‚Äî that‚Äôs where progress comes from.
  </p>

  <!-- HOME -->
  <section id="homeScreen" class="screen active" aria-label="Home">
    <div class="grid">
      <a class="card" href="#letters" data-nav="letters">
        <div class="left">
          <div class="badge">üî§</div>
          <div>
            <h3>Letters</h3>
            <p>Pick the matching letter (big buttons).</p>
          </div>
        </div>
        <div class="chip">Play</div>
      </a>

      <a class="card" href="#numbers" data-nav="numbers">
        <div class="left">
          <div class="badge">üî¢</div>
          <div>
            <h3>Numbers</h3>
            <p>Count the objects and choose the answer.</p>
          </div>
        </div>
        <div class="chip">Play</div>
      </a>

      <a class="card" href="#memory" data-nav="memory">
        <div class="left">
          <div class="badge">üß†</div>
          <div>
            <h3>Memory Match</h3>
            <p>Find pairs ‚Äî focus and attention practice.</p>
          </div>
        </div>
        <div class="chip">Game</div>
      </a>


      <a class="card" href="#games" data-nav="games">
        <div class="left">
          <div class="badge">üéÆ</div>
          <div>
            <h3>Games</h3>
            <p>Fun brain breaks: Connect 4 and Mini Tetris.</p>
          </div>
        </div>
        <div class="chip">Play</div>
      </a>

      <a class="card" href="#phonics" data-nav="phonics">
        <div class="left">
          <div class="badge">üîä</div>
          <div>
            <h3>Phonics</h3>
            <p>Blend sounds to make simple words.</p>
          </div>
        </div>
        <div class="chip">Blend</div>
      </a>

      <a class="card" href="#maths" data-nav="maths">
        <div class="left">
          <div class="badge">‚ûï</div>
          <div>
            <h3>Maths</h3>
            <p>Add, subtract, divide, and tell the time.</p>
          </div>
        </div>
        <div class="chip">Learn</div>
      </a>


      <a class="card" href="#clock" data-nav="clock">
        <div class="left">
          <div class="badge">üïí</div>
          <div>
            <h3>Clock</h3>
            <p>Practise telling the time on an analogue clock.</p>
          </div>
        </div>
        <div class="chip">Time</div>
      </a>

      <a class="card" href="#handwriting" data-nav="handwriting">
        <div class="left">
          <div class="badge">‚úçÔ∏è</div>
          <div>
            <h3>Handwriting</h3>
            <p>Trace letters and simple words.</p>
          </div>
        </div>
        <div class="chip">Trace</div>
      </a>

      <a class="card" href="#progress" data-nav="progress">
        <div class="left">
          <div class="badge">‚≠ê</div>
          <div>
            <h3>Progress</h3>
            <p>Stars and sessions saved on this device.</p>
          </div>
        </div>
        <div class="chip">View</div>
      </a>
    </div>
  </section>

  <!-- LETTERS -->
  <section id="lettersScreen" class="screen" aria-label="Letters Game">
    <div class="screenHeader">
      <div>
        <h2>üî§ Letters</h2>
        <p class="sub">Tap the letter that matches the big one.</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="lettersHear" type="button">Hear</button>
        <button class="btn" id="lettersNext" type="button">Next</button>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div class="qText">Match: <span id="lettersTarget" style="font-size:2rem;">A</span></div>
        <div class="pill">‚≠ê <span id="lettersStars">0</span> <small>stars</small></div>
      </div>
      <div class="options" id="lettersOptions"></div>
      <div id="lettersFeedback" class="feedback" aria-live="polite"></div>
    </div>
  </section>

  <!-- NUMBERS -->
  <section id="numbersScreen" class="screen" aria-label="Numbers Game">
    <div class="screenHeader">
      <div>
        <h2>üî¢ Numbers</h2>
        <p class="sub">Count the objects and choose the number.</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="numbersHear" type="button">Hear</button>
        <button class="btn" id="numbersNext" type="button">Next</button>
      </div>
    </div>

    <div class="panel">
      <div class="questionBig">
        <div>
          <div class="qText">How many?</div>
          <div class="hint">Count the stars below.</div>
        </div>
        <div class="pill">‚≠ê <span id="numbersStars">0</span> <small>stars</small></div>
      </div>

      <div style="margin-top:12px; font-size:30px;" id="numbersObjects" aria-label="Objects to count"></div>
      <div class="options" id="numbersOptions"></div>
      <div id="numbersFeedback" class="feedback" aria-live="polite"></div>
    </div>
  </section>

  <!-- MEMORY -->
  <section id="memoryScreen" class="screen" aria-label="Memory Match">
    <div class="screenHeader">
      <div>
        <h2>üß† Memory Match</h2>
        <p class="sub">Tap two cards to find a matching pair.</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="memoryNew" type="button">New Game</button>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div class="pill">‚≠ê <span id="memoryStars">0</span> <small>stars</small></div>
        <div class="pill">‚úÖ <span id="memoryMatches">0</span> <small>matches</small></div>
      </div>
      <div class="memoryGrid" id="memoryGrid"></div>
      <div id="memoryFeedback" class="feedback" aria-live="polite"></div>
    </div>
  </section>

  <!-- PHONICS -->
  <section id="phonicsScreen" class="screen" aria-label="Phonics Blend Builder">
    <div class="screenHeader">
      <div>
        <h2>üîä Phonics</h2>
        <p class="sub">Tap sounds to build a word, then tap Blend.</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="phonicsClear" type="button">Clear</button>
        <button class="btn" id="phonicsBlend" type="button">Blend</button>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div class="pill">‚≠ê <span id="phonicsStars">0</span> <small>stars</small></div>
        <div class="pill">Word: <span id="phonicsWord" style="font-weight:1000;">‚Äî</span></div>
      </div>

      <div class="hint" style="margin-top:10px;">Try: c-a-t, s-u-n, m-a-p</div>
      <div class="buildBox" id="phonicsBuild"></div>

      <div class="phonicsRow" id="phonicsSounds"></div>

      <div id="phonicsFeedback" class="feedback" aria-live="polite"></div>
    </div>
  </section>

  <!-- MATHS -->
  <section id="mathsScreen" class="screen" aria-label="Maths">
    <div class="screenHeader">
      <div>
        <h2>‚ûï Maths</h2>
        <p class="sub">Choose a mode: addition, subtraction, multiplication, division, or mixed practice.</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="mathsHear" type="button">Hear</button>
        <button class="btn" id="mathsNext" type="button">Next</button>
      </div>
    </div>

    <div class="panel">
      <div class="tabs" id="mathTabs">
        <button class="tab active" data-mode="add">‚ûï Add</button>
        <button class="tab" data-mode="sub">‚ûñ Subtract</button>
        <button class="tab" data-mode="mul">‚úñÔ∏è Multiply</button>
        <button class="tab" data-mode="div">‚ûó Divide</button>
        <button class="tab" data-mode="mix">üß© Mixed</button>
</div>

      <div class="row" style="justify-content:space-between; margin-top:10px;">
        <div class="pill">‚≠ê <span id="mathsStars">0</span> <small>stars</small></div>
        <div class="pill">Mode: <span id="mathModeLabel" style="font-weight:1000;">Add</span></div>
      </div>

      <div class="mathRow" id="mathModeArea"></div>
      <div id="mathsFeedback" class="feedback" aria-live="polite"></div>
    </div>
  </section>

  

  <!-- CLOCK -->
  <section id="clockScreen" class="screen" aria-label="Clock (Analogue time)">
    <div class="screenHeader">
      <div>
        <h2>üïí Clock</h2>
        <p class="sub">Look at the clock and choose the correct time.</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="clockHear" type="button">Hear</button>
        <button class="btn" id="clockNext" type="button">Next</button>
      </div>
    </div>

    <div class="panel">
      <div class="tabs" id="clockTabs">
        <button class="tab active" data-level="oclock">O‚Äôclock</button>
        <button class="tab" data-level="half">Half past</button>
        <button class="tab" data-level="quarter">Quarter past/to</button>
        <button class="tab" data-level="five">5‚Äëminute</button>
      </div>

      <div class="row" style="justify-content:space-between; margin-top:10px;">
        <div class="pill">‚≠ê <span id="clockStars">0</span> <small>stars</small></div>
        <div class="pill">Level: <span id="clockLevelLabel" style="font-weight:1000;">O‚Äôclock</span></div>
      </div>

      <div class="clockWrap" style="margin-top:12px;">
        <canvas id="clockCanvas2" width="240" height="240" aria-label="Analogue clock"></canvas>

        <div style="flex:1 1 280px;">
          <div class="questionBig">
            <div>
              <div class="qText" id="clockQuestion">What time is it?</div>
              <div class="hint" id="clockHint">Choose the correct time.</div>
            </div>
          </div>

          <div class="options" id="clockOptions"></div>
          <div id="clockFeedback" class="feedback" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </section>

<!-- HANDWRITING -->
  <section id="handwritingScreen" class="screen" aria-label="Handwriting tracing">
    <div class="screenHeader">
      <div>
        <h2>‚úçÔ∏è Handwriting</h2>
        <p class="sub">Trace the letter or word. Tap Clear if you want to try again.</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="traceClear" type="button">Clear</button>
        <button class="btn" id="traceNext" type="button">Next</button>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div class="pill">‚≠ê <span id="traceStars">0</span> <small>stars</small></div>
        <div class="pill">Trace: <span id="traceTarget" style="font-weight:1000;">A</span></div>
      </div>

            <div class="traceTools">
        <div class="toolGroup">
          <div class="toolChip" title="Choose a pen size">
            Pen
            <div class="seg" id="penSizeSeg">
              <button type="button" data-size="6" class="active">S</button>
              <button type="button" data-size="9">M</button>
              <button type="button" data-size="12">L</button>
            </div>
          </div>

          <div class="toolChip" title="Switch between pen and eraser">
            Tool
            <div class="seg" id="toolSeg">
              <button type="button" data-tool="pen" class="active">‚úçÔ∏è</button>
              <button type="button" data-tool="eraser">üßΩ</button>
            </div>
          </div>
        </div>

        <div class="toolGroup">
          <button class="btn ghost" id="traceUndo" type="button">Undo</button>
          <button class="btn ghost" id="traceClear" type="button">Clear</button>
          <button class="btn" id="traceNext" type="button">Next</button>
        </div>
      </div>

      <div class="traceWrap">
        <div class="traceStage">
          <canvas id="traceCanvas" width="980" height="320" aria-label="Tracing canvas"></canvas>
          <div class="traceOverlay" aria-hidden="true">
            <svg class="traceGuide" id="traceGuideSvg" viewBox="0 0 900 300" xmlns="http://www.w3.org/2000/svg"></svg>
          </div>
        </div>

        <div class="traceFooterHint">
          <span>Tip: Use a finger on a tablet, or a stylus for best control.</span>
          <span>Tap <strong>Done</strong> when you finish.</span>
        </div>

        <div class="row">
          <button class="btn ghost" id="traceHear" type="button">Hear</button>
          <button class="btn secondary" id="traceDone" type="button">Done</button>
        </div>
        <div id="traceFeedback" class="feedback" aria-live="polite"></div>
      </div>
        <canvas id="traceCanvas" width="900" height="260" aria-label="Tracing canvas"></canvas>
        
        <div class="row">
          <button class="btn ghost" id="traceHear" type="button">Hear</button>
          <button class="btn secondary" id="traceDone" type="button">Done</button>
        </div>
        <div id="traceFeedback" class="feedback" aria-live="polite"></div>
      </div>
    </div>
  </section>

    <!-- GAMES -->
  <section id="gamesScreen" class="screen" aria-label="Games">
    <div class="screenHeader">
      <div>
        <h2>üéÆ Games</h2>
        <p class="sub">Short, simple games for fun breaks. Keep it calm and friendly.</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="gamesHome" type="button">Home</button>
      </div>
    </div>

    <div class="panel">
      <div class="tabs" id="gameTabs">
        <button class="tab active" data-game="connect4">Connect 4</button>
        <button class="tab" data-game="tetris">Mini Tetris</button>
      
        <button class="tab" data-game="money">Money</button>
      </div>

      <div id="gameArea" style="margin-top:12px;"></div>
      <div class="hint" style="margin-top:10px;">Tip: These games are optional ‚Äúbrain breaks‚Äù. No scores are shared anywhere.</div>
    </div>
  </section>

<!-- PROGRESS -->
  <section id="progressScreen" class="screen" aria-label="Progress">
    <div class="screenHeader">
      <div>
        <h2>‚≠ê Progress</h2>
        <p class="sub">Saved on this device. Reset only if you want to start over.</p>
      </div>
      <div class="row">
        <button class="btn ghost" id="resetProgress" type="button">Reset</button>
      </div>
    </div>

    <div class="panel">
      <div class="grid" style="grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));">
        <div class="card" style="cursor:default; box-shadow:none;">
          <div class="left">
            <div class="badge">‚≠ê</div>
            <div>
              <h3>Total stars</h3>
              <p>Earned across all activities</p>
            </div>
          </div>
          <div class="chip" id="pTotalStars">0</div>
        </div>

        <div class="card" style="cursor:default; box-shadow:none;">
          <div class="left">
            <div class="badge">üìÖ</div>
            <div>
              <h3>Sessions</h3>
              <p>How many times you played</p>
            </div>
          </div>
          <div class="chip" id="pSessions">0</div>
        </div>

        <div class="card" style="cursor:default; box-shadow:none;">
          <div class="left">
            <div class="badge">üéØ</div>
            <div>
              <h3>Correct</h3>
              <p>Correct answers / matches</p>
            </div>
          </div>
          <div class="chip" id="pCorrect">0</div>
        </div>

        <div class="card" style="cursor:default; box-shadow:none;">
          <div class="left">
            <div class="badge">üõ†Ô∏è</div>
            <div>
              <h3>Difficulty</h3>
              <p>Your current setting</p>
            </div>
          </div>
          <div class="chip" id="pDifficulty">Medium</div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="row" style="justify-content:space-between;">
          <strong>Activity totals</strong>
          <span class="hint" style="margin:0;">(this device only)</span>
        </div>
        <div style="margin-top:8px; color:var(--muted); line-height:1.6;">
          üî§ Letters played: <strong id="pLetters">0</strong><br/>
          üî¢ Numbers played: <strong id="pNumbers">0</strong><br/>
          üß† Memory played: <strong id="pMemory">0</strong><br/>
          üîä Phonics played: <strong id="pPhonics">0</strong><br/>
          ‚ûï Maths played: <strong id="pMaths">0</strong><br/>
          ‚úçÔ∏è Handwriting played: <strong id="pTrace">0</strong>
        </div>
      </div>
    </div>
  </section>

</main>

<footer>¬© <span id="year"></span> Primary Steps</footer>

<!-- SETTINGS MODAL -->
<div class="backdrop" id="settingsBackdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal">
    <div class="modalHeader">
      <h3 id="settingsTitle">Settings</h3>
      <button class="btn ghost" id="closeSettings" type="button">Close</button>
    </div>

    <div class="modalBody">
      <div class="formRow">
        <div>
          <label for="setSound">Sound</label>
          <small>Voice feedback (uses your device voice)</small>
        </div>
        <input id="setSound" type="checkbox" />
      </div>

      <div class="formRow">
        <div>
          <label for="setDifficulty">Difficulty</label>
          <small>Easy, Medium, Hard (changes Letters/Numbers/Maths)</small>
        </div>
        <select id="setDifficulty">
          <option value="easy">Easy</option>
          <option value="medium" selected>Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>

      <div class="formRow">
        <div>
          <label for="setSession">Session mode</label>
          <small>Short guided sessions (gentle)</small>
        </div>
        <input id="setSession" type="checkbox" />
      </div>

      <div class="formRow">
        <div>
          <label for="setReduceMotion">Reduce motion</label>
          <small>Less animation (helpful if sensitive)</small>
        </div>
        <input id="setReduceMotion" type="checkbox" />
      </div>

      <p class="hint" style="margin-top:12px;">
        Tip: keep sessions 3‚Äì8 minutes. Repeat daily for the best results.
      </p>
    </div>

    <div class="modalFooter">
      <button class="btn secondary" id="saveSettings" type="button">Save</button>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities ---------- */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

const store = {
  get(key, fallback){
    try{
      const v = localStorage.getItem(key);
      return v === null ? fallback : JSON.parse(v);
    }catch{ return fallback; }
  },
  set(key, val){
    try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
  }
};

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function uniqueChoices(target, pool, count){
  const picks = new Set([target]);
  while(picks.size < count){
    picks.add(pool[Math.floor(Math.random()*pool.length)]);
  }
  return shuffle(Array.from(picks));
}

/* ---------- Settings ---------- */
const SETTINGS_KEY = "ps_settings_v1";
const PROG_KEY = "ps_progress_v1";

let settings = store.get(SETTINGS_KEY, {
  sound: false,
  difficulty: "medium",
  sessionMode: false,
  reduceMotion: false,
});

let progress = store.get(PROG_KEY, {
  stars: 0,
  sessions: 0,
  correct: 0,
  wrong: 0,
  played: { letters:0, numbers:0, memory:0, phonics:0, maths:0, trace:0 }
});

function applySettings(){
  $("#setSound").checked = settings.sound;
  $("#setDifficulty").value = settings.difficulty;
  $("#setSession").checked = settings.sessionMode;
  $("#setReduceMotion").checked = settings.reduceMotion;

  document.body.classList.toggle("reduceMotion", !!settings.reduceMotion);

  updateTopStars();
  updateProgressUI();
}

function saveSettings(){
  settings.sound = $("#setSound").checked;
  settings.difficulty = $("#setDifficulty").value;
  settings.sessionMode = $("#setSession").checked;
  settings.reduceMotion = $("#setReduceMotion").checked;
  store.set(SETTINGS_KEY, settings);
  applySettings();
}

/* ---------- Speech ---------- */
function speak(text, rate=0.9){
  if(!settings.sound) return;
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = rate;
    window.speechSynthesis.speak(u);
  }catch{}
}

/* ---------- Navigation ---------- */
function showScreen(name){
  $$(".screen").forEach(s => s.classList.remove("active"));
  const map = {
    home: "#homeScreen",
    letters: "#lettersScreen",
    numbers: "#numbersScreen",
    memory: "#memoryScreen",
    phonics: "#phonicsScreen",
    maths: "#mathsScreen",
    handwriting: "#handwritingScreen",
    progress: "#progressScreen",
    clock: "#clockScreen",
    games: "#gamesScreen",
  };

  const el = $(map[name] || "#homeScreen");
  el.classList.add("active");
  if(name === "progress") updateProgressUI();
  // count sessions when leaving home into an activity (simple heuristic)
}

function navTo(name){
  showScreen(name);
  if(name !== "home"){
    progress.sessions += 1;
    store.set(PROG_KEY, progress);
    updateProgressUI();
  }
}

/* ---------- Stars + Progress ---------- */
function addStar(n=1){
  progress.stars += n;
  store.set(PROG_KEY, progress);
  updateTopStars();
  updateProgressUI();
}
function markCorrect(){
  progress.correct += 1;
  store.set(PROG_KEY, progress);
  updateProgressUI();
}
function markWrong(){
  progress.wrong += 1;
  store.set(PROG_KEY, progress);
  updateProgressUI();
}
function updateTopStars(){
  $("#topStars").textContent = progress.stars;
}
function updateProgressUI(){
  $("#pTotalStars").textContent = progress.stars;
  $("#pSessions").textContent = progress.sessions;
  $("#pCorrect").textContent = progress.correct;
  $("#pDifficulty").textContent = settings.difficulty[0].toUpperCase()+settings.difficulty.slice(1);

  $("#pLetters").textContent = progress.played.letters;
  $("#pNumbers").textContent = progress.played.numbers;
  $("#pMemory").textContent = progress.played.memory;
  $("#pPhonics").textContent = progress.played.phonics;
  $("#pMaths").textContent = progress.played.maths;
  $("#pTrace").textContent = progress.played.trace;

  $("#lettersStars").textContent = progress.stars;
  $("#numbersStars").textContent = progress.stars;
  $("#memoryStars").textContent = progress.stars;
  $("#phonicsStars").textContent = progress.stars;
  $("#mathsStars").textContent = progress.stars;
  if(document.getElementById("clockStars")) $("#clockStars").textContent = progress.stars;
  $("#traceStars").textContent = progress.stars;
}

/* ---------- Home cards wiring ---------- */
$$("[data-nav]").forEach(a => {
  a.addEventListener("click", (e) => {
    e.preventDefault();
    const name = a.getAttribute("data-nav");
    navTo(name);
    // initialize screens for good UX
    if(name === "letters") lettersNewRound();
    if(name === "numbers") numbersNewRound();
    if(name === "memory") memoryNewGame();
    if(name === "phonics") phonicsInit();
    if(name === "maths") mathsInit();
    if(name === "clock") clockInit();
    if(name === "games") gamesInit();
    if(name === "handwriting") traceInit();
  });
});

$("#goHome").addEventListener("click", () => showScreen("home"));

/* ---------- Settings modal ---------- */
const backdrop = $("#settingsBackdrop");
$("#openSettings").addEventListener("click", () => backdrop.classList.add("show"));
$("#closeSettings").addEventListener("click", () => backdrop.classList.remove("show"));
backdrop.addEventListener("click", (e) => { if(e.target === backdrop) backdrop.classList.remove("show"); });
$("#saveSettings").addEventListener("click", () => { saveSettings(); backdrop.classList.remove("show"); });

/* ---------- Letters Game ---------- */
const ALPH = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
let lettersTarget = "A";

function lettersOptionCount(){
  if(settings.difficulty === "easy") return 2;
  if(settings.difficulty === "hard") return 5;
  return 3;
}

function lettersNewRound(){
  progress.played.letters += 1;
  store.set(PROG_KEY, progress);

  const idx = Math.floor(Math.random()*ALPH.length);
  lettersTarget = ALPH[idx];
  $("#lettersTarget").textContent = lettersTarget;
  $("#lettersFeedback").textContent = "";

  const opts = uniqueChoices(lettersTarget, ALPH, lettersOptionCount());
  const wrap = $("#lettersOptions");
  wrap.innerHTML = "";
  opts.forEach(ch => {
    const b = document.createElement("button");
    b.className = "optBtn";
    b.type = "button";
    b.textContent = ch;
    b.addEventListener("click", () => {
      if(ch === lettersTarget){
        $("#lettersFeedback").textContent = "‚úÖ Great job!";
        $("#lettersFeedback").className = "feedback good";
        addStar(1); markCorrect();
        speak(lettersTarget, 0.85);
      }else{
        $("#lettersFeedback").textContent = "‚ùå Try again";
        $("#lettersFeedback").className = "feedback bad";
        markWrong();
        speak("Try again", 0.9);
      }
    });
    wrap.appendChild(b);
  });
}

$("#lettersNext").addEventListener("click", lettersNewRound);
$("#lettersHear").addEventListener("click", () => speak(lettersTarget, 0.85));

/* ---------- Numbers Game ---------- */
let numbersTarget = 3;

function numbersMax(){
  if(settings.difficulty === "easy") return 5;
  if(settings.difficulty === "hard") return 20;
  return 10;
}

function numbersChoicesCount(){
  if(settings.difficulty === "easy") return 2;
  if(settings.difficulty === "hard") return 4;
  return 3;
}

function numbersNewRound(){
  progress.played.numbers += 1;
  store.set(PROG_KEY, progress);

  const max = numbersMax();
  numbersTarget = 1 + Math.floor(Math.random()*max);

  const obj = "‚≠ê";
  $("#numbersObjects").textContent = obj.repeat(numbersTarget).split("").join(" ");
  $("#numbersFeedback").textContent = "";

  const pool = Array.from({length:max}, (_,i)=>i+1);
  const opts = uniqueChoices(numbersTarget, pool, numbersChoicesCount());
  const wrap = $("#numbersOptions");
  wrap.innerHTML = "";
  opts.forEach(n => {
    const b = document.createElement("button");
    b.className = "optBtn mini";
    b.type = "button";
    b.textContent = n;
    b.addEventListener("click", () => {
      if(n === numbersTarget){
        $("#numbersFeedback").textContent = "‚úÖ Correct!";
        $("#numbersFeedback").className = "feedback good";
        addStar(1); markCorrect();
        speak(String(numbersTarget), 0.9);
      }else{
        $("#numbersFeedback").textContent = "‚ùå Try again";
        $("#numbersFeedback").className = "feedback bad";
        markWrong();
        speak("Try again", 0.9);
      }
    });
    wrap.appendChild(b);
  });
}

$("#numbersNext").addEventListener("click", numbersNewRound);
$("#numbersHear").addEventListener("click", () => speak("How many?", 0.9));

/* ---------- Memory Match ---------- */
const MEM_EMOJIS = ["üçé","üçå","üçá","üçì","‚≠ê","üåô","üöó","üê∂","üê±","‚öΩ","üéà","üß©","üéµ","üåà","ü¶ã","üß∏"];
let memoryFirst = null;
let memoryLock = false;
let memoryMatches = 0;
let memoryState = []; // {id, val, matched, shown}

function memorySize(){
  // total cards = pairs*2
  if(settings.difficulty === "easy") return 8;   // 4 pairs
  if(settings.difficulty === "hard") return 16;  // 8 pairs
  return 12;                                     // 6 pairs
}

function memoryNewGame(){
  progress.played.memory += 1;
  store.set(PROG_KEY, progress);

  memoryFirst = null;
  memoryLock = false;
  memoryMatches = 0;
  $("#memoryMatches").textContent = "0";
  $("#memoryFeedback").textContent = "";

  const total = memorySize();
  const pairs = total/2;
  const picks = shuffle(MEM_EMOJIS).slice(0, pairs);
  const deck = shuffle([...picks, ...picks]).map((val, idx) => ({
    id: idx,
    val,
    matched: false,
    shown: false
  }));
  memoryState = deck;

  const grid = $("#memoryGrid");
  grid.innerHTML = "";
  // adjust columns
  grid.style.gridTemplateColumns = total === 8 ? "repeat(4, minmax(0,1fr))" :
                                  total === 12 ? "repeat(4, minmax(0,1fr))" :
                                  "repeat(4, minmax(0,1fr))";

  deck.forEach(card => {
    const btn = document.createElement("button");
    btn.className = "memCard";
    btn.type = "button";
    btn.dataset.id = String(card.id);
    btn.textContent = "‚ùì";
    btn.addEventListener("click", () => memoryFlip(card.id));
    grid.appendChild(btn);
  });
}

function memoryRender(){
  memoryState.forEach(c => {
    const btn = document.querySelector(`.memCard[data-id="${c.id}"]`);
    if(!btn) return;
    if(c.matched || c.shown){
      btn.textContent = c.val;
      btn.style.borderColor = c.matched ? "rgba(34,197,94,0.6)" : "var(--line)";
      btn.style.opacity = c.matched ? "0.85" : "1";
    }else{
      btn.textContent = "‚ùì";
      btn.style.borderColor = "var(--line)";
      btn.style.opacity = "1";
    }
  });
  $("#memoryMatches").textContent = String(memoryMatches);
}

function memoryFlip(id){
  if(memoryLock) return;
  const c = memoryState.find(x => x.id === id);
  if(!c || c.matched || c.shown) return;

  c.shown = true;
  memoryRender();

  if(memoryFirst === null){
    memoryFirst = id;
    return;
  }

  const first = memoryState.find(x => x.id === memoryFirst);
  if(!first){ memoryFirst = null; return; }

  memoryLock = true;
  if(first.val === c.val){
    first.matched = true;
    c.matched = true;
    first.shown = false;
    c.shown = false;
    memoryFirst = null;
    memoryLock = false;
    memoryMatches += 1;
    $("#memoryFeedback").textContent = "‚úÖ Match!";
    $("#memoryFeedback").className = "feedback good";
    addStar(1); markCorrect();
    speak("Good job", 0.9);
    memoryRender();
  }else{
    $("#memoryFeedback").textContent = "‚ùå Not a match";
    $("#memoryFeedback").className = "feedback bad";
    markWrong();
    speak("Try again", 0.9);
    setTimeout(() => {
      first.shown = false;
      c.shown = false;
      memoryFirst = null;
      memoryLock = false;
      memoryRender();
    }, settings.reduceMotion ? 250 : 650);
  }
}

$("#memoryNew").addEventListener("click", memoryNewGame);

/* ---------- Phonics (Blend Builder) ---------- */
let phonicsBuild = [];
const PHONICS_SOUNDS = [
  "s","a","t","p","i","n",
  "m","d","g","o","c","k",
  "e","u","r","h","b","f",
  "l","j","w","v","y","z"
];

const EASY_WORDS = [["c","a","t"],["s","u","n"],["m","a","p"],["d","o","g"],["p","i","n"]];
const MED_WORDS  = [["c","a","t"],["s","u","n"],["m","a","p"],["d","o","g"],["r","u","n"],["h","a","t"],["b","u","s"],["f","o","x"]];
const HARD_WORDS = [["s","t","a","r"],["b","l","a","c","k"],["r","a","i","n"],["s","n","a","p"],["c","l","a","p"],["g","r","i","n"]]; // simple blends

function phonicsWordList(){
  if(settings.difficulty === "easy") return EASY_WORDS;
  if(settings.difficulty === "hard") return HARD_WORDS;
  return MED_WORDS;
}

function phonicsInit(){
  progress.played.phonics += 1;
  store.set(PROG_KEY, progress);

  phonicsBuild = [];
  $("#phonicsFeedback").textContent = "";
  renderPhonicsBuild();
  renderPhonicsSounds();
  $("#phonicsWord").textContent = "‚Äî";
}

function renderPhonicsSounds(){
  const wrap = $("#phonicsSounds");
  wrap.innerHTML = "";
  // show fewer sounds on easy
  let sounds = PHONICS_SOUNDS;
  if(settings.difficulty === "easy") sounds = PHONICS_SOUNDS.slice(0, 12);
  if(settings.difficulty === "hard") sounds = PHONICS_SOUNDS;

  sounds.forEach(s => {
    const b = document.createElement("button");
    b.className = "soundBtn";
    b.type = "button";
    b.textContent = s;
    b.addEventListener("click", () => {
      phonicsBuild.push(s);
      renderPhonicsBuild();
      speak(s, 0.85);
    });
    wrap.appendChild(b);
  });
}

function renderPhonicsBuild(){
  const box = $("#phonicsBuild");
  box.innerHTML = "";
  if(phonicsBuild.length === 0){
    const span = document.createElement("span");
    span.className = "hint";
    span.textContent = "Tap sounds to build a word‚Ä¶";
    box.appendChild(span);
    return;
  }
  phonicsBuild.forEach((s, idx) => {
    const t = document.createElement("span");
    t.className = "tile";
    t.textContent = s;
    t.title = "Click to remove";
    t.style.cursor = "pointer";
    t.addEventListener("click", () => {
      phonicsBuild.splice(idx,1);
      renderPhonicsBuild();
    });
    box.appendChild(t);
  });
}

$("#phonicsClear").addEventListener("click", () => {
  phonicsBuild = [];
  $("#phonicsFeedback").textContent = "";
  $("#phonicsWord").textContent = "‚Äî";
  renderPhonicsBuild();
});

$("#phonicsBlend").addEventListener("click", () => {
  if(phonicsBuild.length === 0){
    $("#phonicsFeedback").textContent = "Tap some sounds first.";
    $("#phonicsFeedback").className = "feedback warn";
    speak("Tap some sounds first", 0.9);
    return;
  }
  const word = phonicsBuild.join("");
  $("#phonicsWord").textContent = word.toUpperCase();
  speak(word, 0.85);

  // simple validation: if built word matches list for current difficulty, reward
  const valid = phonicsWordList().some(arr => arr.join("") === word);
  if(valid){
    $("#phonicsFeedback").textContent = "‚úÖ Nice blending!";
    $("#phonicsFeedback").className = "feedback good";
    addStar(1); markCorrect();
  }else{
    $("#phonicsFeedback").textContent = "Good try ‚Äî build one of the simple words above.";
    $("#phonicsFeedback").className = "feedback warn";
  }
});

/* ---------- Maths ---------- */
let mathMode = "add";
let mathAnswer = null;
let mathQuestionText = "";
let timeState = { hour: 3, minute: 0 };

function mathsInit(){
  progress.played.maths += 1;
  store.set(PROG_KEY, progress);
  setMathMode(mathMode);
  nextMath();
}

function setMathMode(mode){
  mathMode = mode;
  $("#mathModeLabel").textContent = mode === "add" ? "Add" :
                                   mode === "sub" ? "Subtract" :
                                   mode === "div" ? "Divide" : (mode === "mul" ? "Multiply" : "Mixed");
  $$("#mathTabs .tab").forEach(t => t.classList.toggle("active", t.dataset.mode === mode));
  $("#mathsFeedback").textContent = "";
  buildMathUI();
  nextMath();
}

function mathRange(){
  if(settings.difficulty === "easy") return {max:10, divMax:5, timeStep: 60};      // o'clock only
  if(settings.difficulty === "hard") return {max:50, divMax:10, timeStep: 5};      // 5-min
  return {max:20, divMax:10, timeStep: 15};                                        // quarters
}

function buildMathUI(){
  const area = $("#mathModeArea");
  area.innerHTML = "";

  const q = document.createElement("div");
  q.className = "questionBig";
  q.innerHTML = `<div class="qText" id="mathQuestion">‚Äî</div>`;

  const opts = document.createElement("div");
  opts.className = "options";
  opts.id = "mathOptions";

  area.appendChild(q);
  area.appendChild(opts);

  // attach tab listeners (once)
  $$("#mathTabs .tab").forEach(btn => {
    btn.onclick = () => setMathMode(btn.dataset.mode);
  });
}

function drawClockTo(canvasId, hour, minute){
  const c = document.getElementById(canvasId);
  if(!c) return;
  const ctx = c.getContext("2d");
  const w = c.width, h = c.height;
  const cx = w/2, cy = h/2;
  const r = Math.min(cx,cy) - 10;

  ctx.clearRect(0,0,w,h);

  // face
  ctx.beginPath();
  ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.fillStyle = "#fff";
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#e2e8f0";
  ctx.stroke();

  // ticks
  for(let i=0;i<60;i++){
    const ang = (Math.PI*2)*(i/60) - Math.PI/2;
    const inner = r - (i%5===0 ? 16 : 9);
    const outer = r - 2;
    ctx.beginPath();
    ctx.moveTo(cx + inner*Math.cos(ang), cy + inner*Math.sin(ang));
    ctx.lineTo(cx + outer*Math.cos(ang), cy + outer*Math.sin(ang));
    ctx.strokeStyle = (i%5===0) ? "#94a3b8" : "#cbd5e1";
    ctx.lineWidth = (i%5===0) ? 3 : 2;
    ctx.stroke();
  }

  // numbers 12,3,6,9
  ctx.fillStyle = "#0f172a";
  ctx.font = "900 18px Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  const positions = [["12",0],["3",90],["6",180],["9",270]];
  positions.forEach(([txt,deg])=>{
    const ang = (Math.PI/180)*deg - Math.PI/2;
    const rr = r - 36;
    ctx.fillText(txt, cx + rr*Math.cos(ang), cy + rr*Math.sin(ang));
  });

  // hands
  const minAng = (Math.PI*2)*(minute/60) - Math.PI/2;
  const hourVal = (hour%12) + minute/60;
  const hourAng = (Math.PI*2)*(hourVal/12) - Math.PI/2;

  // hour
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(cx + (r*0.52)*Math.cos(hourAng), cy + (r*0.52)*Math.sin(hourAng));
  ctx.strokeStyle = "#0f172a";
  ctx.lineWidth = 7;
  ctx.lineCap = "round";
  ctx.stroke();

  // minute
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(cx + (r*0.74)*Math.cos(minAng), cy + (r*0.74)*Math.sin(minAng));
  ctx.strokeStyle = "#2f80ed";
  ctx.lineWidth = 5;
  ctx.lineCap = "round";
  ctx.stroke();

  // center dot
  ctx.beginPath();
  ctx.arc(cx,cy,6,0,Math.PI*2);
  ctx.fillStyle = "#0f172a";
  ctx.fill();
}

function formatTime(h, m){
  const hh = ((h%12)===0 ? 12 : (h%12));
  const mm = String(m).padStart(2,"0");
  return `${hh}:${mm}`;
}

function nextMath(){
  $("#mathsFeedback").textContent = "";
  const range = mathRange();

  if(mathMode === "mix"){
    const modes = ["add","sub","mul","div"];
    mathMode = modes[Math.floor(Math.random()*modes.length)];
    $("#mathModeLabel").textContent = "Mixed";
  }

  const max = range.max;
  let a = 1 + Math.floor(Math.random()*max);
  let b = 1 + Math.floor(Math.random()*max);

  if(mathMode === "add"){
    mathAnswer = a + b;
    mathQuestionText = `${a} + ${b} = ?`;
  }else if(mathMode === "sub"){
    // ensure non-negative for easy/medium
    if(settings.difficulty !== "hard" && b > a){ [a,b] = [b,a]; }
    mathAnswer = a - b;
    mathQuestionText = `${a} ‚àí ${b} = ?`;
  }else if(mathMode === "mul"){
    mathAnswer = a * b;
    mathQuestionText = `${a} √ó ${b} = ?`;
  }else if(mathMode === "div"){
    // create clean division: (d * q) √∑ d = q
    const dMax = range.divMax;
    const d = 2 + Math.floor(Math.random()*(dMax-1));
    const q = 1 + Math.floor(Math.random()*dMax);
    const n = d*q;
    mathAnswer = q;
    mathQuestionText = `${n} √∑ ${d} = ?`;
  }

  $("#mathQuestion").textContent = mathQuestionText;

  // option count
  const optCount = settings.difficulty === "easy" ? 2 : (settings.difficulty === "hard" ? 4 : 3);
  const pool = [];
  for(let i=Math.max(0, mathAnswer-10); i<=mathAnswer+10; i++) pool.push(i);
  const opts = uniqueChoices(mathAnswer, pool, optCount).map(x => Math.max(0, x));

  const wrap = $("#mathOptions");
  wrap.innerHTML = "";
  opts.forEach(n => {
    const b = document.createElement("button");
    b.className = "optBtn mini";
    b.type = "button";
    b.textContent = n;
    b.addEventListener("click", () => {
      if(n === mathAnswer){
        $("#mathsFeedback").textContent = "‚úÖ Correct!";
        $("#mathsFeedback").className = "feedback good";
        addStar(1); markCorrect();
        speak("Correct", 0.9);
      }else{
        $("#mathsFeedback").textContent = "‚ùå Try again";
        $("#mathsFeedback").className = "feedback bad";
        markWrong();
        speak("Try again", 0.9);
      }
    });
    wrap.appendChild(b);
  });
}

$("#mathsNext").addEventListener("click", nextMath);
$("#mathsHear").addEventListener("click", () => speak(mathQuestionText || "Maths", 0.9));

/* ---------- Clock (Analogue Time) ---------- */
let clockLevel = "oclock";
let clockAnswer = null;
let clockText = "What time is it?";

function clockInit(){
  $("#clockStars").textContent = progress.stars;
  $("#clockFeedback").textContent = "";
  setClockLevel(bestClockLevelForDifficulty());
  clockNext();
}

function bestClockLevelForDifficulty(){
  if(settings.difficulty === "easy") return "oclock";
  if(settings.difficulty === "hard") return "five";
  return "quarter";
}

function levelToLabel(lvl){
  return lvl === "oclock" ? "O‚Äôclock" :
         lvl === "half" ? "Half past" :
         lvl === "quarter" ? "Quarter past/to" : "5‚Äëminute";
}

function allowedMinutesForLevel(lvl){
  if(lvl === "oclock") return [0];
  if(lvl === "half") return [0,30];
  if(lvl === "quarter") return [0,15,30,45];
  // five
  const mins = [];
  for(let m=0;m<60;m+=5) mins.push(m);
  return mins;
}

function formatTime(h, m){
  const hh = ((h%12)===0 ? 12 : (h%12));
  const mm = String(m).padStart(2,"0");
  return `${hh}:${mm}`;
}

function clockNext(){
  progress.played.maths += 1; // keep time practice counted under maths bucket for now
  store.set(PROG_KEY, progress);

  $("#clockStars").textContent = progress.stars;
  $("#clockFeedback").textContent = "";

  const minutes = allowedMinutesForLevel(clockLevel);
  const minute = minutes[Math.floor(Math.random()*minutes.length)];
  const hour = 1 + Math.floor(Math.random()*12);

  drawClockTo("clockCanvas2", hour, minute);
  const correct = formatTime(hour, minute);
  clockAnswer = correct;
  clockText = "What time is it?";

  $("#clockLevelLabel").textContent = levelToLabel(clockLevel);
  $("#clockQuestion").textContent = "What time is it?";
  $("#clockHint").textContent = `Choose the correct time (${levelToLabel(clockLevel)}).`;

  const opts = new Set([correct]);
  while(opts.size < 3){
    const h2 = 1 + Math.floor(Math.random()*12);
    const m2 = minutes[Math.floor(Math.random()*minutes.length)];
    opts.add(formatTime(h2, m2));
  }
  const arr = shuffle(Array.from(opts));
  const wrap = $("#clockOptions");
  wrap.innerHTML = "";
  arr.forEach(t => {
    const b = document.createElement("button");
    b.className = "optBtn mini";
    b.type = "button";
    b.textContent = t;
    b.addEventListener("click", () => {
      if(t === clockAnswer){
        $("#clockFeedback").textContent = "‚úÖ Correct time!";
        $("#clockFeedback").className = "feedback good";
        addStar(1); markCorrect();
        speak("Correct", 0.9);
      } else {
        $("#clockFeedback").textContent = "‚ùå Try again";
        $("#clockFeedback").className = "feedback bad";
        markWrong();
        speak("Try again", 0.9);
      }
    });
    wrap.appendChild(b);
  });
}

function setClockLevel(level){
  clockLevel = level;
  $$("#clockTabs .tab").forEach(t => t.classList.toggle("active", t.dataset.level === level));
  $("#clockLevelLabel").textContent = levelToLabel(level);
}

$("#clockNext").addEventListener("click", clockNext);
$("#clockHear").addEventListener("click", () => speak(clockText, 0.9));
$$("#clockTabs .tab").forEach(btn => {
  btn.addEventListener("click", () => {
    setClockLevel(btn.dataset.level);
    clockNext();
  });
});

/* ---------- Handwriting (Tracing) ---------- */
const traceCanvas = $("#traceCanvas");
const tctx = traceCanvas.getContext("2d", { willReadFrequently: false });

let traceTarget = "A";
const TRACE_TARGETS = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","cat","sun","map","dog","hat","run"];

let penSize = 6;
let toolMode = "pen"; // pen | eraser
let isPointerDown = false;
let lastPoint = null;
let undoStack = []; // ImageData snapshots

function setPenSize(size){
  penSize = size;
  $$("#penSizeSeg button").forEach(b => b.classList.toggle("active", Number(b.dataset.size) === size));
}
function setToolMode(mode){
  toolMode = mode;
  $$("#toolSeg button").forEach(b => b.classList.toggle("active", b.dataset.tool === mode));
}

function pushUndo(){
  try{
    const img = tctx.getImageData(0,0,traceCanvas.width, traceCanvas.height);
    undoStack.push(img);
    if(undoStack.length > 15) undoStack.shift();
  }catch{}
}
function undo(){
  const img = undoStack.pop();
  if(!img) return;
  tctx.putImageData(img, 0, 0);
}

function resizeTraceForDevice(){
  const rect = traceCanvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  traceCanvas.width = Math.floor(rect.width * dpr);
  traceCanvas.height = Math.floor(rect.height * dpr);
  tctx.setTransform(dpr,0,0,dpr,0,0);
  drawTraceGuide();
}

function guideSvgForTarget(target){
  const upper = target.toUpperCase();
  const isWord = upper.length > 1;
  const fontSize = isWord ? 120 : 190;

  const baseline = `
    <line x1="60" y1="235" x2="840" y2="235"
      stroke="#cbd5e1" stroke-width="5" stroke-dasharray="12 10" stroke-linecap="round" opacity="0.65" />
  `;

  const textOutline = `
    <text x="450" y="175" text-anchor="middle"
      font-family="Arial Rounded MT Bold, Arial, Helvetica, sans-serif"
      font-size="${fontSize}" font-weight="900"
      fill="none" stroke="#0f172a" stroke-width="14"
      stroke-linecap="round" stroke-linejoin="round"
      stroke-dasharray="12 12" opacity="0.85">${upper}</text>
    <text x="450" y="175" text-anchor="middle"
      font-family="Arial Rounded MT Bold, Arial, Helvetica, sans-serif"
      font-size="${fontSize}" font-weight="900"
      fill="none" stroke="#2f80ed" stroke-width="8"
      stroke-linecap="round" stroke-linejoin="round"
      stroke-dasharray="12 12" opacity="0.28">${upper}</text>
  `;

  const startDot = isWord
    ? `<circle cx="260" cy="175" r="10" fill="#22c55e" opacity="0.55" />`
    : `<circle cx="320" cy="210" r="10" fill="#22c55e" opacity="0.55" />`;

  return `
    <defs>
      <filter id="softGlow" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur stdDeviation="6" result="blur"/>
        <feColorMatrix in="blur" type="matrix"
          values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.35 0" result="glow"/>
        <feMerge>
          <feMergeNode in="glow"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>
    <g filter="url(#softGlow)">
      ${baseline}
      ${textOutline}
      ${startDot}
    </g>
  `;
}

function drawTraceGuide(){
  tctx.clearRect(0,0,traceCanvas.width, traceCanvas.height);

  const svg = document.getElementById("traceGuideSvg");
  if(svg) svg.innerHTML = guideSvgForTarget(traceTarget);

  $("#traceTarget").textContent = traceTarget;
  $("#traceFeedback").textContent = "";
  $("#traceFeedback").className = "feedback";
  undoStack = [];
  pushUndo();
}

function traceInit(){
  progress.played.trace += 1;
  store.set(PROG_KEY, progress);

  traceTarget = TRACE_TARGETS[Math.floor(Math.random()*TRACE_TARGETS.length)];
  setTimeout(resizeTraceForDevice, 70);
}

function getPointFromEvent(e){
  const rect = traceCanvas.getBoundingClientRect();
  return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
}

function beginStroke(e){
  if(e.pointerType === "mouse" && e.button !== 0) return;
  isPointerDown = true;
  lastPoint = getPointFromEvent(e);
  traceCanvas.setPointerCapture?.(e.pointerId);
  pushUndo();
  e.preventDefault();
}
function drawStroke(e){
  if(!isPointerDown) return;
  const p = getPointFromEvent(e);

  tctx.save();
  tctx.lineCap = "round";
  tctx.lineJoin = "round";

  if(toolMode === "eraser"){
    tctx.globalCompositeOperation = "destination-out";
    tctx.strokeStyle = "rgba(0,0,0,1)";
    tctx.lineWidth = penSize * 2.2;
  } else {
    tctx.globalCompositeOperation = "source-over";
    tctx.strokeStyle = "#2f80ed";
    tctx.shadowColor = "rgba(47,128,237,0.35)";
    tctx.shadowBlur = 10;
    tctx.lineWidth = penSize;
  }

  tctx.beginPath();
  tctx.moveTo(lastPoint.x, lastPoint.y);
  tctx.lineTo(p.x, p.y);
  tctx.stroke();
  tctx.restore();

  lastPoint = p;
  e.preventDefault();
}
function endStroke(e){
  if(!isPointerDown) return;
  isPointerDown = false;
  lastPoint = null;
  try{ traceCanvas.releasePointerCapture?.(e.pointerId); }catch{}
  e.preventDefault();
}

traceCanvas.addEventListener("pointerdown", beginStroke);
traceCanvas.addEventListener("pointermove", drawStroke);
traceCanvas.addEventListener("pointerup", endStroke);
traceCanvas.addEventListener("pointercancel", endStroke);
traceCanvas.addEventListener("contextmenu", (e) => e.preventDefault());

$("#traceUndo").addEventListener("click", undo);
$("#traceClear").addEventListener("click", drawTraceGuide);
$("#traceNext").addEventListener("click", () => {
  traceTarget = TRACE_TARGETS[Math.floor(Math.random()*TRACE_TARGETS.length)];
  drawTraceGuide();
});
$("#traceHear").addEventListener("click", () => speak(traceTarget, 0.85));
$("#traceDone").addEventListener("click", () => {
  $("#traceFeedback").textContent = "‚úÖ Well done!";
  $("#traceFeedback").className = "feedback good";
  addStar(1); markCorrect();
  speak("Well done", 0.9);
});

$$("#penSizeSeg button").forEach(b => b.addEventListener("click", () => setPenSize(Number(b.dataset.size))));
$$("#toolSeg button").forEach(b => b.addEventListener("click", () => setToolMode(b.dataset.tool)));

setPenSize(6);
setToolMode("pen");

/* ---------- Progress reset ---------- */
$("#resetProgress").addEventListener("click", () => {
  if(!confirm("Reset all progress on this device?")) return;
  progress = {
    stars: 0,
    sessions: 0,
    correct: 0,
    wrong: 0,
    played: { letters:0, numbers:0, memory:0, phonics:0, maths:0, trace:0 }
  };
  store.set(PROG_KEY, progress);
  updateTopStars();
  updateProgressUI();
  speak("Progress reset", 0.95);
});

/* ---------- Session Mode (gentle) ---------- */
function runSession(){
  // optional guided session: letters -> numbers -> phonics -> maths -> memory
  // We'll keep it simple: auto advance only when user presses Next in each section.
  // If enabled, we show a small hint.
  // (This avoids timers, which can stress some kids.)
  // You can expand this later.
}

/* ---------- Games ---------- */
let currentGame = "connect4";

/* Money (UK) */
let moneyMode = "easy"; // easy | medium | hard
let moneyTarget = 0;    // pence
let moneyTotal = 0;     // pence
let moneyStack = [];    // list of pence added (for undo)

const UK_MONEY = [
  {p:1,   label:"1p",   cls:"coin-1p",  type:"coin", size:"small"},
  {p:2,   label:"2p",   cls:"coin-2p",  type:"coin", size:"small"},
  {p:5,   label:"5p",   cls:"coin-5p",  type:"coin", size:"small"},
  {p:10,  label:"10p",  cls:"coin-10p", type:"coin"},
  {p:20,  label:"20p",  cls:"coin-20p", type:"coin"},
  {p:50,  label:"50p",  cls:"coin-50p", type:"coin"},
  {p:100, label:"¬£1",   cls:"coin-100p",type:"coin"},
  {p:200, label:"¬£2",   cls:"coin-200p",type:"coin"},
  {p:500, label:"¬£5",   cls:"note-500", type:"note"},
  {p:1000,label:"¬£10",  cls:"note-1000",type:"note"},
];

function moneyAllowed(){
  if(moneyMode === "easy"){
    // keep it simple + recognisable
    return UK_MONEY.filter(x => [1,2,5,10,20,50,100].includes(x.p));
  }
  if(moneyMode === "medium"){
    return UK_MONEY.filter(x => [1,2,5,10,20,50,100,200].includes(x.p));
  }
  // hard includes notes
  return UK_MONEY.filter(x => [1,2,5,10,20,50,100,200,500,1000].includes(x.p));
}

function formatGBP(pence){
  const pounds = Math.floor(pence / 100);
  const pennies = pence % 100;
  return `¬£${pounds}.${String(pennies).padStart(2,"0")}`;
}

function moneyNewTarget(){
  moneyTotal = 0;
  moneyStack = [];
  // Target ranges by mode
  if(moneyMode === "easy"){
    // 5p to ¬£1.00 in 5p steps (with a few penny targets too)
    const opts = [];
    for(let p=5; p<=100; p+=5) opts.push(p);
    opts.push(1,2,3,4,6,7,8,9,11,12); // sprinkle small pennies
    moneyTarget = opts[Math.floor(Math.random()*opts.length)];
  } else if(moneyMode === "medium"){
    // 20p to ¬£5.00 in 5p steps
    const opts = [];
    for(let p=20; p<=500; p+=5) opts.push(p);
    moneyTarget = opts[Math.floor(Math.random()*opts.length)];
  } else {
    // ¬£1.00 to ¬£20.00 in 10p steps
    const opts = [];
    for(let p=100; p<=2000; p+=10) opts.push(p);
    moneyTarget = opts[Math.floor(Math.random()*opts.length)];
  }
}

function moneyAdd(pence){
  moneyStack.push(pence);
  moneyTotal += pence;
}

function moneyUndo(){
  const last = moneyStack.pop();
  if(last == null) return;
  moneyTotal -= last;
  if(moneyTotal < 0) moneyTotal = 0;
}

function moneyClear(){
  moneyStack = [];
  moneyTotal = 0;
}

function moneyCheck(){
  if(moneyTotal === moneyTarget){
    // reward 1 star for learning game
    addStar(1); markCorrect();
    speak("Well done", 0.9);
    return {ok:true};
  }
  if(moneyTotal > moneyTarget){
    markWrong();
    speak("Too much", 0.95);
    return {over:true};
  }
  markWrong();
  speak("Add a bit more", 0.95);
  return {under:true};
}


function showClink(container, text){
  if(settings.reduceMotion) return;
  const r = container.getBoundingClientRect();
  const el = document.createElement("div");
  el.className = "clink";
  el.textContent = text || "Clink!";
  el.style.left = (r.left + r.width*0.5 + window.scrollX) + "px";
  el.style.top  = (r.top + r.height*0.35 + window.scrollY) + "px";
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 560);
}


/* Connect 4 */
const C4_COLS = 7, C4_ROWS = 6;
let c4Board = []; // [row][col] = 0 empty, 1 red, 2 yellow
let c4Turn = 1;
let c4Over = false;

function c4Reset(){
  c4Board = Array.from({length:C4_ROWS}, () => Array(C4_COLS).fill(0));
  c4Turn = 1;
  c4Over = false;
}

function c4Drop(col){
  if(c4Over) return;
  for(let r=C4_ROWS-1; r>=0; r--){
    if(c4Board[r][col] === 0){
      c4Board[r][col] = c4Turn;
      if(c4CheckWin(r,col,c4Turn)){
        c4Over = true;
        return {win:c4Turn};
      }
      if(c4Board.every(row => row.every(v => v!==0))){
        c4Over = true;
        return {draw:true};
      }
      c4Turn = (c4Turn===1)?2:1;
      return {ok:true};
    }
  }
  return {full:true};
}

function c4CheckWin(r,c,player){
  const dirs = [[0,1],[1,0],[1,1],[1,-1]];
  for(const [dr,dc] of dirs){
    let count = 1;
    count += c4CountDir(r,c,dr,dc,player);
    count += c4CountDir(r,c,-dr,-dc,player);
    if(count >= 4) return true;
  }
  return false;
}
function c4CountDir(r,c,dr,dc,player){
  let cnt = 0;
  let rr = r+dr, cc = c+dc;
  while(rr>=0 && rr<C4_ROWS && cc>=0 && cc<C4_COLS && c4Board[rr][cc]===player){
    cnt++; rr+=dr; cc+=dc;
  }
  return cnt;
}

/* Mini Tetris (simple) */
let tetris = {
  cols: 10, rows: 18, cell: 18,
  grid: [],
  piece: null,
  x: 3, y: 0,
  dropMs: 650,
  last: 0,
  running: false,
  score: 0
};

const TETRIS_SHAPES = [
  [[1,1,1,1]],                 // I
  [[1,1],[1,1]],               // O
  [[0,1,0],[1,1,1]],           // T
  [[1,0,0],[1,1,1]],           // J
  [[0,0,1],[1,1,1]],           // L
  [[0,1,1],[1,1,0]],           // S
  [[1,1,0],[0,1,1]],           // Z
];

function tetrisReset(){
  tetris.grid = Array.from({length:tetris.rows}, ()=>Array(tetris.cols).fill(0));
  tetris.score = 0;
  tetris.running = false;
  tetrisSpawn();
}

function tetrisSpawn(){
  tetris.piece = shuffle(TETRIS_SHAPES)[0].map(row=>row.slice());
  tetris.x = Math.floor((tetris.cols - tetris.piece[0].length)/2);
  tetris.y = 0;
  if(tetrisCollides(tetris.x,tetris.y,tetris.piece)){
    tetris.running = false;
  }
}

function tetrisRotate(mat){
  const h = mat.length, w = mat[0].length;
  const out = Array.from({length:w}, ()=>Array(h).fill(0));
  for(let r=0;r<h;r++){
    for(let c=0;c<w;c++){
      out[c][h-1-r] = mat[r][c];
    }
  }
  return out;
}

function tetrisCollides(nx, ny, piece){
  for(let r=0;r<piece.length;r++){
    for(let c=0;c<piece[0].length;c++){
      if(!piece[r][c]) continue;
      const x = nx + c, y = ny + r;
      if(x<0 || x>=tetris.cols || y>=tetris.rows) return true;
      if(y>=0 && tetris.grid[y][x]) return true;
    }
  }
  return false;
}

function tetrisMerge(){
  for(let r=0;r<tetris.piece.length;r++){
    for(let c=0;c<tetris.piece[0].length;c++){
      if(tetris.piece[r][c]){
        const y = tetris.y + r;
        const x = tetris.x + c;
        if(y>=0 && y<tetris.rows && x>=0 && x<tetris.cols){
          tetris.grid[y][x] = 1;
        }
      }
    }
  }
}

function tetrisClearLines(){
  let cleared = 0;
  for(let r=tetris.rows-1; r>=0; r--){
    if(tetris.grid[r].every(v=>v===1)){
      tetris.grid.splice(r,1);
      tetris.grid.unshift(Array(tetris.cols).fill(0));
      cleared++;
      r++;
    }
  }
  if(cleared){
    tetris.score += cleared * 10;
  }
}

function tetrisStep(){
  if(!tetris.running) return;
  if(!tetrisCollides(tetris.x, tetris.y+1, tetris.piece)){
    tetris.y += 1;
  }else{
    tetrisMerge();
    tetrisClearLines();
    tetrisSpawn();
  }
}

function tetrisDraw(){
  const c = document.getElementById("tetrisCanvas");
  if(!c) return;
  const ctx = c.getContext("2d");
  const w = c.width, h = c.height;
  ctx.clearRect(0,0,w,h);

  const cs = tetris.cell;
  // background grid subtle
  ctx.save();
  ctx.globalAlpha = 0.12;
  ctx.strokeStyle = "#94a3b8";
  for(let x=0; x<=tetris.cols; x++){
    ctx.beginPath(); ctx.moveTo(x*cs,0); ctx.lineTo(x*cs,tetris.rows*cs); ctx.stroke();
  }
  for(let y=0; y<=tetris.rows; y++){
    ctx.beginPath(); ctx.moveTo(0,y*cs); ctx.lineTo(tetris.cols*cs,y*cs); ctx.stroke();
  }
  ctx.restore();

  // settled blocks
  for(let r=0;r<tetris.rows;r++){
    for(let c2=0;c2<tetris.cols;c2++){
      if(tetris.grid[r][c2]) drawBlock(ctx, c2, r);
    }
  }
  // active piece
  if(tetris.piece){
    for(let r=0;r<tetris.piece.length;r++){
      for(let c2=0;c2<tetris.piece[0].length;c2++){
        if(tetris.piece[r][c2]) drawBlock(ctx, tetris.x+c2, tetris.y+r);
      }
    }
  }
}

function drawBlock(ctx, x, y){
  const cs = tetris.cell;
  const px = x*cs, py = y*cs;
  ctx.save();
  // 3D block look
  const grad = ctx.createLinearGradient(px, py, px+cs, py+cs);
  grad.addColorStop(0, "rgba(255,255,255,0.55)");
  grad.addColorStop(0.35, "rgba(47,128,237,0.95)");
  grad.addColorStop(1, "rgba(15,23,42,0.95)");
  ctx.fillStyle = grad;
  ctx.fillRect(px+1, py+1, cs-2, cs-2);
  ctx.strokeStyle = "rgba(255,255,255,0.18)";
  ctx.strokeRect(px+1, py+1, cs-2, cs-2);
  ctx.restore();
}

function tetrisLoop(ts){
  if(!tetris.running) return;
  if(ts - tetris.last > tetris.dropMs){
    tetris.last = ts;
    tetrisStep();
    updateTetrisUI();
  }
  tetrisDraw();
  requestAnimationFrame(tetrisLoop);
}

function tetrisStart(){
  if(tetris.running) return;
  tetris.running = true;
  tetris.last = performance.now();
  requestAnimationFrame(tetrisLoop);
}
function tetrisPause(){
  tetris.running = false;
}

function updateTetrisUI(){
  const el = document.getElementById("tetrisScore");
  if(el) el.textContent = String(tetris.score);
}

/* Render Games UI */
function renderGames(){
  const area = document.getElementById("gameArea");
  if(!area) return;

  if(currentGame === "connect4"){
    area.innerHTML = `
      <div class="gameShell">
        <div class="gameHeaderBar">
          <div class="pill">Turn: <strong>${c4Turn===1 ? "Red" : "Yellow"}</strong></div>
          <div class="row">
            <button class="btn ghost" id="c4Reset">New Game</button>
          </div>
        </div>

        <div class="gameBoard">
          <div class="c4Grid" id="c4Grid"></div>
        </div>
        <div id="c4Msg" class="feedback" aria-live="polite"></div>
      </div>
    `;

    const grid = document.getElementById("c4Grid");
    for(let r=0;r<C4_ROWS;r++){
      for(let c=0;c<C4_COLS;c++){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "c4Cell";
        const v = c4Board[r][c];
        if(v===1) btn.classList.add("red");
        if(v===2) btn.classList.add("yellow");
        btn.addEventListener("click", () => {
          const res = c4Drop(c);
          renderGames();
          const msg = document.getElementById("c4Msg");
          if(res?.win){
            msg.textContent = res.win===1 ? "‚úÖ Red wins!" : "‚úÖ Yellow wins!";
            msg.className = "feedback good";
            speak("Well done", 0.9);
          }else if(res?.draw){
            msg.textContent = "ü§ù Draw";
            msg.className = "feedback warn";
          }else if(res?.full){
            msg.textContent = "That column is full.";
            msg.className = "feedback warn";
          }
        });
        grid.appendChild(btn);
      }
    }

    document.getElementById("c4Reset").addEventListener("click", () => {
      c4Reset(); renderGames();
      const msg = document.getElementById("c4Msg");
      msg.textContent = "";
      msg.className = "feedback";
    });

    if(c4Over){
      const msg = document.getElementById("c4Msg");
      if(!msg.textContent){
        msg.textContent = "Game over.";
        msg.className = "feedback warn";
      }
    }

  } else if(currentGame === "tetris") {
    area.innerHTML = `
      <div class="gameShell">
        <div class="gameHeaderBar">
          <div class="pill">Score: <strong id="tetrisScore">${tetris.score}</strong></div>
          <div class="row">
            <button class="btn ghost" id="tStart">Start</button>
            <button class="btn ghost" id="tPause">Pause</button>
            <button class="btn ghost" id="tReset">Reset</button>
          </div>
        </div>

        <div class="tetrisWrap">
          <canvas id="tetrisCanvas" width="${tetris.cols*tetris.cell}" height="${tetris.rows*tetris.cell}"></canvas>

          <div class="tetrisControls" aria-label="Tetris controls">
            <button class="tBtn" id="tLeft">‚¨ÖÔ∏è</button>
            <button class="tBtn" id="tRotate">üîÑ</button>
            <button class="tBtn" id="tRight">‚û°Ô∏è</button>
            <button class="tBtn" id="tDown">‚¨áÔ∏è</button>
            <button class="tBtn" id="tDrop">‚è¨</button>
            <button class="tBtn" id="tNew">‚ú® New Piece</button>
          </div>
        </div>
        <div class="hint">Controls: use the buttons (touch-friendly). No fast flashing. You can pause anytime.</div>
      </div>
    `;

    // wire controls
    const move = (dx,dy)=>{
      if(!tetris.running) return;
      if(!tetrisCollides(tetris.x+dx, tetris.y+dy, tetris.piece)){
        tetris.x += dx; tetris.y += dy;
      }
      tetrisDraw();
    };
    document.getElementById("tStart").onclick = ()=>tetrisStart();
    document.getElementById("tPause").onclick = ()=>tetrisPause();
    document.getElementById("tReset").onclick = ()=>{ tetrisReset(); updateTetrisUI(); tetrisDraw(); };
    document.getElementById("tLeft").onclick = ()=>move(-1,0);
    document.getElementById("tRight").onclick = ()=>move(1,0);
    document.getElementById("tDown").onclick = ()=>{ tetrisStep(); updateTetrisUI(); tetrisDraw(); };

    document.getElementById("tDrop").onclick = ()=>{
      if(!tetris.running) return;
      while(!tetrisCollides(tetris.x, tetris.y+1, tetris.piece)){
        tetris.y += 1;
      }
      tetrisStep(); updateTetrisUI(); tetrisDraw();
    };

    document.getElementById("tRotate").onclick = ()=>{
      if(!tetris.running) return;
      const rot = tetrisRotate(tetris.piece);
      if(!tetrisCollides(tetris.x, tetris.y, rot)) tetris.piece = rot;
      tetrisDraw();
    };
    document.getElementById("tNew").onclick = ()=>{
      if(!tetris.running) return;
      tetrisSpawn(); tetrisDraw();
    };

    // touch: prevent scroll on canvas
    const c = document.getElementById("tetrisCanvas");
    c.addEventListener("touchmove", (e)=>e.preventDefault(), {passive:false});
    tetrisDraw();
  }

  } else {
    // Money game (UK)
    area.innerHTML = `
      <div class="moneyWrap">
        <div class="moneyTop">
          <div class="moneyTarget">
            <div>
              <div class="label">Make this amount</div>
              <div class="value" id="moneyTargetText">${formatGBP(moneyTarget)}</div>
              <div class="sub">Tap coins/notes to add them to the piggy bank.</div>
            </div>
            <div class="seg" id="moneyModeSeg" aria-label="Money difficulty">
              <button type="button" data-mode="easy">Easy</button>
              <button type="button" data-mode="medium">Medium</button>
              <button type="button" data-mode="hard">Hard</button>
            </div>
          </div>
        </div>

        <div class="moneyStage">
          <div class="pigBank">
            <div class="pigRow">
              <div class="pill">Goal: <strong>${formatGBP(moneyTarget)}</strong></div>
              <div class="totalPill">Total: <span id="moneyTotalText" style="margin-left:6px;">${formatGBP(moneyTotal)}</span></div>
            </div>

            <div class="coinDropArea" id="moneyDropArea" aria-label="Coins in piggy bank"></div>

            <div class="moneyActions">
              <button class="btn ghost" id="moneyUndoBtn">Undo</button>
              <button class="btn ghost" id="moneyClearBtn">Clear</button>
              <button class="btn" id="moneyCheckBtn">Check</button>
              <button class="btn secondary" id="moneyNewBtn">New</button>
            </div>

            <div id="moneyMsg" class="moneyMsg"></div>

            <div class="hint" style="margin-top:10px;">
              Tip: Try different combinations to reach the exact amount.
            </div>
          </div>

          <div class="coinPalette">
            <div class="row" style="justify-content:space-between;">
              <strong>Coins & notes</strong>
              <span class="hint" style="margin:0;">(UK ¬£)</span>
            </div>
            <div class="paletteGrid" id="moneyPalette"></div>
          </div>
        </div>
      </div>
    `;

    // mode buttons state
    const modeSeg = document.getElementById("moneyModeSeg");
    if(modeSeg){
      modeSeg.querySelectorAll("button").forEach(b=>{
        b.classList.toggle("active", b.dataset.mode===moneyMode);
        b.onclick = ()=>{
          moneyMode = b.dataset.mode;
          moneyNewTarget();
          moneyClear();
          renderGames();
        };
      });
    }

    // render palette
    const pal = document.getElementById("moneyPalette");
    const drop = document.getElementById("moneyDropArea");
    // Drag & Drop support
    drop.addEventListener("dragover", (e)=>{
      e.preventDefault();
      drop.classList.add("dragOver");
    });
    drop.addEventListener("dragleave", ()=> drop.classList.remove("dragOver"));
    drop.addEventListener("drop", (e)=>{
      e.preventDefault();
      drop.classList.remove("dragOver");
      const p = Number(e.dataTransfer.getData("text/plain"));
      if(!Number.isFinite(p)) return;
      moneyAdd(p);
      renderDrop();
      msg.textContent = "";
      msg.className = "moneyMsg";
      showClink(drop, "Clink!");
    });

    const msg = document.getElementById("moneyMsg");

    function renderDrop(){
      drop.innerHTML = "";
      moneyStack.forEach((p, idx)=>{
        const item = UK_MONEY.find(x=>x.p===p);
        const tok = document.createElement("div");
        const isNote = item?.type==="note";
        tok.className = "coinToken " + (isNote ? "note " : "") + (item?.size==="small" ? "small " : "") + (item?.cls||"");
        tok.textContent = item?.label || `${p}p`;
        tok.title = "Tap to remove";
        tok.addEventListener("click", ()=>{
          // remove this coin
          tok.classList.add("removing");
          setTimeout(()=>{
            moneyTotal -= p;
            moneyStack.splice(idx, 1);
            if(moneyTotal < 0) moneyTotal = 0;
            renderDrop();
          }, settings.reduceMotion ? 0 : 210);
        });
        drop.appendChild(tok);
      });
      document.getElementById("moneyTotalText").textContent = formatGBP(moneyTotal);
    }

    moneyAllowed().forEach(item=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.draggable = true;
      btn.className = "coinBtn";
      btn.dataset.pence = String(item.p);
      btn.addEventListener("dragstart", (e)=>{
        e.dataTransfer.setData("text/plain", String(item.p));
        tok.classList.add("dragging");
      });
      btn.addEventListener("dragend", ()=> tok.classList.remove("dragging"));

      const tok = document.createElement("div");
      const isNote = item.type==="note";
      tok.className = "coinToken " + (isNote ? "note " : "") + (item.size==="small" ? "small " : "") + item.cls;
      tok.innerHTML = isNote ? `<span>${item.label}</span>` : item.label;
      btn.appendChild(tok);
      btn.onclick = ()=>{
        moneyAdd(item.p);
        renderDrop();
        msg.textContent = "";
        msg.className = "moneyMsg";
        speak(item.label, 0.9);
        showClink(drop, "Clink!");
      };
      pal.appendChild(btn);
    });

    document.getElementById("moneyUndoBtn").onclick = ()=>{ moneyUndo(); renderDrop(); msg.textContent=""; msg.className="moneyMsg"; };
    document.getElementById("moneyClearBtn").onclick = ()=>{ moneyClear(); renderDrop(); msg.textContent=""; msg.className="moneyMsg"; };
    document.getElementById("moneyNewBtn").onclick = ()=>{ moneyNewTarget(); moneyClear(); renderGames(); };
    document.getElementById("moneyCheckBtn").onclick = ()=>{
      const res = moneyCheck();
      if(res.ok){
        msg.textContent = "‚úÖ Perfect! You made the exact amount.";
        msg.className = "moneyMsg feedback good";
        // new target after success (gentle)
        setTimeout(()=>{ moneyNewTarget(); moneyClear(); renderGames(); }, settings.reduceMotion ? 350 : 850);
      }else if(res.over){
        msg.textContent = "‚ö†Ô∏è That‚Äôs too much. Try undo or remove some coins.";
        msg.className = "moneyMsg feedback warn";
      }else{
        msg.textContent = "‚ûï Not enough yet. Add a little more.";
        msg.className = "moneyMsg feedback warn";
      }
    };

    // initial drop render
    renderDrop();
  }

}

function gamesInit(){
  // stop tetris loop if leaving later
  // initialize games state
  c4Reset();
  tetrisReset();
  currentGame = "connect4";
  // set tab state
  const tabs = document.getElementById("gameTabs");
  if(tabs){
    tabs.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.game==="connect4"));
  }
  renderGames();
}

// tab switching
document.addEventListener("click", (e)=>{
  const btn = e.target.closest?.("#gameTabs .tab");
  if(!btn) return;
  currentGame = btn.dataset.game;
  document.querySelectorAll("#gameTabs .tab").forEach(t=>t.classList.toggle("active", t === btn));
  if(currentGame !== "tetris") tetrisPause();
  if(currentGame === "money" && !moneyTarget){ moneyNewTarget(); moneyClear(); }
  renderGames();
});

// games home button
const gh = document.getElementById("gamesHome");
if(gh) gh.addEventListener("click", ()=>showScreen("home"));

/* ---------- Init ---------- */
$("#year").textContent = new Date().getFullYear();
applySettings();
showScreen("home");

// If user resizes, keep trace crisp
window.addEventListener("resize", () => {
  if($("#handwritingScreen").classList.contains("active")){
    resizeTraceForDevice();
  }
});
</script>
</body>
</html>
