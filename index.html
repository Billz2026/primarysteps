<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Primary Steps</title>
<meta name="description" content="Primary Steps - Calm, fun learning for primary school children">

<style>
:root{
  --bg:#f5f7fa;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --blue:#2f80ed;
  --blue2:#0ea5e9;
  --ring: rgba(47,128,237,.18);
  --shadow: 0 10px 24px rgba(2,6,23,.10);
  --shadow2: 0 6px 16px rgba(2,6,23,.10);
  --radius: 18px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji";
  background: radial-gradient(1200px 800px at 20% 0%, rgba(14,165,233,.10), transparent 55%),
              radial-gradient(900px 600px at 80% 0%, rgba(47,128,237,.10), transparent 50%),
              var(--bg);
  color:var(--text);
}

header{
  background:rgba(255,255,255,.9);
  backdrop-filter: blur(10px);
  padding:18px 16px;
  box-shadow:0 2px 10px rgba(2,6,23,.06);
  position:sticky;
  top:0;
  z-index:10;
  border-bottom:1px solid rgba(15,23,42,.06);
}

.brand{
  max-width:960px;
  margin:0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.brand-left{
  display:flex;
  align-items:center;
  gap:12px;
  min-width: 220px;
}

.logoMark{
  width:44px;height:44px;border-radius:14px;
  background: linear-gradient(135deg, var(--blue2), var(--blue));
  box-shadow: 0 10px 20px rgba(47,128,237,.25);
  display:grid;place-items:center;
  color:white;font-weight:900;
  letter-spacing: -1px;
  flex:0 0 auto;
}

.brand h1{margin:0;font-size:1.15rem;line-height:1.1}
.brand p{margin:2px 0 0;color:var(--muted);font-size:.95rem}

.container{max-width:960px;margin:0 auto;padding:22px 18px}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:18px 18px;
  box-shadow:var(--shadow2);
  cursor:pointer;
  border:1px solid rgba(15,23,42,.06);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  user-select:none;
}
.card:hover{
  transform: translateY(-2px);
  box-shadow:var(--shadow);
  border-color: rgba(47,128,237,.18);
}

button{
  padding:12px 16px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.08);
  background: #ffffff;
  color: var(--text);
  font-weight:800;
  cursor:pointer;
  box-shadow: 0 8px 18px rgba(2,6,23,.08);
  transition: transform .10s ease, box-shadow .10s ease, border-color .10s ease, background .10s ease;
}
button:hover{transform: translateY(-1px); box-shadow: 0 12px 24px rgba(2,6,23,.10); border-color: rgba(47,128,237,.25)}
button:active{transform: translateY(0px); box-shadow: 0 6px 16px rgba(2,6,23,.10)}
.btnPrimary{
  background: linear-gradient(135deg, var(--blue2), var(--blue));
  color:#fff;
  border-color: transparent;
  box-shadow: 0 14px 28px rgba(47,128,237,.28);
}
.btnPrimary:hover{box-shadow: 0 18px 34px rgba(47,128,237,.32)}
.btnGhost{
  background: rgba(255,255,255,.85);
}

.screen{display:none}
.screen.active{display:block}

.toggle{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:flex-end;
  margin-bottom: 12px;
  color: var(--muted);
}
.toggle input{transform: scale(1.1)}

.panel{
  background: rgba(255,255,255,.9);
  border:1px solid rgba(15,23,42,.06);
  border-radius: var(--radius);
  box-shadow: var(--shadow2);
  padding: 18px;
}

.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:7px 12px;border-radius:999px;
  font-weight:800;
  background: rgba(14,165,233,.12);
  color:#0b4a6e;
  border: 1px solid rgba(14,165,233,.18);
}

.lettersTarget{
  font-size:4.2rem;
  letter-spacing: 3px;
  margin: 14px 0 16px;
  text-align:center;
}
.lettersHint{
  text-align:center;
  color: var(--muted);
  margin: 0 0 10px;
}

.lettersTopBar{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}

select{
  padding:10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.95);
  font-weight: 700;
}

canvas{border:2px dashed #cbd5e1;border-radius:16px;background:#fff}

.footer{
  text-align:center;
  color:#64748b;
  padding:22px 12px;
  border-top: 1px solid rgba(15,23,42,.06);
  background: rgba(255,255,255,.6);
}

.memoryBoard{
  display:grid;
  gap:12px;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  margin-top: 10px;
}

.memoryCard{
  position:relative;
  border-radius: 16px;
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.95);
  box-shadow: 0 10px 22px rgba(2,6,23,.10);
  cursor:pointer;
  min-height: 76px;
  display:grid;
  place-items:center;
  font-weight: 900;
  font-size: 1.6rem;
  user-select:none;
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}

.memoryCard:hover{
  transform: translateY(-1px);
  box-shadow: 0 14px 28px rgba(2,6,23,.12);
  border-color: rgba(47,128,237,.22);
}

.memoryCard.isFlipped{
  background: linear-gradient(135deg, rgba(14,165,233,.14), rgba(47,128,237,.10));
  border-color: rgba(47,128,237,.30);
}

.memoryCard.isMatched{
  background: linear-gradient(135deg, rgba(34,197,94,.14), rgba(16,185,129,.10));
  border-color: rgba(16,185,129,.28);
  cursor: default;
  transform: none;
}

@media (max-width: 520px){
  .memoryBoard{grid-template-columns: repeat(3, minmax(0, 1fr));}
  .memoryCard{min-height: 70px;font-size:1.5rem;}
}

/* Phonics */
#phonicsChoices button{
  text-transform: none;
  font-size: 1.05rem;
}

/* Maths */
.mathsTabs{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap:10px;
  margin-top: 6px;
}
.mathsTab{
  padding:12px 10px;
  border-radius: 14px;
  font-weight: 900;
  box-shadow: 0 10px 22px rgba(2,6,23,.08);
  border: 1px solid rgba(15,23,42,.08);
}
.mathsTab.active{
  background: linear-gradient(135deg, var(--blue2), var(--blue));
  color: white;
  border-color: transparent;
}
@media (max-width: 640px){
  .mathsTabs{grid-template-columns: repeat(2, minmax(0, 1fr));}
}

/* Handwriting */
#trace{
  border: 2px solid rgba(15,23,42,.10);
  border-radius: 18px;
  background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92));
  box-shadow: 0 14px 28px rgba(2,6,23,.10);
  max-width: 100%;
  height: auto;
  touch-action: none; /* important for tablets */
}

/* Progress */
.progressRow{
  display:grid;
  grid-template-columns: 90px 1fr 42px;
  align-items:center;
  gap:10px;
  margin: 10px 0;
}
.progressLabel{color:var(--muted);font-weight:900}
.progressBar{
  height: 12px;
  background: rgba(15,23,42,.08);
  border-radius: 999px;
  overflow:hidden;
  border: 1px solid rgba(15,23,42,.06);
}
.progressFill{
  height:100%;
  width:0%;
  background: linear-gradient(135deg, var(--blue2), var(--blue));
  border-radius: 999px;
  transition: width .25s ease;
}
.progressValue{font-weight:900;color:var(--text);text-align:right}
@media (max-width: 520px){
  .progressRow{grid-template-columns: 76px 1fr 36px;}
}


/* Topbar inspired layout */
header.topbar{
  background: rgba(255,255,255,.88);
  backdrop-filter: blur(12px);
  position: sticky;
  top: 0;
  z-index: 50;
  border-bottom: 1px solid rgba(15,23,42,.06);
  box-shadow: 0 2px 14px rgba(2,6,23,.06);
}
.topbarInner{
  max-width: 1040px;
  margin: 0 auto;
  padding: 14px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
}
.brandLeft{
  display:flex;
  align-items:center;
  gap:12px;
  cursor:pointer;
  user-select:none;
}
.brandTitle{font-weight:950;letter-spacing:-.3px}
.brandSub{color:var(--muted);font-weight:650;font-size:.95rem;line-height:1.15}
.navLinks{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  flex:1;
  padding: 0 10px;
}
.navLinks a{
  color: var(--muted);
  text-decoration:none;
  font-weight:850;
  padding: 10px 10px;
  border-radius: 999px;
  transition: background .12s ease, color .12s ease;
}
.navLinks a:hover{
  background: rgba(47,128,237,.10);
  color: #0f172a;
}
.topbarRight{
  display:flex;
  align-items:center;
  gap:10px;
}
.starsPill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 10px 12px;
  border-radius: 999px;
  background: rgba(34,197,94,.10);
  border: 1px solid rgba(34,197,94,.18);
  color:#065f46;
  font-weight:950;
}
.soundPill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 10px 12px;
  border-radius: 999px;
  background: rgba(255,255,255,.85);
  border: 1px solid rgba(15,23,42,.10);
  color: var(--text);
  font-weight:900;
  cursor:pointer;
  user-select:none;
}
.soundPill input{transform: translateY(1px) scale(1.1);}
@media (max-width: 920px){
  .navLinks{display:none;}
}

/* Home hero */
.heroPanel{
  background: radial-gradient(900px 420px at 15% 0%, rgba(14,165,233,.18), transparent 55%),
              radial-gradient(900px 420px at 85% 0%, rgba(47,128,237,.16), transparent 55%),
              rgba(255,255,255,.65);
}
.heroGrid{
  display:grid;
  grid-template-columns: 1.3fr .7fr;
  gap:18px;
  align-items:start;
}
.heroTitle{margin:0;font-size:2.1rem;letter-spacing:-.8px;line-height:1.08}
.heroText{margin:10px 0 0;color:var(--muted);font-size:1.05rem;max-width:60ch}
.heroChips{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
.chip{
  background: rgba(255,255,255,.85);
  border:1px solid rgba(15,23,42,.08);
  border-radius: 999px;
  padding: 8px 12px;
  color: var(--muted);
  font-weight:800;
}
.heroCtas{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
.heroSide{display:flex;flex-direction:column;gap:12px}
.miniCard{
  background: rgba(255,255,255,.9);
  border:1px solid rgba(15,23,42,.06);
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 10px 22px rgba(2,6,23,.06);
}
.miniTitle{font-weight:950;margin-bottom:6px}
.miniText{color:var(--muted);font-weight:700}
.sectionHeading{margin:18px 2px 10px;font-size:1.15rem;letter-spacing:-.2px}
.cardBtn{
  text-align:left;
  border:none;
  width:100%;
  background: var(--card);
}
.cardBtn:active{transform: translateY(0px) scale(.99);}
@media (max-width: 800px){
  .heroGrid{grid-template-columns: 1fr;}
}</style>
</head>

<body>

<header class="topbar">
  <div class="topbarInner">
    <div class="brandLeft" onclick="show('home')" role="button" tabindex="0" aria-label="Go home">
      <div class="logoMark" aria-hidden="true">
        <svg width="44" height="44" viewBox="0 0 64 64" role="img" aria-label="Primary Steps logo">
          <defs>
            <linearGradient id="psg" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#0ea5e9"/>
              <stop offset="1" stop-color="#2f80ed"/>
            </linearGradient>
          </defs>
          <rect x="6" y="6" width="52" height="52" rx="18" fill="url(#psg)"/>
          <g fill="#ffffff" opacity=".95">
            <path d="M24 39c3 0 6-2 6-5s-3-6-6-6-6 3-6 6 3 5 6 5z"/>
            <path d="M22 46c2 0 4-1 4-3s-2-4-4-4-4 2-4 4 2 3 4 3z" opacity=".9"/>
            <path d="M40 34c3 0 6-2 6-5s-3-6-6-6-6 3-6 6 3 5 6 5z"/>
            <path d="M42 42c2 0 4-1 4-3s-2-4-4-4-4 2-4 4 2 3 4 3z" opacity=".9"/>
          </g>
        </svg>
      </div>
      <div class="brandText">
        <div class="brandTitle">Primary Steps</div>
        <div class="brandSub">Calm, fun learning for primary school children</div>
      </div>
    </div>

    <nav class="navLinks" aria-label="Primary navigation">
      <a href="#home" onclick="show('home');return false;">Home</a>
      <a href="#letters" onclick="show('letters');return false;">Letters</a>
      <a href="#numbers" onclick="show('numbers');return false;">Numbers</a>
      <a href="#phonics" onclick="show('phonics');return false;">Phonics</a>
      <a href="#maths" onclick="show('maths');return false;">Maths</a>
      <a href="#handwriting" onclick="show('handwriting');return false;">Handwriting</a>
      <a href="#progress" onclick="show('progress');return false;">Progress</a>
    </nav>

    <div class="topbarRight">
      <div class="starsPill" title="Stars saved on this device">
        <span id="stars">‚≠ê 0</span>
      </div>
      <label class="soundPill">
        <input type="checkbox" id="soundToggle">
        <span>Sound</span>
      </label>
    </div>
  </div>
</header>

<div class="container">
<section id="home" class="screen active">
  <div class="panel heroPanel">
    <div class="heroGrid">
      <div>
        <h2 class="heroTitle">Welcome to Primary Steps</h2>
        <p class="heroText">Short, calm learning games for primary school children ‚Äî built for focus, confidence, and steady progress.</p>
        <div class="heroChips" aria-label="Highlights">
          <span class="chip">ASD-friendly</span>
          <span class="chip">No ads</span>
          <span class="chip">Progress saved on this device</span>
        </div>
        <div class="heroCtas">
          <button class="btnPrimary" type="button" onclick="show('letters')">Start with Letters</button>
          <button class="btnGhost" type="button" onclick="show('progress')">View Progress</button>
        </div>
      </div>

      <div class="heroSide">
        <div class="miniCard">
          <div class="miniTitle">Today‚Äôs tip</div>
          <div class="miniText">Try 5 minutes per activity. Short sessions help children stay calm and focused.</div>
        </div>
        <div class="miniCard">
          <div class="miniTitle">Sound</div>
          <div class="miniText">Use sound for feedback and phonics practice. Turn it off anytime.</div>
        </div>
      </div>
    </div>
  </div>

  <h3 class="sectionHeading">Activities</h3>
  <div class="grid">
    <button class="card cardBtn" type="button" onclick="show('letters')">
      <div class="cardTitle">üî§ Letters</div>
      <div class="cardDesc">Match the target letter (A‚ÄìZ)</div>
    </button>
    <button class="card cardBtn" type="button" onclick="show('numbers')">
      <div class="cardTitle">üî¢ Numbers</div>
      <div class="cardDesc">Count, pick and practise</div>
    </button>
    <button class="card cardBtn" type="button" onclick="show('memory')">
      <div class="cardTitle">üß† Memory</div>
      <div class="cardDesc">Focus and matching</div>
    </button>
    <button class="card cardBtn" type="button" onclick="show('phonics')">
      <div class="cardTitle">üîä Phonics</div>
      <div class="cardDesc">Listen and pick the word</div>
    </button>
    <button class="card cardBtn" type="button" onclick="show('maths')">
      <div class="cardTitle">‚ûï Maths</div>
      <div class="cardDesc">Add, subtract, divide &amp; time</div>
    </button>
    <button class="card cardBtn" type="button" onclick="show('handwriting')">
      <div class="cardTitle">‚úçÔ∏è Handwriting</div>
      <div class="cardDesc">Trace words smoothly</div>
    </button>
    <button class="card cardBtn" type="button" onclick="show('progress')">
      <div class="cardTitle">‚≠ê Progress</div>
      <div class="cardDesc">Stars and activity breakdown</div>
    </button>
  </div>

  <div class="panel" style="margin-top:16px;">
    <div class="badge" style="margin-bottom:10px;">How it works</div>
    <div class="grid" style="gap:12px;">
      <div class="card" style="cursor:default;">
        <div style="font-weight:950;">Step 1</div>
        <div style="color:var(--muted);margin-top:6px;">Pick an activity.</div>
      </div>
      <div class="card" style="cursor:default;">
        <div style="font-weight:950;">Step 2</div>
        <div style="color:var(--muted);margin-top:6px;">Answer at your pace (sound optional).</div>
      </div>
      <div class="card" style="cursor:default;">
        <div style="font-weight:950;">Step 3</div>
        <div style="color:var(--muted);margin-top:6px;">Earn stars and track progress.</div>
      </div>
    </div>
  </div>
</section>

<section id="letters" class="screen">
  <div class="panel">
    <div class="lettersTopBar">
      <div class="badge">
        <span>Letters</span>
        <span id="letterProgress">1</span><span style="opacity:.65;">/</span><span id="letterTotal">26</span>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Difficulty
          <select id="letterDifficulty" onchange="setLettersDifficulty(this.value)">
            <option value="2">Easy (2)</option>
            <option value="4">Normal (4)</option>
            <option value="6" selected>Challenge (6)</option>
          </select>
        </label>

        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Lowercase
          <input type="checkbox" id="letterLowercase" onchange="setLettersCase(this.checked)">
        </label>

        <button class="btnPrimary" onclick="restartLetters()">Restart</button>
      </div>
    </div>

    <p class="lettersHint">Tap the matching letter. Letters appear in a random order.</p>

    <div class="lettersTarget" id="letterTarget">A</div>

    <div id="letterChoices" class="grid" style="margin-top:10px;"></div>

    <div style="display:flex;justify-content:center;margin-top:16px;">
      <button class="btnGhost" class="btnGhost" onclick="show('home')">Home</button>
    </div>
  </div>
</section>

<section id="numbers" class="screen">
  <div class="panel">
    <div class="lettersTopBar">
      <div class="badge">
        <span>Numbers</span>
        <span id="numberProgress">1</span><span style="opacity:.65;">/</span><span id="numberTotal">10</span>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Difficulty
          <select id="numberDifficulty" onchange="setNumbersDifficulty(this.value)">
            <option value="2">Easy (2)</option>
            <option value="4">Normal (4)</option>
            <option value="6" selected>Challenge (6)</option>
          </select>
        </label>

        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Range
          <select id="numberRange" onchange="setNumbersRange(this.value)">
            <option value="10" selected>0‚Äì10</option>
            <option value="20">0‚Äì20</option>
            <option value="50">0‚Äì50</option>
          </select>
        </label>

        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Mode
          <select id="numberMode" onchange="setNumbersMode(this.value)">
            <option value="digits" selected>Digits</option>
            <option value="dots">Dots</option>
            <option value="mix">Mix</option>
          </select>
        </label>

        <button class="btnPrimary" onclick="restartNumbers()">Restart</button>
      </div>
    </div>

    <p class="lettersHint" id="numberHint">Pick the matching number.</p>

    <div class="lettersTarget" id="numberTarget" style="font-variant-numeric: tabular-nums;">3</div>

    <div id="numberChoices" class="grid" style="margin-top:10px;"></div>

    <div style="display:flex;justify-content:center;margin-top:16px;">
      <button class="btnGhost" onclick="show('home')">Home</button>
    </div>
  </div>
</section>

<section id="memory" class="screen">
  <div class="panel">
    <div class="lettersTopBar">
      <div class="badge">
        <span>Memory Match</span>
        <span id="memoryMoves">0</span><span style="opacity:.65;"> moves</span>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Difficulty
          <select id="memoryDifficulty" onchange="setMemoryDifficulty(this.value)">
            <option value="4">Easy (4 pairs)</option>
            <option value="6" selected>Normal (6 pairs)</option>
            <option value="8">Challenge (8 pairs)</option>
          </select>
        </label>

        <button class="btnPrimary" onclick="restartMemory()">Restart</button>
      </div>
    </div>

    <p class="lettersHint" id="memoryHint">Flip two cards to find a matching pair.</p>

    <div id="memoryBoard" class="memoryBoard" aria-label="Memory match board"></div>

    <div style="display:flex;justify-content:center;margin-top:16px;">
      <button class="btnGhost" onclick="show('home')">Home</button>
    </div>
  </div>
</section>

<section id="phonics" class="screen">
  <div class="panel">
    <div class="lettersTopBar">
      <div class="badge">
        <span>Phonics</span>
        <span id="phonicsProgress">1</span><span style="opacity:.65;">/</span><span id="phonicsTotal">25</span>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Difficulty
          <select id="phonicsDifficulty" onchange="setPhonicsDifficulty(this.value)">
            <option value="2">Easy (2)</option>
            <option value="4" selected>Normal (4)</option>
            <option value="6">Challenge (6)</option>
          </select>
        </label>

        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Auto-play
          <input type="checkbox" id="phonicsAutoplay" checked>
        </label>

        <button class="btnPrimary" onclick="restartPhonics()">Restart</button>
      </div>
    </div>

    <p class="lettersHint" id="phonicsHint">Press ‚ÄúPlay sound‚Äù, then tap the word you hear.</p>

    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:10px;">
      <button class="btnPrimary" onclick="playCurrentPhonics()">üîä Play sound</button>
      <span class="badge" id="phonicsPromptBadge" style="background:rgba(14,165,233,.10);">Listen carefully</span>
    </div>

    <div id="phonicsChoices" class="grid" style="margin-top:14px;"></div>

    <div style="display:flex;justify-content:center;margin-top:16px;">
      <button class="btnGhost" onclick="show('home')">Home</button>
    </div>
  </div>
</section>

<section id="maths" class="screen">
  <div class="panel">
    <div class="lettersTopBar">
      <div class="badge">
        <span>Maths</span>
        <span id="mathsModeLabel">Choose</span>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Difficulty
          <select id="mathsDifficulty" onchange="setMathsDifficulty(this.value)">
            <option value="easy">Easy</option>
            <option value="normal" selected>Normal</option>
            <option value="challenge">Challenge</option>
          </select>
        </label>
        <button class="btnPrimary" onclick="restartMaths()">Restart</button>
      </div>
    </div>

    <p class="lettersHint" id="mathsHint">Pick a maths activity.</p>

    <div class="mathsTabs" role="tablist" aria-label="Maths sections">
      <button class="mathsTab btnGhost" id="tabAdd" onclick="setMathsMode('add')" role="tab">‚ûï Add</button>
      <button class="mathsTab btnGhost" id="tabSub" onclick="setMathsMode('sub')" role="tab">‚ûñ Subtract</button>
      <button class="mathsTab btnGhost" id="tabDiv" onclick="setMathsMode('div')" role="tab">‚ûó Divide</button>
      <button class="mathsTab btnGhost" id="tabTime" onclick="setMathsMode('time')" role="tab">üïí Timing</button>
    </div>

    <div id="mathsStage" style="margin-top:14px;">
      <!-- Add/Sub/Div -->
      <div id="mathsQA" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <div class="badge"><span id="mathsProgress">1</span><span style="opacity:.65;">/</span><span id="mathsTotal">10</span></div>
          <div class="badge" id="mathsScoreBadge" style="background:rgba(34,197,94,.10);border-color:rgba(34,197,94,.20);color:#065f46;">
            ‚≠ê <span id="mathsCorrect">0</span> correct
          </div>
        </div>

        <div class="lettersTarget" id="mathsQuestion" style="font-size:2.6rem;letter-spacing:1px;">2 + 3</div>
        <div id="mathsChoices" class="grid"></div>
      </div>

      <!-- Timing -->
      <div id="mathsTime" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <div class="badge"><span id="timeProgress">1</span><span style="opacity:.65;">/</span><span id="timeTotal">10</span></div>
          <div class="badge" style="background:rgba(14,165,233,.10);">Read the clock</div>
        </div>

        <div style="display:flex;justify-content:center;margin:8px 0 12px;">
          <canvas id="clock" width="240" height="240" aria-label="Analogue clock"></canvas>
        </div>
        <div id="timeChoices" class="grid"></div>
      </div>
    </div>

    <div style="display:flex;justify-content:center;margin-top:16px;">
      <button class="btnGhost" onclick="show('home')">Home</button>
    </div>
  </div>
</section>

<section id="handwriting" class="screen">
  <div class="panel">
    <div class="lettersTopBar">
      <div class="badge">
        <span>Handwriting</span>
        <span id="traceProgress">1</span><span style="opacity:.65;">/</span><span id="traceTotal">30</span>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;">
          Level
          <select id="traceLevel" onchange="setTraceLevel(this.value)">
            <option value="easy" selected>Easy</option>
            <option value="normal">Normal</option>
            <option value="challenge">Challenge</option>
          </select>
        </label>

        <button class="btnGhost" onclick="resetTraceInk()">Clear</button>
        <button class="btnPrimary" onclick="nextTraceWord(true)">Next</button>
      </div>
    </div>

    <p class="lettersHint" id="traceHint">Trace over the word on the guide. When you‚Äôve finished, press ‚ÄúNext‚Äù.</p>

    <div style="display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;margin:10px 0 6px;">
      <span class="badge" style="background:rgba(14,165,233,.10);">Word:</span>
      <span class="badge" id="traceWordBadge" style="font-size:1.05rem;">cat</span>
      <button class="btnPrimary" onclick="speakTraceWord()" style="padding:10px 14px;">üîä Say word</button>
    </div>

    <div style="display:flex;justify-content:center;margin-top:10px;">
      <canvas id="trace" width="720" height="260" aria-label="Handwriting tracing canvas"></canvas>
    </div>

    <div style="display:flex;justify-content:center;margin-top:12px;">
      <button class="btnGhost" onclick="show('home')">Home</button>
    </div>
  </div>
</section>

<section id="progress" class="screen">
  <div class="panel">
    <div class="lettersTopBar">
      <div class="badge">
        <span>Progress</span>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;">
        <button class="btnGhost" onclick="refreshProgress()">Refresh</button>
        <button class="btnPrimary" onclick="resetProgressConfirm()">Reset</button>
      </div>
    </div>

    <p class="lettersHint">A quick snapshot of progress. Stars save on this device.</p>

    <div class="grid" style="margin-top:10px;">
      <div class="card" style="cursor:default;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;">‚≠ê Stars</div>
          <div class="badge" style="background:rgba(34,197,94,.10);border-color:rgba(34,197,94,.20);color:#065f46;">
            <span id="starsCount">0</span>
          </div>
        </div>
        <div style="color:var(--muted);margin-top:8px;">Earn stars by answering questions and completing activities.</div>
      </div>

      <div class="card" style="cursor:default;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;">üèÅ Sets completed</div>
          <div class="badge">
            <span id="setsTotal">0</span>
          </div>
        </div>
        <div style="color:var(--muted);margin-top:8px;">A set is counted when you finish a full activity round.</div>
      </div>

      <div class="card" style="cursor:default;">
        <div style="font-weight:900;margin-bottom:8px;">üìä Activity breakdown</div>

        <div class="progressRow">
          <div class="progressLabel">Letters</div>
          <div class="progressBar"><div id="barLetters" class="progressFill"></div></div>
          <div class="progressValue" id="valLetters">0</div>
        </div>

        <div class="progressRow">
          <div class="progressLabel">Numbers</div>
          <div class="progressBar"><div id="barNumbers" class="progressFill"></div></div>
          <div class="progressValue" id="valNumbers">0</div>
        </div>

        <div class="progressRow">
          <div class="progressLabel">Memory</div>
          <div class="progressBar"><div id="barMemory" class="progressFill"></div></div>
          <div class="progressValue" id="valMemory">0</div>
        </div>

        <div class="progressRow">
          <div class="progressLabel">Phonics</div>
          <div class="progressBar"><div id="barPhonics" class="progressFill"></div></div>
          <div class="progressValue" id="valPhonics">0</div>
        </div>

        <div class="progressRow">
          <div class="progressLabel">Maths</div>
          <div class="progressBar"><div id="barMaths" class="progressFill"></div></div>
          <div class="progressValue" id="valMaths">0</div>
        </div>

        <div class="progressRow">
          <div class="progressLabel">Timing</div>
          <div class="progressBar"><div id="barTiming" class="progressFill"></div></div>
          <div class="progressValue" id="valTiming">0</div>
        </div>

        <div class="progressRow">
          <div class="progressLabel">Tracing</div>
          <div class="progressBar"><div id="barTracing" class="progressFill"></div></div>
          <div class="progressValue" id="valTracing">0</div>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:center;margin-top:16px;">
      <button class="btnGhost" onclick="show('home')">Home</button>
    </div>
  </div>
</section>

</div>

<div class="footer">
¬© 2025 Primary Steps
</div>

<script>
let stars=Number(localStorage.getItem('stars')||0);
let traceInited=false;
document.getElementById('stars').innerText="‚≠ê "+stars;

function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  if(id === 'letters'){
    const diff = document.getElementById('letterDifficulty')?.value || "6";
    setLettersDifficulty(diff);
    const lower = document.getElementById('letterLowercase')?.checked || false;
    setLettersCase(lower);
    startLettersGame();
  }

 
  if(id === 'progress'){
    refreshProgress();
  }
 if(id === 'numbers'){
    const diff = document.getElementById('numberDifficulty')?.value || "6";
    setNumbersDifficulty(diff);
    const rng = document.getElementById('numberRange')?.value || "10";
    setNumbersRange(rng);
    const mode = document.getElementById('numberMode')?.value || "digits";
    setNumbersMode(mode);
    startNumbersGame();
  }

  if(id === 'memory'){
    const diff = document.getElementById('memoryDifficulty')?.value || "6";
    setMemoryDifficulty(diff);
    restartMemory();
  }

  if(id === 'phonics'){
    const diff = document.getElementById('phonicsDifficulty')?.value || "4";
    setPhonicsDifficulty(diff);
    startPhonicsGame();
  }

  if(id === 'maths'){
    const diff = document.getElementById('mathsDifficulty')?.value || "normal";
    setMathsDifficulty(diff);
    if(!mathsMode || mathsMode === "choose") setMathsMode('add');
    else restartMaths();
  }

  if(id === 'handwriting'){
    if(!traceInited){
      initTrace();
      traceInited = true;
    }
    const lvl = document.getElementById('traceLevel')?.value || "easy";
    setTraceLevel(lvl);
  }
}

if(id === 'numbers'){
    const diff = document.getElementById('numberDifficulty')?.value || "6";
    setNumbersDifficulty(diff);
    const rng = document.getElementById('numberRange')?.value || "10";
    setNumbersRange(rng);
    const mode = document.getElementById('numberMode')?.value || "digits";
    setNumbersMode(mode);
    startNumbersGame();
  }

  if(id === 'memory'){
    const diff = document.getElementById('memoryDifficulty')?.value || "6";
    setMemoryDifficulty(diff);
    restartMemory();
  }

  if(id === 'phonics'){
    const diff = document.getElementById('phonicsDifficulty')?.value || "4";
    setPhonicsDifficulty(diff);
    startPhonicsGame();
  }

  if(id === 'maths'){
    const diff = document.getElementById('mathsDifficulty')?.value || "normal";
    setMathsDifficulty(diff);
    // default mode if none chosen yet
    if(!mathsMode || mathsMode === "choose") setMathsMode('add');
    else restartMaths();
  }
}

if(id === 'numbers'){
    const diff = document.getElementById('numberDifficulty')?.value || "6";
    setNumbersDifficulty(diff);
    const rng = document.getElementById('numberRange')?.value || "10";
    setNumbersRange(rng);
    const mode = document.getElementById('numberMode')?.value || "digits";
    setNumbersMode(mode);
    startNumbersGame();
  }

  if(id === 'memory'){
    const diff = document.getElementById('memoryDifficulty')?.value || "6";
    setMemoryDifficulty(diff);
    restartMemory();
  }

  if(id === 'phonics'){
    const diff = document.getElementById('phonicsDifficulty')?.value || "4";
    setPhonicsDifficulty(diff);
    startPhonicsGame();
  }
}

if(id === 'numbers'){
    const diff = document.getElementById('numberDifficulty')?.value || "6";
    setNumbersDifficulty(diff);
    const rng = document.getElementById('numberRange')?.value || "10";
    setNumbersRange(rng);
    const mode = document.getElementById('numberMode')?.value || "digits";
    setNumbersMode(mode);
    startNumbersGame();
  }

  if(id === 'memory'){
    const diff = document.getElementById('memoryDifficulty')?.value || "6";
    setMemoryDifficulty(diff);
    restartMemory();
  }
}

if(id === 'numbers'){
    const diff = document.getElementById('numberDifficulty')?.value || "6";
    setNumbersDifficulty(diff);
    const rng = document.getElementById('numberRange')?.value || "10";
    // setNumbersRange calls restartNumbers, so call it before mode/game start
    setNumbersRange(rng);
    const mode = document.getElementById('numberMode')?.value || "digits";
    setNumbersMode(mode);
    startNumbersGame();
  }
}

}

function speak(text){
  if(!document.getElementById('soundToggle').checked)return;
  const u=new SpeechSynthesisUtterance(text);
  speechSynthesis.speak(u);
}

// --- Letters game: full alphabet, random order, feedback sounds ---
const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
let letterQueue = [];
let currentLetter = "A";
let letterIndex = 0;

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function startLettersGame(){
  letterQueue = shuffle([...ALPHABET]);
  letterIndex = 0;
  nextLetter();
}

function restartLetters(){
  startLettersGame();
}

function renderLetterChoices(){
  const wrap = document.getElementById("letterChoices");
  if(!wrap) return;

  const CHOICES = 6; // kid-friendly: enough variety without overwhelming
  const opts = new Set([currentLetter]);
  while(opts.size < CHOICES){
    opts.add(ALPHABET[Math.floor(Math.random()*ALPHABET.length)]);
  }
  const options = shuffle([...opts]);

  wrap.innerHTML = "";
  options.forEach(l=>{
    const b = document.createElement("button");
    b.textContent = l;
    b.onclick = ()=>pickLetter(l);
    wrap.appendChild(b);
  });
}

function nextLetter(){
  if(!letterQueue.length){
    // finished
    const prog = document.getElementById("letterProgress");
    if(prog) prog.textContent = "26";
    if(document.getElementById('soundToggle')?.checked) playSuccess();
    incStat("sets_letters");
alert("Nice! You finished the alphabet üéâ");
    startLettersGame();
    return;
  }
  currentLetter = letterQueue.pop();
  letterIndex++;
  const target = document.getElementById("letterTarget");
  if(target) target.textContent = currentLetter;
  const prog = document.getElementById("letterProgress");
  if(prog) prog.textContent = String(letterIndex);
  renderLetterChoices();
}

// Simple built-in sounds (no files): WebAudio beeps
let audioCtx;
function tone(freq, ms, type="sine", gainVal=0.12){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gainVal;
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ try{o.stop();}catch(e){} }, ms);
  }catch(e){
    // Audio not available; silently ignore
  }
}
function playSuccess(){
  if(!document.getElementById('soundToggle')?.checked) return;
  tone(660, 90, "sine", 0.10);
  setTimeout(()=>tone(880, 120, "sine", 0.10), 110);
}
function playError(){
  if(!document.getElementById('soundToggle')?.checked) return;
  tone(220, 180, "square", 0.08);
}

}


  else alert('Try again');
}

else alert('Try again');
}

function save(){
  localStorage.setItem('stars',stars);
  document.getElementById('stars').innerText="‚≠ê "+stars;
}

function resetProgress(){
  stars=0;save();
  if(typeof refreshProgress==='function') refreshProgress();
}


// --- Numbers game: varied practice, random questions, difficulty + range + modes ---
let numbersChoicesCount = 6;        // default (Challenge)
let numbersMax = 10;               // default range 0‚Äì10
let numbersMode = "digits";        // digits | dots | mix
let numbersQueue = [];
let currentNumber = 3;
let numberIndex = 0;
let numberTotal = 10;

function setNumbersDifficulty(val){
  const n = Number(val);
  numbersChoicesCount = [2,4,6].includes(n) ? n : 6;
  renderNumberChoices();
}

function setNumbersRange(val){
  const n = Number(val);
  numbersMax = [10,20,50].includes(n) ? n : 10;
  restartNumbers();
}

function setNumbersMode(val){
  numbersMode = (val === "dots" || val === "mix") ? val : "digits";
  updateNumberUI();
  renderNumberChoices();
}

function randInt(min, max){
  return Math.floor(Math.random()*(max-min+1))+min;
}

function formatDots(n){
  if(n === 0) return "‚óªÔ∏é";
  if(n <= 20) return "‚óè".repeat(n);
  const tens = Math.floor(n/10);
  const rem = n%10;
  return "‚óè".repeat(tens) + " " + "‚óè".repeat(rem);
}

function shouldShowDots(){
  if(numbersMode === "dots") return true;
  if(numbersMode === "digits") return false;
  return Math.random() < 0.5;
}

function startNumbersGame(){
  numberTotal = 10;
  numbersQueue = [];
  const used = new Set();
  while(numbersQueue.length < numberTotal){
    const n = randInt(0, numbersMax);
    if(used.has(n)) continue;
    used.add(n);
    numbersQueue.push(n);
  }
  shuffle(numbersQueue);
  numberIndex = 0;
  nextNumber();
}

function restartNumbers(){
  startNumbersGame();
}

function updateNumberUI(){
  const hint = document.getElementById("numberHint");
  const totalEl = document.getElementById("numberTotal");
  const progEl = document.getElementById("numberProgress");
  if(totalEl) totalEl.textContent = String(numberTotal);
  if(progEl) progEl.textContent = String(Math.max(numberIndex,1));

  const showDots = shouldShowDots();
  const target = document.getElementById("numberTarget");
  if(!target) return;

  if(showDots){
    target.style.fontSize = "2.3rem";
    target.style.letterSpacing = "1px";
    target.textContent = formatDots(currentNumber);
    if(hint) hint.textContent = "Count the dots, then pick the number.";
  }else{
    target.style.fontSize = "";
    target.style.letterSpacing = "";
    target.textContent = String(currentNumber);
    if(hint) hint.textContent = "Pick the matching number.";
  }
}

function renderNumberChoices(){
  const wrap = document.getElementById("numberChoices");
  if(!wrap) return;

  const opts = new Set([currentNumber]);
  while(opts.size < numbersChoicesCount){
    opts.add(randInt(0, numbersMax));
  }
  const options = shuffle([...opts]);

  wrap.innerHTML = "";
  options.forEach(n=>{
    const b = document.createElement("button");
    b.textContent = String(n);
    b.classList.add("btnGhost");
    b.onclick = ()=>pickNumber(n);
    wrap.appendChild(b);
  });

  const btns = wrap.querySelectorAll("button");
  if(btns[0]) btns[0].classList.add("btnPrimary");
}

function nextNumber(){
  if(!numbersQueue.length){
    if(document.getElementById('soundToggle')?.checked) playSuccess();
    incStat("sets_numbers");
alert("Brilliant! You finished this numbers set üéâ");
    startNumbersGame();
    return;
  }
  currentNumber = numbersQueue.pop();
  numberIndex++;
  const progEl = document.getElementById("numberProgress");
  if(progEl) progEl.textContent = String(numberIndex);
  updateNumberUI();
  renderNumberChoices();
}

function pickNumber(n){
  if(n === currentNumber){
    stars++; save();
    playSuccess();
    setTimeout(nextNumber, 350);
  } else {
    playError();
  }
}

// --- Memory Match: professional starter game with difficulty ---
const MEMORY_ICONS = ["üê∂","üê±","ü¶ä","üêº","üê∏","ü¶Å","üêµ","üê∞","üêª","üêØ","ü¶Ñ","üêô","ü¶ã","üêù","üçé","üçå","üçá","üçì","‚≠ê","üåô"];
let memoryPairs = 6;         // default normal
let memoryDeck = [];
let memoryFirst = null;
let memorySecond = null;
let memoryLock = false;
let memoryMoves = 0;
let memoryMatched = 0;

function setMemoryDifficulty(val){
  const n = Number(val);
  memoryPairs = [4,6,8].includes(n) ? n : 6;
  restartMemory();
}

function buildMemoryDeck(){
  const picks = shuffle([...MEMORY_ICONS]).slice(0, memoryPairs);
  memoryDeck = shuffle([...picks, ...picks]); // pairs duplicated then shuffled
}

function renderMemoryBoard(){
  const board = document.getElementById("memoryBoard");
  if(!board) return;

  // Responsive grid: 4 columns for 6/8 pairs, 3 columns for 4 pairs on small screens handled by CSS
  board.style.gridTemplateColumns = (memoryPairs <= 4) ? "repeat(4, minmax(0, 1fr))" : "repeat(4, minmax(0, 1fr))";

  board.innerHTML = "";
  memoryDeck.forEach((icon, idx)=>{
    const btn = document.createElement("button");
    btn.className = "memoryCard";
    btn.setAttribute("type","button");
    btn.setAttribute("aria-label","Hidden card");
    btn.dataset.index = String(idx);
    btn.dataset.icon = icon;
    btn.textContent = "‚Ä¢"; // hidden face
    btn.onclick = ()=>flipMemoryCard(btn);
    board.appendChild(btn);
  });
}

function resetMemoryState(){
  memoryFirst = null;
  memorySecond = null;
  memoryLock = false;
  memoryMoves = 0;
  memoryMatched = 0;
  const movesEl = document.getElementById("memoryMoves");
  if(movesEl) movesEl.textContent = "0";
  const hint = document.getElementById("memoryHint");
  if(hint) hint.textContent = "Flip two cards to find a matching pair.";
}

function restartMemory(){
  buildMemoryDeck();
  resetMemoryState();
  renderMemoryBoard();
}

function setMemoryMoves(n){
  memoryMoves = n;
  const movesEl = document.getElementById("memoryMoves");
  if(movesEl) movesEl.textContent = String(memoryMoves);
}

function revealCard(card){
  card.classList.add("isFlipped");
  card.textContent = card.dataset.icon;
  card.setAttribute("aria-label","Revealed card");
}

function hideCard(card){
  card.classList.remove("isFlipped");
  card.textContent = "‚Ä¢";
  card.setAttribute("aria-label","Hidden card");
}

function markMatched(card){
  card.classList.add("isMatched");
  card.disabled = true;
  card.setAttribute("aria-label","Matched card");
}

function finishMemoryIfComplete(){
  if(memoryMatched === memoryPairs){
    stars++; save();
    if(document.getElementById('soundToggle')?.checked) playSuccess();
    const hint = document.getElementById("memoryHint");
    if(hint) incStat("sets_memory");
    hint.textContent = "Nice work! You matched them all üéâ";
  }
}

function flipMemoryCard(card){
  if(memoryLock) return;
  if(card.classList.contains("isMatched")) return;
  if(card === memoryFirst) return;

  revealCard(card);

  if(!memoryFirst){
    memoryFirst = card;
    return;
  }

  memorySecond = card;
  memoryLock = true;
  setMemoryMoves(memoryMoves + 1);

  const match = memoryFirst.dataset.icon === memorySecond.dataset.icon;

  if(match){
    markMatched(memoryFirst);
    markMatched(memorySecond);
    memoryMatched++;
    if(document.getElementById('soundToggle')?.checked) playSuccess();
    memoryFirst = null;
    memorySecond = null;
    memoryLock = false;
    finishMemoryIfComplete();
  }else{
    if(document.getElementById('soundToggle')?.checked) playError();
    setTimeout(()=>{
      hideCard(memoryFirst);
      hideCard(memorySecond);
      memoryFirst = null;
      memorySecond = null;
      memoryLock = false;
    }, 650);
  }
}

// --- Phonics: 25+ questions, auto-advance, professional layout ---
const PHONICS_WORDS = [
  // CVC + common early words (25)
  "cat","dog","sun","hat","map","pen","pig","cup","bed","fox",
  "run","tap","sock","fish","ship","chop","thin","this","rain","moon",
  "star","frog","milk","tree","bike"
];

let phonicsChoicesCount = 4; // default Normal
let phonicsQueue = [];
let currentPhonicsWord = "cat";
let phonicsIndex = 0;
let phonicsTotal = 25;

function setPhonicsDifficulty(val){
  const n = Number(val);
  phonicsChoicesCount = [2,4,6].includes(n) ? n : 4;
  renderPhonicsChoices();
}

function startPhonicsGame(){
  // Use 25 questions (random order). If list grows later, still cap at 25.
  phonicsTotal = Math.min(25, PHONICS_WORDS.length);
  phonicsQueue = shuffle([...PHONICS_WORDS]).slice(0, phonicsTotal);
  phonicsIndex = 0;
  nextPhonics();
}

function restartPhonics(){
  startPhonicsGame();
}

function playCurrentPhonics(){
  // Speak the word (simple, child-friendly). Sound toggle controls audio.
  speak(currentPhonicsWord);
}

function renderPhonicsChoices(){
  const wrap = document.getElementById("phonicsChoices");
  if(!wrap) return;

  const opts = new Set([currentPhonicsWord]);
  while(opts.size < phonicsChoicesCount){
    opts.add(PHONICS_WORDS[Math.floor(Math.random()*PHONICS_WORDS.length)]);
  }
  const options = shuffle([...opts]);

  wrap.innerHTML = "";
  options.forEach(w=>{
    const b = document.createElement("button");
    b.textContent = w.toUpperCase(); // clearer for early readers
    b.classList.add("btnGhost");
    b.onclick = ()=>pickPhonics(w);
    wrap.appendChild(b);
  });

  const btns = wrap.querySelectorAll("button");
  if(btns[0]) btns[0].classList.add("btnPrimary");
}

function updatePhonicsUI(){
  const prog = document.getElementById("phonicsProgress");
  const totalEl = document.getElementById("phonicsTotal");
  if(totalEl) totalEl.textContent = String(phonicsTotal);
  if(prog) prog.textContent = String(Math.max(phonicsIndex,1));

  const badge = document.getElementById("phonicsPromptBadge");
  if(badge) badge.textContent = "Question " + String(Math.max(phonicsIndex,1));
}

function nextPhonics(){
  if(!phonicsQueue.length){
    stars++; save();
    if(document.getElementById('soundToggle')?.checked) playSuccess();
    incStat("sets_phonics");
alert("Great listening! You finished phonics üéâ");
    startPhonicsGame();
    return;
  }
  currentPhonicsWord = phonicsQueue.pop();
  phonicsIndex++;
  updatePhonicsUI();
  renderPhonicsChoices();

  // Auto-play if enabled and sound is on
  if(document.getElementById('phonicsAutoplay')?.checked){
    // small delay so UI updates first
    setTimeout(()=>playCurrentPhonics(), 250);
  }
}

function pickPhonics(w){
  if(w === currentPhonicsWord){
    stars++; save();
    playSuccess();
    setTimeout(nextPhonics, 380);
  } else {
    playError();
  }
}

// --- Maths: add/sub/div/time with choices, auto-advance, professional UI ---
let mathsMode = "choose"; // choose | add | sub | div | time
let mathsDifficulty = "normal";
let mathsQueue = [];
let mathsIndex = 0;
let mathsTotal = 10;
let mathsCorrect = 0;
let currentMaths = null;

// Timing
let timeQueue = [];
let timeIndex = 0;
let timeTotal = 10;
let currentTime = {h:3, m:0};

function setMathsDifficulty(val){
  mathsDifficulty = (val === "easy" || val === "challenge") ? val : "normal";
  // if already in a mode, restart it
  if(mathsMode !== "choose") restartMaths();
}

function setMathsMode(mode){
  mathsMode = mode;
  // tab state
  ["add","sub","div","time"].forEach(m=>{
    const btn = document.getElementById(m==="add"?"tabAdd":m==="sub"?"tabSub":m==="div"?"tabDiv":"tabTime");
    if(btn) btn.classList.toggle("active", m===mode);
  });

  const label = document.getElementById("mathsModeLabel");
  if(label) label.textContent = mode==="add"?"Add":mode==="sub"?"Subtract":mode==="div"?"Divide":mode==="time"?"Timing":"Choose";

  document.getElementById("mathsQA").style.display = (mode==="add"||mode==="sub"||mode==="div") ? "block" : "none";
  document.getElementById("mathsTime").style.display = (mode==="time") ? "block" : "none";

  const hint = document.getElementById("mathsHint");
  if(hint){
    if(mode==="add") hint.textContent = "Solve the addition question.";
    else if(mode==="sub") hint.textContent = "Solve the subtraction question.";
    else if(mode==="div") hint.textContent = "Solve the division question.";
    else if(mode==="time") hint.textContent = "Look at the clock and choose the correct time.";
    else hint.textContent = "Pick a maths activity.";
  }

  if(mode !== "choose") restartMaths();
}

function restartMaths(){
  if(mathsMode === "add" || mathsMode === "sub" || mathsMode === "div"){
    startMathsQA();
  } else if(mathsMode === "time"){
    startTiming();
  }
}

function rangeForDifficulty(){
  // returns [min,max]
  if(mathsDifficulty === "easy") return [0, 10];
  if(mathsDifficulty === "challenge") return [0, 50];
  return [0, 20];
}

function choicesCountForDifficulty(){
  if(mathsDifficulty === "easy") return 2;
  if(mathsDifficulty === "challenge") return 6;
  return 4;
}

function buildMathQuestion(){
  const [min,max] = rangeForDifficulty();
  let a = randInt(min, max);
  let b = randInt(min, max);

  if(mathsMode === "sub"){
    // keep non-negative for primary practice
    if(b > a) [a,b] = [b,a];
    return {a,b,op:"-", ans: a-b};
  }

  if(mathsMode === "div"){
    // make clean divisions: pick divisor and quotient
    const divisor = randInt(2, mathsDifficulty==="challenge" ? 12 : 10);
    const quotient = randInt(1, mathsDifficulty==="easy" ? 10 : (mathsDifficulty==="challenge" ? 12 : 11));
    const dividend = divisor * quotient;
    return {a: dividend, b: divisor, op:"√∑", ans: quotient};
  }

  // add
  return {a,b,op:"+", ans: a+b};
}

function startMathsQA(){
  mathsTotal = 10;
  mathsQueue = [];
  mathsIndex = 0;
  mathsCorrect = 0;
  document.getElementById("mathsCorrect").textContent = "0";
  document.getElementById("mathsTotal").textContent = String(mathsTotal);
  // Build queue of questions
  for(let i=0;i<mathsTotal;i++){
    mathsQueue.push(buildMathQuestion());
  }
  shuffle(mathsQueue);
  nextMathsQA();
}

function updateMathsQAUI(){
  document.getElementById("mathsProgress").textContent = String(mathsIndex);
  document.getElementById("mathsCorrect").textContent = String(mathsCorrect);
}

function renderMathsChoices(){
  const wrap = document.getElementById("mathsChoices");
  if(!wrap) return;
  const nChoices = choicesCountForDifficulty();

  const opts = new Set([currentMaths.ans]);
  // generate plausible distractors near answer
  while(opts.size < nChoices){
    const delta = randInt(-6, 6);
    let v = currentMaths.ans + delta;
    if(mathsMode === "div"){ v = Math.max(0, v); }
    if(v < 0) v = 0;
    opts.add(v);
  }
  const options = shuffle([...opts]);

  wrap.innerHTML = "";
  options.forEach((val)=>{
    const b = document.createElement("button");
    b.textContent = String(val);
    b.classList.add("btnGhost");
    b.onclick = ()=>pickMathsAnswer(val);
    wrap.appendChild(b);
  });
  const btns = wrap.querySelectorAll("button");
  if(btns[0]) btns[0].classList.add("btnPrimary");
}

function nextMathsQA(){
  if(!mathsQueue.length){
    // finished set
    stars++; save();
    if(document.getElementById('soundToggle')?.checked) playSuccess();
    incStat("sets_maths");
alert("Great work! You finished this maths set üéâ");
    startMathsQA();
    return;
  }
  currentMaths = mathsQueue.pop();
  mathsIndex++;
  updateMathsQAUI();
  document.getElementById("mathsQuestion").textContent = `${currentMaths.a} ${currentMaths.op} ${currentMaths.b}`;
  renderMathsChoices();
}

function pickMathsAnswer(val){
  if(val === currentMaths.ans){
    mathsCorrect++;
    stars++; save();
    playSuccess();
    setTimeout(nextMathsQA, 350);
  } else {
    playError();
  }
}

// --- Timing (analogue clock) ---
function startTiming(){
  timeTotal = 10;
  timeQueue = [];
  timeIndex = 0;
  document.getElementById("timeTotal").textContent = String(timeTotal);

  // Choose times: 5-minute steps easy/normal; challenge adds 1-minute steps occasionally
  for(let i=0;i<timeTotal;i++){
    const h = randInt(1,12);
    let m;
    if(mathsDifficulty === "easy") m = [0,15,30,45][randInt(0,3)];
    else if(mathsDifficulty === "challenge") m = (Math.random()<0.35) ? randInt(0,59) : randInt(0,11)*5;
    else m = randInt(0,11)*5;
    timeQueue.push({h,m});
  }
  shuffle(timeQueue);
  nextTime();
}

function pad2(n){ return String(n).padStart(2,"0"); }

function formatTime(t){
  return `${t.h}:${pad2(t.m)}`;
}

function drawClock(t){
  const c = document.getElementById("clock");
  if(!c) return;
  const ctx = c.getContext("2d");
  const w = c.width, h = c.height;
  ctx.clearRect(0,0,w,h);

  const cx = w/2, cy = h/2;
  const r = Math.min(w,h)*0.42;

  // face
  ctx.beginPath();
  ctx.arc(cx, cy, r*1.10, 0, Math.PI*2);
  ctx.fillStyle = "rgba(255,255,255,.98)";
  ctx.fill();
  ctx.strokeStyle = "rgba(15,23,42,.12)";
  ctx.lineWidth = 4;
  ctx.stroke();

  // ticks
  for(let i=0;i<60;i++){
    const ang = (i/60)*Math.PI*2 - Math.PI/2;
    const inner = r*(i%5===0?0.86:0.92);
    const outer = r*0.98;
    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(ang)*inner, cy + Math.sin(ang)*inner);
    ctx.lineTo(cx + Math.cos(ang)*outer, cy + Math.sin(ang)*outer);
    ctx.strokeStyle = (i%5===0) ? "rgba(15,23,42,.28)" : "rgba(15,23,42,.14)";
    ctx.lineWidth = (i%5===0) ? 3 : 2;
    ctx.stroke();
  }

  // numbers
  ctx.fillStyle = "rgba(15,23,42,.78)";
  ctx.font = "700 16px ui-sans-serif, system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  for(let n=1;n<=12;n++){
    const ang = (n/12)*Math.PI*2 - Math.PI/2;
    ctx.fillText(String(n), cx + Math.cos(ang)*r*0.72, cy + Math.sin(ang)*r*0.72);
  }

  // hands
  const minuteAng = (t.m/60)*Math.PI*2 - Math.PI/2;
  const hourAng = ((t.h%12)/12 + (t.m/60)/12)*Math.PI*2 - Math.PI/2;

  // hour
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx + Math.cos(hourAng)*r*0.52, cy + Math.sin(hourAng)*r*0.52);
  ctx.strokeStyle = "rgba(15,23,42,.82)";
  ctx.lineWidth = 7;
  ctx.lineCap = "round";
  ctx.stroke();

  // minute
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx + Math.cos(minuteAng)*r*0.74, cy + Math.sin(minuteAng)*r*0.74);
  ctx.strokeStyle = "rgba(47,128,237,.85)";
  ctx.lineWidth = 5;
  ctx.lineCap = "round";
  ctx.stroke();

  // center dot
  ctx.beginPath();
  ctx.arc(cx, cy, 6, 0, Math.PI*2);
  ctx.fillStyle = "rgba(15,23,42,.80)";
  ctx.fill();
}

function renderTimeChoices(){
  const wrap = document.getElementById("timeChoices");
  if(!wrap) return;

  const nChoices = choicesCountForDifficulty();
  const opts = new Set([formatTime(currentTime)]);

  while(opts.size < nChoices){
    let hh = randInt(1,12);
    let mm;
    if(mathsDifficulty === "easy") mm = [0,15,30,45][randInt(0,3)];
    else if(mathsDifficulty === "challenge") mm = (Math.random()<0.35) ? randInt(0,59) : randInt(0,11)*5;
    else mm = randInt(0,11)*5;
    opts.add(`${hh}:${pad2(mm)}`);
  }

  const options = shuffle([...opts]);
  wrap.innerHTML = "";
  options.forEach(str=>{
    const b = document.createElement("button");
    b.textContent = str;
    b.classList.add("btnGhost");
    b.onclick = ()=>pickTime(str);
    wrap.appendChild(b);
  });
  const btns = wrap.querySelectorAll("button");
  if(btns[0]) btns[0].classList.add("btnPrimary");
}

function nextTime(){
  if(!timeQueue.length){
    stars++; save();
    if(document.getElementById('soundToggle')?.checked) playSuccess();
    incStat("sets_timing");
alert("Amazing! You finished the timing set üéâ");
    startTiming();
    return;
  }
  currentTime = timeQueue.pop();
  timeIndex++;
  document.getElementById("timeProgress").textContent = String(timeIndex);
  drawClock(currentTime);
  renderTimeChoices();
}

function pickTime(str){
  if(str === formatTime(currentTime)){
    stars++; save();
    playSuccess();
    setTimeout(nextTime, 350);
  }else{
    playError();
  }
}

// --- Handwriting: tracing words (30+), guide text, auto-progress on coverage ---
const TRACE_WORDS = [
  // 30+ primary-friendly words (mix of CVC + common sight words)
  "cat","dog","sun","hat","map","pen","cup","bed","fox","run",
  "fish","ship","chop","thin","rain","moon","star","frog","milk","tree",
  "bike","home","book","play","jump","help","kind","brave","smile","thank",
  "school","friend","today","little","happy"
];

let traceLevel = "easy";
let traceQueue = [];
let traceIndex = 0;
let traceTotal = 30;
let currentTraceWord = "cat";

// tracing state
let traceCanvas, traceCtx;
let traceDrawing = false;
let traceLast = null;

// A small grid to estimate coverage (for auto-advance)
const GRID = {cols: 36, rows: 12};
let traceGrid = [];

function setTraceLevel(val){
  traceLevel = (val === "normal" || val === "challenge") ? val : "easy";
  restartTrace();
}

function restartTrace(){
  traceTotal = 30;
  traceQueue = shuffle([...TRACE_WORDS]).slice(0, Math.min(traceTotal, TRACE_WORDS.length));
  traceIndex = 0;
  nextTraceWord(true);
}

function speakTraceWord(){
  speak(currentTraceWord);
}

function initTrace(){
  traceCanvas = document.getElementById("trace");
  if(!traceCanvas) return;
  traceCtx = traceCanvas.getContext("2d");

  const start = (x,y)=>{
    traceDrawing = true;
    traceLast = {x,y};
  };
  const end = ()=>{
    traceDrawing = false;
    traceLast = null;
  };
  const move = (x,y)=>{
    if(!traceDrawing) return;
    drawTraceStroke(traceLast.x, traceLast.y, x, y);
    traceLast = {x,y};
  };

  // Mouse
  traceCanvas.addEventListener("mousedown", (e)=>start(e.offsetX, e.offsetY));
  window.addEventListener("mouseup", end);
  traceCanvas.addEventListener("mousemove", (e)=>move(e.offsetX, e.offsetY));

  // Touch (tablets)
  traceCanvas.addEventListener("touchstart", (e)=>{
    e.preventDefault();
    const p = touchPoint(e);
    start(p.x, p.y);
  }, {passive:false});
  traceCanvas.addEventListener("touchend", (e)=>{ e.preventDefault(); end(); }, {passive:false});
  traceCanvas.addEventListener("touchmove", (e)=>{
    e.preventDefault();
    const p = touchPoint(e);
    move(p.x, p.y);
  }, {passive:false});

  drawTraceGuide();
}

function touchPoint(e){
  const rect = traceCanvas.getBoundingClientRect();
  const t = e.touches[0];
  return {
    x: (t.clientX - rect.left) * (traceCanvas.width / rect.width),
    y: (t.clientY - rect.top) * (traceCanvas.height / rect.height)
  };
}

function resetTraceInk(){
  // keep guide, clear ink layer by redrawing guide
  drawTraceGuide();
  resetCoverageGrid();
}

function resetCoverageGrid(){
  traceGrid = Array.from({length: GRID.cols*GRID.rows}, ()=>0);
}

function markCoverage(x,y){
  const col = Math.max(0, Math.min(GRID.cols-1, Math.floor((x/traceCanvas.width)*GRID.cols)));
  const row = Math.max(0, Math.min(GRID.rows-1, Math.floor((y/traceCanvas.height)*GRID.rows)));
  traceGrid[row*GRID.cols + col] = 1;
}

function coverageRatio(){
  const filled = traceGrid.reduce((a,b)=>a+b,0);
  return filled / (GRID.cols*GRID.rows);
}

function drawTraceStroke(x1,y1,x2,y2){
  const w = traceLevel === "easy" ? 10 : (traceLevel === "challenge" ? 6 : 8);

  traceCtx.lineWidth = w;
  traceCtx.lineCap = "round";
  traceCtx.lineJoin = "round";
  traceCtx.strokeStyle = "rgba(47,128,237,.92)";
  traceCtx.beginPath();
  traceCtx.moveTo(x1,y1);
  traceCtx.lineTo(x2,y2);
  traceCtx.stroke();

  // update coverage along segment (sample points)
  const steps = 8;
  for(let i=0;i<=steps;i++){
    const x = x1 + (x2-x1)*(i/steps);
    const y = y1 + (y2-y1)*(i/steps);
    markCoverage(x,y);
  }

  // Auto-advance threshold: easier requires less, challenge more
  const thresh = traceLevel === "easy" ? 0.14 : (traceLevel === "challenge" ? 0.22 : 0.18);
  if(coverageRatio() >= thresh){
    // finish feedback once, then advance
    playSuccess();
    setTimeout(()=>nextTraceWord(false), 420);
  }
}

function drawTraceGuide(){
  if(!traceCtx) return;
  const w = traceCanvas.width, h = traceCanvas.height;
  traceCtx.clearRect(0,0,w,h);

  // background guide lines
  traceCtx.strokeStyle = "rgba(15,23,42,.10)";
  traceCtx.lineWidth = 2;
  const baseline = h*0.68;
  const midline = h*0.42;
  const top = h*0.24;

  [top, midline, baseline].forEach((yy)=>{
    traceCtx.beginPath();
    traceCtx.moveTo(w*0.06, yy);
    traceCtx.lineTo(w*0.94, yy);
    traceCtx.stroke();
  });

  // dotted guide word
  const fontSize = traceLevel === "easy" ? 110 : (traceLevel === "challenge" ? 90 : 100);
  traceCtx.font = `900 ${fontSize}px ui-sans-serif, system-ui`;
  traceCtx.textAlign = "center";
  traceCtx.textBaseline = "alphabetic";

  // guide style: dotted by using dashed stroke on text path approximation (simple: stroke + low alpha)
  traceCtx.lineWidth = 4;
  traceCtx.setLineDash([7,7]);
  traceCtx.strokeStyle = "rgba(15,23,42,.22)";
  traceCtx.strokeText(currentTraceWord.toLowerCase(), w/2, baseline);
  traceCtx.setLineDash([]);

  // faint fill for readability
  traceCtx.fillStyle = "rgba(15,23,42,.06)";
  traceCtx.fillText(currentTraceWord.toLowerCase(), w/2, baseline);

  resetCoverageGrid();
}

function updateTraceUI(){
  const prog = document.getElementById("traceProgress");
  const total = document.getElementById("traceTotal");
  const badge = document.getElementById("traceWordBadge");
  if(total) total.textContent = String(traceTotal);
  if(prog) prog.textContent = String(Math.max(traceIndex,1));
  if(badge) badge.textContent = currentTraceWord;
}

function nextTraceWord(forceAdvance){
  if(forceAdvance !== true){
    // when auto-advancing after coverage, don't double increment if already moving
  }

  if(!traceQueue.length){
    stars++; save();
    playSuccess();
    incStat("sets_tracing");
alert("Great tracing! You finished the handwriting set üéâ");
    restartTrace();
    return;
  }
  currentTraceWord = traceQueue.pop();
  traceIndex++;
  updateTraceUI();
  drawTraceGuide();

  // Speak the word if sound is on (gentle)
  if(document.getElementById('soundToggle')?.checked){
    setTimeout(()=>speakTraceWord(), 250);
  }
}

// --- Progress stats helpers ---
function getStat(key){
  return Number(localStorage.getItem(key) || 0);
}
function incStat(key, by=1){
  const v = getStat(key) + by;
  localStorage.setItem(key, String(v));
  return v;
}
function setStat(key, val){
  localStorage.setItem(key, String(Number(val)||0));
}
function refreshProgress(){
  const starsEl = document.getElementById("starsCount");
  if(starsEl) starsEl.textContent = String(stars);

  const counts = {
    letters: getStat("sets_letters"),
    numbers: getStat("sets_numbers"),
    memory: getStat("sets_memory"),
    phonics: getStat("sets_phonics"),
    maths: getStat("sets_maths"),
    timing: getStat("sets_timing"),
    tracing: getStat("sets_tracing"),
  };

  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  const totalEl = document.getElementById("setsTotal");
  if(totalEl) totalEl.textContent = String(total);

  const maxVal = Math.max(1, ...Object.values(counts));
  const map = [
    ["Letters","letters"],
    ["Numbers","numbers"],
    ["Memory","memory"],
    ["Phonics","phonics"],
    ["Maths","maths"],
    ["Timing","timing"],
    ["Tracing","tracing"],
  ];
  map.forEach(([Label,key])=>{
    const val = counts[key];
    const valEl = document.getElementById("val"+Label);
    if(valEl) valEl.textContent = String(val);
    const barEl = document.getElementById("bar"+Label);
    if(barEl){
      const pct = Math.round((val / maxVal) * 100);
      barEl.style.width = pct + "%";
    }
  });
}

function resetProgressConfirm(){
  if(!confirm("Reset stars and progress on this device?")) return;
  stars = 0; save();
  ["sets_letters","sets_numbers","sets_memory","sets_phonics","sets_maths","sets_timing","sets_tracing"].forEach(k=>setStat(k,0));
  refreshProgress();
}
</script>

</body>
</html>
