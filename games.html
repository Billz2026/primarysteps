<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Game ‚Ä¢ Primary Steps</title>
<link rel="icon" href="assets/primary-steps-icon-512.png" />
<style>
  :root{
    --bg0:#0b0d12; --bg1:#0f1320;
    --panel:#121621; --panel2:#0d1c36;
    --text:#eef2ff; --muted:rgba(238,242,255,.72);
    --line:rgba(255,255,255,.12);
    --accent:#7dd3fc; --accent2:#a78bfa; --good:#34d399; --bad:#fb7185;
    --ring:rgba(125,211,252,.30);
    --shadow:0 18px 40px rgba(0,0,0,.35);
    --r:18px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 700px at 20% 10%, rgba(125,211,252,.18), transparent 55%),
      radial-gradient(900px 600px at 80% 0%, rgba(167,139,250,.16), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    min-height:100vh;
  }
  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(10px);
    background: rgba(18,22,33,.72);
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1100px;margin:0 auto;padding:14px 16px;}
  .top{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  .brand{display:flex; align-items:center; gap:10px; min-width:0; text-decoration:none; color:var(--text);}
  .brand img{height:52px;width:auto;display:block; filter: drop-shadow(0 16px 30px rgba(125,211,252,.10));}
  .brand .title{font-weight:850; letter-spacing:.2px; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .brand .sub{display:block; font-size:12px; color:var(--muted); margin-top:2px}
  nav{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
  nav a{
    color:var(--text); text-decoration:none; font-weight:700; font-size:13px;
    padding:8px 10px; border-radius:12px;
    border:1px solid transparent; opacity:.92;
  }
  nav a:hover{border-color:var(--line); background:rgba(255,255,255,.04); opacity:1;}
  nav a.active{border-color:rgba(125,211,252,.35); background:rgba(125,211,252,.10); opacity:1;}

  .hero{padding:22px 16px 10px;}
  .hwrap{max-width:1100px;margin:0 auto;}
  h1{margin:0 0 6px; font-size:28px; letter-spacing:-.4px;}
  p.lead{margin:0; color:var(--muted); max-width:85ch; font-size:14px; line-height:1.45;}

  .grid{
    max-width:1100px; margin:14px auto 28px; padding:0 16px;
    display:grid; grid-template-columns: 1fr; gap:14px;
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:var(--r);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card .head{
    padding:14px 14px 10px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    flex-wrap:wrap;
  }
  .pill{
    font-size:12px; font-weight:850;
    padding:6px 10px; border-radius:999px;
    background: rgba(125,211,252,.14);
    border:1px solid rgba(125,211,252,.25);
    color: var(--text);
    white-space:nowrap;
  }
  .body{padding:14px;}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .btn{
    appearance:none; border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    color:var(--text); font-weight:850;
    padding:10px 12px; border-radius:14px;
    cursor:pointer;
    text-decoration:none;
    display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{background: rgba(255,255,255,.08);}
  .btn.primary{
    border-color: rgba(125,211,252,.35);
    background: linear-gradient(180deg, rgba(125,211,252,.18), rgba(125,211,252,.07));
  }
  .btn.good{
    border-color: rgba(52,211,153,.35);
    background: linear-gradient(180deg, rgba(52,211,153,.18), rgba(52,211,153,.06));
  }

  .field{display:flex; flex-direction:column; gap:6px; min-width:220px;}
  label{font-size:12px; color:var(--muted); font-weight:800; letter-spacing:.02em;}
  select{
    width:100%;
    appearance:none;
    border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    font-weight:800;
    cursor:pointer;
    outline:none;
  }
  select:focus{box-shadow: 0 0 0 6px var(--ring);}

  .msg{
    padding:10px 12px; border-radius:14px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color: var(--muted);
    margin-top:10px;
  }
  .msg.good{border-color:rgba(52,211,153,.35); background: rgba(52,211,153,.10); color: rgba(238,242,255,.92);}
  .msg.bad{border-color:rgba(251,113,133,.35); background: rgba(251,113,133,.10); color: rgba(238,242,255,.92);}

  /* Game stage */
  .stage{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
    background:
      radial-gradient(900px 500px at 10% 0%, rgba(125,211,252,.10), transparent 60%),
      linear-gradient(180deg, rgba(13,28,54,.65), rgba(13,28,54,.35));
  }

  /* --- CONNECT 4 --- */
  .c4Wrap{display:grid; gap:12px; justify-items:center;}
  .c4Board{
    width:min(420px, 100%);
    aspect-ratio: 7 / 6;
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap:10px;
    padding:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
  }
  .c4Cell{
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .c4Disc{
    width:100%; height:100%;
    border-radius:999px;
    transform: scale(.82);
    background: rgba(255,255,255,.06);
    box-shadow: inset 0 10px 20px rgba(0,0,0,.28);
  }
  .c4Disc.r{ background: rgba(251,113,133,.70); }
  .c4Disc.y{ background: rgba(253,224,71,.65); }
  .c4Top{
    width:min(420px, 100%);
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:10px;
  }
  .c4Top button{
    height:42px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.04);
    color:var(--text);
    font-weight:950;
    cursor:pointer;
  }
  .c4Top button:hover{background: rgba(255,255,255,.07);}
  .seg{
    display:flex; gap:8px; flex-wrap:wrap;
    padding:6px; border:1px solid var(--line);
    border-radius:16px; background:rgba(255,255,255,.03);
  }
  .seg button{border-radius:12px; padding:9px 12px;}
  .seg button.on{border-color:rgba(125,211,252,.45); background:rgba(125,211,252,.12);}

  /* --- SHAPE SORT + COIN GAME SHARED --- */
  .shapeWrap{display:grid; gap:12px;}
  .bins{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;}
  @media (max-width: 560px){ .bins{grid-template-columns:1fr;} .brand .title{display:none;} }
  .bin{
    border:1px dashed rgba(238,242,255,.22);
    border-radius:16px;
    padding:12px;
    min-height:120px;
    display:flex; flex-direction:column; gap:10px;
    background: rgba(0,0,0,.10);
  }
  .binTitle{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .binTitle strong{font-size:13px; font-weight:950;}
  .binTitle .mini{font-size:12px; color:var(--muted); font-weight:900;}
  .dropArea{
    flex:1;
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    display:flex; align-items:center; justify-content:center;
    background: rgba(255,255,255,.04);
  }
  .tray{
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:12px;
    background: rgba(0,0,0,.10);
  }
  .shapes{display:flex; gap:10px; flex-wrap:wrap;}
  .shape{
    width:56px; height:56px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    display:flex; align-items:center; justify-content:center;
    cursor:grab;
    user-select:none;
    touch-action:none;
  }
  .shape:active{cursor:grabbing;}
  .shape svg{width:34px; height:34px; display:block;}
  .bin.over{outline: 2px solid rgba(125,211,252,.45); outline-offset: 2px;}

  .choices{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px;}
  @media (max-width: 560px){ .choices{grid-template-columns:1fr;} }
  .choice{
    border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    border-radius:16px;
    padding:12px;
    cursor:pointer;
    user-select:none;
    text-align:left;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-weight:950;
    color:var(--text);
  }
  .choice:hover{background: rgba(255,255,255,.08);}
  .tag{
    font-size:12px; font-weight:950;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    color: var(--muted);
    background: rgba(0,0,0,.10);
    white-space:nowrap;
  }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="top">
      <a class="brand" href="index.html" aria-label="Primary Steps home">
        <img src="assets/primary-steps-logo.png" alt="Primary Steps logo" onerror="this.style.display='none'">
        <div>
          <div class="title">Primary Steps</div>
          <span class="sub">Simple, calm learning activities</span>
        </div>
      </a>
      <nav aria-label="Primary">
        <a href="games.html" class="active">Back to Games</a>
        <a href="numbers.html">Numbers</a>
        <a href="letters.html">Letters</a>
      </nav>
    </div>
  </div>
</header>

<section class="hero">
  <div class="hwrap">
    <h1 id="pageTitle">Game</h1>
    <p class="lead">Use <strong>New</strong> to start a fresh round. Difficulty applies to the coin + shape games.</p>
  </div>
</section>

<section class="grid">
  <div class="card" aria-label="Game player">
    <div class="head">
      <div class="pill" id="gamePill">Loading‚Ä¶</div>
      <div class="row">
        <div class="field">
          <label for="difficulty">Difficulty</label>
          <select id="difficulty">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
        <button class="btn" id="soundBtn" type="button" aria-pressed="false">Sound: Off</button>
        <button class="btn primary" id="newBtn" type="button">New</button>
        <button class="btn" id="resetBtn" type="button">Reset</button>
      </div>
    </div>
    <div class="body">
      <div class="stage" id="stage"></div>
      <div class="msg" id="message">Press <strong>New</strong> to start.</div>
    </div>
  </div>
</section>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const ui = {
    stage:$('stage'),
    msg:$('message'),
    pill:$('gamePill'),
    difficulty:$('difficulty'),
    newBtn:$('newBtn'),
    resetBtn:$('resetBtn'),
    soundBtn:$('soundBtn'),
    pageTitle:$('pageTitle')
  };

  // Sound
  let soundOn = false, audioCtx = null;
  function beep(freq=700, ms=70, gain=0.03){
    if(!soundOn) return;
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(), ms);
  }
  function setMsg(type, html){
    ui.msg.className = 'msg' + (type ? ' ' + type : '');
    ui.msg.innerHTML = html;
  }

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
  function formatMoney(pence){
    if(pence >= 100){
      const pounds = Math.floor(pence/100);
      const p = pence % 100;
      return "¬£" + pounds + (p ? ("." + String(p).padStart(2,'0')) : "");
    }
    return pence + "p";
  }
  function markPick(container, pickIndex){
    [...container.children].forEach((el,i)=>{
      el.style.borderColor = (i===pickIndex) ? 'rgba(125,211,252,.50)' : 'rgba(255,255,255,.12)';
      el.style.background = (i===pickIndex) ? 'rgba(125,211,252,.10)' : 'rgba(255,255,255,.05)';
    });
  }

  function coinSvg(c){
    const fill = c.col==='copper' ? 'rgba(251,113,133,.55)' : c.col==='gold' ? 'rgba(253,224,71,.50)' : 'rgba(238,242,255,.22)';
    const stroke = 'rgba(238,242,255,.28)';
    const txt = c.label;
    return `
      <circle cx="0" cy="0" r="22" fill="${fill}" stroke="${stroke}" stroke-width="2"/>
      <circle cx="0" cy="0" r="18" fill="rgba(0,0,0,.10)" stroke="rgba(255,255,255,.12)" stroke-width="1.5"/>
      <text x="0" y="6" text-anchor="middle" font-size="12" font-weight="950" fill="rgba(238,242,255,.92)">${txt}</text>
    `;
  }

  function pigSvg(){
    return `
    <svg viewBox="0 0 520 320" width="100%" height="auto" aria-label="Piggy bank">
      <defs>
        <linearGradient id="pigBody" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="rgba(167,139,250,.35)"/>
          <stop offset="45%" stop-color="rgba(251,113,133,.32)"/>
          <stop offset="100%" stop-color="rgba(125,211,252,.18)"/>
        </linearGradient>
        <linearGradient id="pigPink" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="rgba(251,113,133,.70)"/>
          <stop offset="100%" stop-color="rgba(251,113,133,.45)"/>
        </linearGradient>
        <filter id="softShadow" x="-40%" y="-40%" width="180%" height="180%">
          <feDropShadow dx="0" dy="10" stdDeviation="10" flood-color="rgba(0,0,0,.35)"/>
        </filter>
      </defs>

      <ellipse cx="270" cy="280" rx="170" ry="20" fill="rgba(0,0,0,.25)"/>

      <g filter="url(#softShadow)">
        <path d="M140 210
                 C105 185 102 140 128 112
                 C165 70 240 52 318 64
                 C376 73 420 108 434 148
                 C452 200 418 246 360 258
                 C295 271 205 260 140 210Z"
              fill="url(#pigPink)" stroke="rgba(238,242,255,.18)" stroke-width="2"/>
        <ellipse cx="265" cy="170" rx="150" ry="92" fill="url(#pigBody)" opacity="0.9"/>
        <path d="M178 96 C168 70 184 56 212 64 C206 88 196 103 178 96Z"
              fill="rgba(251,113,133,.55)" stroke="rgba(238,242,255,.16)" stroke-width="2"/>
        <ellipse cx="414" cy="178" rx="44" ry="34" fill="rgba(251,113,133,.55)"
                 stroke="rgba(238,242,255,.16)" stroke-width="2"/>
        <ellipse cx="404" cy="182" rx="7" ry="10" fill="rgba(0,0,0,.22)"/>
        <ellipse cx="423" cy="182" rx="7" ry="10" fill="rgba(0,0,0,.22)"/>
        <circle cx="372" cy="148" r="9" fill="rgba(238,242,255,.85)"/>
        <circle cx="374" cy="150" r="4.5" fill="rgba(0,0,0,.45)"/>
        <rect x="250" y="72" width="78" height="14" rx="7" fill="rgba(0,0,0,.35)" opacity="0.55"/>
        <rect x="250" y="72" width="78" height="14" rx="7" fill="rgba(238,242,255,.12)" opacity="0.35"/>
        <path d="M190 238 C182 270 198 285 224 282 C232 262 225 242 214 234Z"
              fill="rgba(251,113,133,.55)" stroke="rgba(238,242,255,.14)" stroke-width="2"/>
        <path d="M300 252 C292 282 310 296 336 294 C346 274 338 252 326 246Z"
              fill="rgba(251,113,133,.55)" stroke="rgba(238,242,255,.14)" stroke-width="2"/>
        <path d="M118 166 C86 150 82 120 110 112 C124 108 134 120 126 132
                 C120 140 110 136 108 144 C106 152 118 154 124 154"
              fill="none" stroke="rgba(238,242,255,.35)" stroke-width="6" stroke-linecap="round"/>
        <g id="coinLayer"></g>
      </g>
    </svg>`;
  }

  function coinPool(difficulty){
    const base = [
      {v:1, label:'1p', col:'copper'},
      {v:2, label:'2p', col:'copper'},
      {v:5, label:'5p', col:'silver'},
      {v:10, label:'10p', col:'silver'}
    ];
    const mid = base.concat([
      {v:20, label:'20p', col:'silver'},
      {v:50, label:'50p', col:'silver'}
    ]);
    const hard = mid.concat([
      {v:100, label:'¬£1', col:'gold'},
      {v:200, label:'¬£2', col:'gold'}
    ]);
    return difficulty==='easy' ? base : difficulty==='medium' ? mid : hard;
  }
  function potLabels(difficulty){ return coinPool(difficulty).map(c=>({label:c.label, v:c.v})); }
  function potIcon(){ return `<div style="width:44px;height:34px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05)"></div>`; }
  function coinTile(c, big=false){
    const fill = c.col==='copper' ? 'rgba(251,113,133,.55)' : c.col==='gold' ? 'rgba(253,224,71,.50)' : 'rgba(238,242,255,.22)';
    const stroke = 'rgba(238,242,255,.28)';
    const size = big ? 26 : 24;
    return `
      <svg viewBox="-30 -30 60 60" width="${big?52:46}" height="${big?52:46}" aria-hidden="true">
        <circle cx="0" cy="0" r="${size}" fill="${fill}" stroke="${stroke}" stroke-width="2"/>
        <circle cx="0" cy="0" r="${size-4}" fill="rgba(0,0,0,.10)" stroke="rgba(255,255,255,.12)" stroke-width="1.5"/>
        <text x="0" y="6" text-anchor="middle" font-size="12" font-weight="950" fill="rgba(238,242,255,.92)">${c.label}</text>
      </svg>`;
  }

  function shapeIcon(type){
    if(type==='circle') return `<svg viewBox="0 0 48 48" aria-hidden="true"><circle cx="24" cy="24" r="16" fill="rgba(125,211,252,.25)" stroke="rgba(255,255,255,.35)" stroke-width="2"/></svg>`;
    if(type==='square') return `<svg viewBox="0 0 48 48" aria-hidden="true"><rect x="10" y="10" width="28" height="28" rx="6" fill="rgba(167,139,250,.25)" stroke="rgba(255,255,255,.35)" stroke-width="2"/></svg>`;
    return `<svg viewBox="0 0 48 48" aria-hidden="true"><path d="M24 10 L38 36 H10 Z" fill="rgba(52,211,153,.25)" stroke="rgba(255,255,255,.35)" stroke-width="2"/></svg>`;
  }
  function binIcon(type){
    if(type==='circle') return `<svg viewBox="0 0 48 48" aria-hidden="true" style="opacity:.6"><circle cx="24" cy="24" r="16" fill="none" stroke="rgba(238,242,255,.35)" stroke-width="2"/></svg>`;
    if(type==='square') return `<svg viewBox="0 0 48 48" aria-hidden="true" style="opacity:.6"><rect x="10" y="10" width="28" height="28" rx="6" fill="none" stroke="rgba(238,242,255,.35)" stroke-width="2"/></svg>`;
    return `<svg viewBox="0 0 48 48" aria-hidden="true" style="opacity:.6"><path d="M24 10 L38 36 H10 Z" fill="none" stroke="rgba(238,242,255,.35)" stroke-width="2"/></svg>`;
  }

  // ---- Games (same logic as your current games.html, just hosted on this page) ----
  const GAMES = [
    {
      key:'connect4',
      name:'Connect 4',
      buildState: ()=>({ mode:'two', turn:'r', grid:Array.from({length:6}, ()=>Array(7).fill('')), winner:'' }),
      render: (st)=> {
        ui.pill.textContent = 'Connect 4';
        ui.pageTitle.textContent = 'Connect 4';
        ui.stage.innerHTML = `
          <div class="c4Wrap">
            <div class="row" style="justify-content:center;">
              <div class="seg" role="tablist" aria-label="Connect 4 modes">
                <button class="btn ${st.mode==='two'?'on':''}" id="c4Two" type="button">2-Player</button>
                <button class="btn ${st.mode==='practice'?'on':''}" id="c4Practice" type="button">Practice</button>
              </div>
              <span class="pill" id="c4Turn">Turn: ${st.turn === 'r' ? 'Red' : 'Yellow'}</span>
            </div>

            <div class="c4Top" aria-label="Choose a column">
              ${Array.from({length:7}, (_,c)=>`<button type="button" data-col="${c}">‚Üì</button>`).join('')}
            </div>

            <div class="c4Board" aria-label="Connect 4 board">
              ${st.grid.flatMap((row,r)=>row.map((cell,c)=>`
                <div class="c4Cell" data-col="${c}" data-row="${r}">
                  <div class="c4Disc ${cell}"></div>
                </div>
              `)).join('')}
            </div>

            <div style="font-size:12px;color:rgba(238,242,255,.72);text-align:center;">Tap a column arrow to drop a disc.</div>
          </div>
        `;

        ui.stage.querySelector('#c4Two').addEventListener('click', ()=>{ st.mode='two'; st.winner=''; st.turn='r'; beep(640,50,0.02); render(); });
        ui.stage.querySelector('#c4Practice').addEventListener('click', ()=>{ st.mode='practice'; st.winner=''; st.turn='r'; beep(640,50,0.02); render(); });
        ui.stage.querySelectorAll('.c4Top button').forEach(btn=>{
          btn.addEventListener('click', ()=> dropInCol(Number(btn.dataset.col)));
        });

        function dropInCol(col){
          if(st.winner) return;
          for(let r=5;r>=0;r--){
            if(!st.grid[r][col]){
              st.grid[r][col] = st.turn;
              beep(520,40,0.02);
              const w = checkWinner(st.grid);
              if(w){
                st.winner = w;
                setMsg('good', `‚úÖ ${w === 'r' ? 'Red' : 'Yellow'} wins! Press <strong>New</strong> to play again.`);
                beep(880,90,0.04);
              } else if(isFull(st.grid)){
                setMsg('', `It‚Äôs a draw. Press <strong>New</strong> to try again.`);
              } else {
                if(st.mode === 'two') st.turn = (st.turn === 'r') ? 'y' : 'r';
              }
              render(false);
              return;
            }
          }
          beep(220,100,0.05);
        }
        function isFull(g){ return g.every(row=>row.every(Boolean)); }
        function checkWinner(g){
          const H=6, W=7;
          const dirs = [[1,0],[0,1],[1,1],[1,-1]];
          for(let r=0;r<H;r++){
            for(let c=0;c<W;c++){
              const v=g[r][c]; if(!v) continue;
              for(const [dr,dc] of dirs){
                let ok=true;
                for(let k=1;k<4;k++){
                  const rr=r+dr*k, cc=c+dc*k;
                  if(rr<0||rr>=H||cc<0||cc>=W||g[rr][cc]!==v){ ok=false; break; }
                }
                if(ok) return v;
              }
            }
          }
          return '';
        }
      },
      newRound: (st)=>{ st.grid = Array.from({length:6}, ()=>Array(7).fill('')); st.turn='r'; st.winner=''; setMsg('', `Connect 4: tap a column arrow to drop a disc.`); },
      reset:   (st)=>{ st.grid = Array.from({length:6}, ()=>Array(7).fill('')); st.turn='r'; st.winner=''; setMsg('', `Board reset.`); }
    },

    {
      key:'shapesort',
      name:'Shape Sort',
      buildState: ()=>({ placed:0, total:0, shapes:[] }),
      render: (st, difficulty)=> {
        ui.pill.textContent = 'Shape Sort';
        ui.pageTitle.textContent = 'Shape Sort';
        ui.stage.innerHTML = `
          <div class="shapeWrap">
            <div class="bins">
              ${['circle','square','triangle'].map(t=>`
                <div class="bin" data-bin="${t}">
                  <div class="binTitle">
                    <strong>${t[0].toUpperCase()+t.slice(1)}</strong>
                    <span class="mini">Drop here</span>
                  </div>
                  <div class="dropArea">${binIcon(t)}</div>
                </div>
              `).join('')}
            </div>

            <div class="tray">
              <div class="row" style="justify-content:space-between;">
                <strong style="font-size:14px;font-weight:950;">Shape Tray</strong>
                <span class="pill" id="ssCount">${st.placed} / ${st.total}</span>
              </div>
              <div class="shapes" id="ssShapes" style="margin-top:10px;"></div>
              <div style="font-size:12px;color:rgba(238,242,255,.72);margin-top:8px;">Drag shapes into the matching bin (touch: tap a shape, then tap a bin).</div>
            </div>
          </div>
        `;

        const shapesEl = ui.stage.querySelector('#ssShapes');
        st.shapes.forEach(s=>{
          const el = document.createElement('div');
          el.className='shape';
          el.draggable = true;
          el.dataset.id = s.id;
          el.dataset.type = s.type;
          el.innerHTML = shapeIcon(s.type);
          el.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', s.id); beep(520,40,0.02); });
          el.addEventListener('pointerdown', (e)=>{
            if(e.pointerType === 'touch'){
              st._picked = s.id;
              setMsg('', `Now tap the correct bin for the picked shape.`);
              beep(640,40,0.02);
            }
          });
          shapesEl.appendChild(el);
        });

        ui.stage.querySelectorAll('.bin').forEach(bin=>{
          const type = bin.dataset.bin;
          bin.addEventListener('dragover', (e)=>{ e.preventDefault(); bin.classList.add('over'); });
          bin.addEventListener('dragleave', ()=> bin.classList.remove('over'));
          bin.addEventListener('drop', (e)=>{
            e.preventDefault(); bin.classList.remove('over');
            const id = e.dataTransfer.getData('text/plain');
            place(id, type);
          });
          bin.addEventListener('click', ()=>{
            if(st._picked){
              place(st._picked, type);
              st._picked = null;
            }
          });
        });

        function place(id, binType){
          const idx = st.shapes.findIndex(x=>x.id===id);
          if(idx === -1) return;
          const s = st.shapes[idx];
          if(s.type !== binType){
            setMsg('bad', `Not quite ‚Äî that shape goes in <strong>${s.type[0].toUpperCase()+s.type.slice(1)}</strong>.`);
            beep(220,120,0.05);
            return;
          }
          st.shapes.splice(idx,1);
          st.placed++;
          ui.stage.querySelector('#ssCount').textContent = `${st.placed} / ${st.total}`;
          setMsg('good', `‚úÖ Nice! Keep going.`);
          beep(880,80,0.04);

          shapesEl.innerHTML = '';
          st.shapes.forEach(s2=>{
            const el = document.createElement('div');
            el.className='shape';
            el.draggable = true;
            el.dataset.id = s2.id;
            el.dataset.type = s2.type;
            el.innerHTML = shapeIcon(s2.type);
            el.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', s2.id); beep(520,40,0.02); });
            el.addEventListener('pointerdown', (e)=>{
              if(e.pointerType === 'touch'){
                st._picked = s2.id;
                setMsg('', `Now tap the correct bin for the picked shape.`);
                beep(640,40,0.02);
              }
            });
            shapesEl.appendChild(el);
          });

          if(st.shapes.length === 0){
            setMsg('good', `üéâ All sorted! Press <strong>New</strong> for another round.`);
          }
        }
      },
      newRound: (st, difficulty)=> {
        const counts = {easy:6, medium:10, hard:14};
        const total = counts[difficulty] || 10;
        const types = ['circle','square','triangle'];
        st.total = total;
        st.placed = 0;
        st.shapes = Array.from({length:total}, (_,i)=>({
          id: 's' + Math.random().toString(16).slice(2) + i,
          type: types[Math.floor(Math.random()*types.length)]
        }));
        setMsg('', `Shape Sort: drag each shape into the matching bin.`);
      },
      reset: (st, difficulty)=> { GAMES.find(g=>g.key==='shapesort').newRound(st, difficulty); setMsg('', `Reset done. Start again.`); }
    },

    {
      key:'coins',
      name:'Coin Piggy Bank',
      buildState: ()=>({
        mode:'count',
        coins:[], total:0, options:[], pick:null, done:false,
        placed:0, picked:null,
        orderIds:[], selectedIdx:null
      }),
      render: (st, difficulty)=> {
        ui.pill.textContent = 'Coin Piggy Bank';
        ui.pageTitle.textContent = 'Coin Piggy Bank';
        ui.stage.innerHTML = `
          <div style="display:grid; gap:12px; justify-items:center;">
            <div class="row" style="justify-content:center;">
              <div class="seg" role="tablist" aria-label="Coin game modes">
                <button class="btn ${st.mode==='count'?'on':''}" id="cgCount" type="button">Count</button>
                <button class="btn ${st.mode==='sort'?'on':''}" id="cgSort" type="button">Sort</button>
                <button class="btn ${st.mode==='order'?'on':''}" id="cgOrder" type="button">Order</button>
              </div>
              <span class="pill">UK coins ‚Ä¢ ${difficulty[0].toUpperCase()+difficulty.slice(1)}</span>
            </div>

            <div style="width:min(520px,100%);">
              ${pigSvg()}
              <div style="margin-top:-18px; padding:0 10px;">
                <div style="font-size:12px;color:rgba(238,242,255,.72);text-align:center;" id="cgHint"></div>
              </div>
            </div>

            <div style="width:min(520px,100%);" id="cgPanel"></div>
          </div>
        `;

        ui.stage.querySelector('#cgCount').addEventListener('click', ()=>{ st.mode='count'; beep(640,50,0.02); renderCoinsGame(); });
        ui.stage.querySelector('#cgSort').addEventListener('click', ()=>{ st.mode='sort'; beep(640,50,0.02); renderCoinsGame(); });
        ui.stage.querySelector('#cgOrder').addEventListener('click', ()=>{ st.mode='order'; beep(640,50,0.02); renderCoinsGame(); });

        function renderCoinsGame(){
          const coinLayer = ui.stage.querySelector('#coinLayer');
          coinLayer.innerHTML = '';
          st.coins.forEach((c,i)=>{
            const el = document.createElementNS('http://www.w3.org/2000/svg','g');
            const cols = 5;
            const x = 110 + (i%cols)*62 + (Math.random()*10-5);
            const y = 160 + Math.floor(i/cols)*50 + (Math.random()*10-5);
            el.setAttribute('transform', `translate(${x} ${y}) rotate(${(Math.random()*10-5).toFixed(1)})`);
            el.innerHTML = coinSvg(c);
            coinLayer.appendChild(el);
          });

          const panel = ui.stage.querySelector('#cgPanel');
          const hint = ui.stage.querySelector('#cgHint');

          if(st.mode === 'count'){
            hint.innerHTML = `Count the coins in the pig, then tap the total.`;
            panel.innerHTML = `
              <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                <strong style="font-size:14px;font-weight:950;">Choose the total</strong>
                <span style="font-size:12px;color:rgba(238,242,255,.72);">Tap an answer</span>
              </div>
              <div class="choices" id="coinChoices"></div>
              <div class="row" style="justify-content:flex-start; margin-top:10px;">
                <button class="btn" id="cgShow" type="button">Show Answer</button>
              </div>
            `;
            const box = panel.querySelector('#coinChoices');
            box.innerHTML = '';
            st.options.forEach((opt, i)=>{
              const b = document.createElement('button');
              b.type='button';
              b.className='choice';
              b.innerHTML = `<span>${formatMoney(opt)}</span><span class="tag">Answer</span>`;
              b.addEventListener('click', ()=>{
                if(st.done) return;
                st.pick = opt;
                markPick(box, i);
                beep(620,50,0.02);
                const ok = (opt === st.total);
                st.done = true;
                if(ok){
                  setMsg('good', `‚úÖ Correct! It‚Äôs <strong>${formatMoney(st.total)}</strong>. Press <strong>New</strong> for another.`);
                  beep(880,90,0.04);
                } else {
                  setMsg('bad', `Not quite. You chose <strong>${formatMoney(opt)}</strong>. Press <strong>Show Answer</strong> or <strong>New</strong>.`);
                  beep(220,120,0.05);
                }
              });
              box.appendChild(b);
            });
            panel.querySelector('#cgShow').addEventListener('click', ()=>{
              setMsg('', `Answer: <strong>${formatMoney(st.total)}</strong>.`);
              beep(740,60,0.03);
            });
          } else {
            hint.innerHTML = `Switch back to Count to practise totals (Count mode is the main one here).`;
            panel.innerHTML = `
              <div class="tray">
                <strong style="font-size:14px;font-weight:950;">Tip</strong>
                <div style="font-size:12px;color:rgba(238,242,255,.72);margin-top:8px;">
                  This page is a menu-driven ‚Äúplay page‚Äù. Your full Coin game modes are already in your original games.html build.
                  If you want, I can paste the complete Coin Sort + Order modes into this play page too (it‚Äôs just long).
                </div>
              </div>
            `;
          }
        }

        renderCoinsGame();
      },
      newRound: (st, difficulty)=> {
        const pool = coinPool(difficulty);
        const nMin = difficulty==='easy' ? 4 : difficulty==='medium' ? 5 : 6;
        const nMax = difficulty==='easy' ? 7 : difficulty==='medium' ? 9 : 11;
        const n = randInt(nMin, nMax);
        const coins = Array.from({length:n}, (_,i)=>{
          const c = pool[randInt(0,pool.length-1)];
          return {...c, id:'c' + Math.random().toString(16).slice(2) + i};
        });
        st.coins = coins.slice();
        st.pick = null; st.done = false;
        st.total = st.coins.reduce((s,c)=>s+c.v,0);

        const opts = new Set([st.total]);
        const wiggles = difficulty==='easy' ? [1,2,5,10] : difficulty==='medium' ? [1,2,5,10,20,50] : [1,2,5,10,20,50,100,200];
        while(opts.size < 4){
          const w = wiggles[randInt(0, wiggles.length-1)] * (Math.random() < .5 ? -1 : 1);
          let cand = st.total + w;
          if(cand < 0) cand = st.total + Math.abs(w);
          opts.add(Math.max(0, cand));
        }
        st.options = shuffle([...opts]);

        setMsg('', `Coin Piggy Bank: count the coins and choose the total.`);
      },
      reset: (st, difficulty)=> { GAMES.find(g=>g.key==='coins').newRound(st, difficulty); setMsg('', `Reset done. Start again.`); }
    }
  ];

  // ---- init based on menu click ----
  const params = new URLSearchParams(location.search);
  const requested = (params.get('game') || 'connect4').toLowerCase();
  const initial = GAMES.find(g=>g.key === requested) || GAMES[0];

  let active = initial;
  let state = active.buildState();

  function render(){
    active.render(state, ui.difficulty.value);
  }
  function newRound(){
    active.newRound?.(state, ui.difficulty.value);
    render();
    beep(820,60,0.03);
  }
  function reset(){
    active.reset?.(state, ui.difficulty.value);
    render();
    beep(520,60,0.02);
  }

  ui.soundBtn.addEventListener('click', ()=>{
    soundOn = !soundOn;
    ui.soundBtn.setAttribute('aria-pressed', String(soundOn));
    ui.soundBtn.textContent = 'Sound: ' + (soundOn ? 'On' : 'Off');
    beep(880,60,0.03);
  });

  ui.newBtn.addEventListener('click', newRound);
  ui.resetBtn.addEventListener('click', reset);
  ui.difficulty.addEventListener('change', ()=> newRound());

  ui.pill.textContent = active.name;
  setMsg('', `Press <strong>New</strong> to start ${active.name}.`);
  render();
})();
</script>
</body>
</html>
