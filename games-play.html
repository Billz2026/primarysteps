<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Games â€¢ Primary Steps</title>
<style>
  :root{
    --bg0:#0b0d12; --bg1:#0f1320;
    --panel:#121621; --panel2:#0d1c36;
    --text:#eef2ff; --muted:rgba(238,242,255,.72);
    --line:rgba(255,255,255,.12);
    --accent:#7dd3fc; --accent2:#a78bfa; --good:#34d399; --bad:#fb7185;
    --ring:rgba(125,211,252,.30);
    --shadow:0 18px 40px rgba(0,0,0,.35);
    --r:18px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 700px at 20% 10%, rgba(125,211,252,.18), transparent 55%),
      radial-gradient(900px 600px at 80% 0%, rgba(167,139,250,.16), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    min-height:100vh;
  }

  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(10px);
    background: rgba(18,22,33,.72);
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1100px;margin:0 auto;padding:14px 16px;}
  .top{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  .brand{display:flex; align-items:center; gap:10px; min-width:0; text-decoration:none; color:var(--text);}
  .brand img{height:52px;width:auto;display:block; filter: drop-shadow(0 16px 30px rgba(125,211,252,.10));}
  .brand .title{font-weight:850; letter-spacing:.2px; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .brand .sub{display:block; font-size:12px; color:var(--muted); margin-top:2px}
  nav{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
  nav a{
    color:var(--text); text-decoration:none; font-weight:700; font-size:13px;
    padding:8px 10px; border-radius:12px;
    border:1px solid transparent;
    opacity:.92;
  }
  nav a:hover{border-color:var(--line); background:rgba(255,255,255,.04); opacity:1;}
  nav a.active{border-color:rgba(125,211,252,.35); background:rgba(125,211,252,.10); opacity:1;}

  .hero{padding:22px 16px 10px;}
  .hwrap{max-width:1100px;margin:0 auto;}
  h1{margin:0 0 6px; font-size:32px; letter-spacing:-.4px;}
  p.lead{margin:0; color:var(--muted); max-width:85ch; font-size:14px; line-height:1.45;}

  .grid{
    max-width:1100px; margin:14px auto 28px; padding:0 16px;
    display:grid; grid-template-columns: 1.15fr .85fr; gap:14px;
  }
  @media (max-width: 980px){ .grid{grid-template-columns:1fr; } nav{justify-content:flex-start;} }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:var(--r);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card .head{
    padding:14px 14px 10px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .pill{
    font-size:12px; font-weight:850;
    padding:6px 10px; border-radius:999px;
    background: rgba(125,211,252,.14);
    border:1px solid rgba(125,211,252,.25);
    color: var(--text);
    white-space:nowrap;
  }
  .body{padding:14px;}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .btn{
    appearance:none; border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    color:var(--text); font-weight:850;
    padding:10px 12px; border-radius:14px;
    cursor:pointer;
    text-decoration:none;
    display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{background: rgba(255,255,255,.08);}
  .btn.primary{
    border-color: rgba(125,211,252,.35);
    background: linear-gradient(180deg, rgba(125,211,252,.18), rgba(125,211,252,.07));
  }
  .btn.good{
    border-color: rgba(52,211,153,.35);
    background: linear-gradient(180deg, rgba(52,211,153,.18), rgba(52,211,153,.06));
  }
  .btn.danger{
    border-color: rgba(251,113,133,.35);
    background: linear-gradient(180deg, rgba(251,113,133,.18), rgba(251,113,133,.06));
  }

  .field{display:flex; flex-direction:column; gap:6px; min-width:240px;}
  label{font-size:12px; color:var(--muted); font-weight:800; letter-spacing:.02em;}
  select{
    width:100%;
    appearance:none;
    border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    font-weight:800;
    cursor:pointer;
    outline:none;
  }
  select:focus{box-shadow: 0 0 0 6px var(--ring);}

  .stat{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px; border-radius:14px;
    border:1px dashed rgba(238,242,255,.22);
    color: var(--muted);
  }
  .small{font-size:12px;color:var(--muted);}
  .msg{
    padding:10px 12px; border-radius:14px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color: var(--muted);
    margin-top:10px;
  }
  .msg.good{border-color:rgba(52,211,153,.35); background: rgba(52,211,153,.10); color: rgba(238,242,255,.92);}
  .msg.bad{border-color:rgba(251,113,133,.35); background: rgba(251,113,133,.10); color: rgba(238,242,255,.92);}

  /* Game stage */
  .stage{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
    background:
      radial-gradient(900px 500px at 10% 0%, rgba(125,211,252,.10), transparent 60%),
      linear-gradient(180deg, rgba(13,28,54,.65), rgba(13,28,54,.35));
  }

  /* Game cards selector */
  .selectorGrid{
    display:grid; grid-template-columns:1fr; gap:10px;
  }
  .gameCard{
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    border-radius:16px;
    padding:12px;
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .gameCard strong{display:block; font-size:14px; font-weight:950;}
  .gameCard .desc{font-size:12px; color:var(--muted); line-height:1.35; margin-top:4px;}
  .gameCard .tag{
    font-size:12px; font-weight:950;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    color: var(--muted);
    background: rgba(0,0,0,.10);
    white-space:nowrap;
  }
  .gameCard.active{
    border-color: rgba(125,211,252,.40);
    background: rgba(125,211,252,.08);
  }

  /* Connect 4 */
  .c4Wrap{display:grid; gap:12px; justify-items:center;}
  .c4Board{
    width:min(420px, 100%);
    aspect-ratio: 7 / 6;
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: repeat(6, 1fr);
    gap:10px;
    padding:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
  }
  .c4Cell{
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    position:relative;
  }
  .c4Disc{
    width:100%; height:100%;
    border-radius:999px;
    transform: scale(.82);
    background: rgba(255,255,255,.06);
    box-shadow: inset 0 10px 20px rgba(0,0,0,.28);
  }
  .c4Disc.r{ background: rgba(251,113,133,.70); }
  .c4Disc.y{ background: rgba(253,224,71,.65); }
  .c4Top{
    width:min(420px, 100%);
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:10px;
  }
  .c4Top button{
    height:42px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.04);
    color:var(--text);
    font-weight:950;
    cursor:pointer;
  }
  .c4Top button:hover{background: rgba(255,255,255,.07);}
  .seg{
    display:flex; gap:8px; flex-wrap:wrap;
    padding:6px; border:1px solid var(--line);
    border-radius:16px; background:rgba(255,255,255,.03);
  }
  .seg button{border-radius:12px; padding:9px 12px;}
  .seg button.on{border-color:rgba(125,211,252,.45); background:rgba(125,211,252,.12);}

  /* Shape Sort */
  .shapeWrap{display:grid; gap:12px;}
  .bins{
    display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;
  }
  @media (max-width: 560px){ .bins{grid-template-columns:1fr;} .brand .title{display:none;} }

  .bin{
    border:1px dashed rgba(238,242,255,.22);
    border-radius:16px;
    padding:12px;
    min-height:120px;
    display:flex; flex-direction:column; gap:10px;
    background: rgba(0,0,0,.10);
  }
  .binTitle{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .binTitle strong{font-size:13px; font-weight:950;}
  .binTitle .mini{font-size:12px; color:var(--muted); font-weight:900;}
  .dropArea{
    flex:1;
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    display:flex; align-items:center; justify-content:center;
    background: rgba(255,255,255,.04);
  }
  .tray{
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:12px;
    background: rgba(0,0,0,.10);
  }
  .shapes{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .shape{
    width:56px; height:56px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    display:flex; align-items:center; justify-content:center;
    cursor:grab;
    user-select:none;
    touch-action:none;
  }

.meter{
  width:100%;
  height:12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.18);
  overflow:hidden;
}
.meter > span{
  display:block;
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(52,211,153,.55), rgba(125,211,252,.55), rgba(167,139,250,.55));
}
.celebrate{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:20;
  overflow:hidden;
}
.conf{
  position:absolute;
  width:10px; height:10px;
  border-radius:3px;
  opacity:.9;
  animation: confettiFall 900ms ease-out forwards;
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.25));
}
@keyframes confettiFall{
  from{ transform: translateY(-20px) rotate(0deg); opacity:0; }
  15%{ opacity:1; }
  to{ transform: translateY(240px) rotate(260deg); opacity:0; }
}

.moneyWrap{display:grid; gap:12px;}
.moneyTop{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
.moneyPanel{
  position:relative;
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  background: rgba(0,0,0,.12);
  padding:12px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}
@media (max-width: 860px){ .moneyPanel{grid-template-columns:1fr;} }

.moneyTray{
  border:1px dashed rgba(238,242,255,.22);
  border-radius:16px;
  padding:12px;
  background: rgba(255,255,255,.03);
  min-height:180px;
}
.moneyTray h3{margin:0 0 8px; font-size:13px;}
.moneyItems{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
.moneyItem{
  position:relative;
  width:84px; height:84px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  display:flex; align-items:center; justify-content:center;
  cursor:grab;
  user-select:none;
  touch-action:none;
  box-shadow: inset 0 10px 18px rgba(0,0,0,.25), 0 10px 20px rgba(0,0,0,.25);
  overflow:hidden;
}
.moneyItem.note{
  width:150px; height:84px;
  border-radius:16px;
}
.moneyItem img{
  width:100%; height:100%;
  object-fit:cover;
  transform: scale(1.02);
}
.moneyItem .val{
  position:absolute;
  bottom:6px; right:8px;
  padding:3px 6px;
  border-radius:10px;
  font-size:12px;
  font-weight:950;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.35);
}
.pigArea{
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  background:
    radial-gradient(600px 300px at 20% 0%, rgba(52,211,153,.10), transparent 55%),
    radial-gradient(600px 300px at 80% 10%, rgba(125,211,252,.10), transparent 55%),
    rgba(255,255,255,.03);
  padding:12px;
  min-height:180px;
  position:relative;
  overflow:hidden;
}
.pigTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
.totalBig{
  font-weight:1000;
  letter-spacing:.3px;
  font-size:18px;
}
.pig{
  position:relative;
  width:min(360px, 100%);
  margin:0 auto;
  aspect-ratio: 16 / 9;
  border-radius:22px;
  background:
    radial-gradient(160px 120px at 25% 35%, rgba(255,255,255,.18), transparent 55%),
    radial-gradient(200px 130px at 75% 30%, rgba(255,255,255,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.14);
  box-shadow: inset 0 18px 28px rgba(0,0,0,.22);
  overflow:hidden;
}
.pig:before{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(240px 120px at 50% 100%, rgba(52,211,153,.08), transparent 70%),
    radial-gradient(240px 120px at 50% 0%, rgba(125,211,252,.08), transparent 70%);
  opacity:.9;
}
.slot{
  position:absolute;
  top:14px; left:50%;
  transform:translateX(-50%);
  width:140px; height:18px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.45);
  background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
  box-shadow: inset 0 6px 10px rgba(0,0,0,.45), 0 10px 20px rgba(0,0,0,.20);
}
.slot:after{
  content:"Drop here";
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  font-size:11px; font-weight:950;
  letter-spacing:.08em;
  color: rgba(238,242,255,.55);
}
.pigBelly{
  position:absolute;
  left:50%; top:52%;
  transform:translate(-50%,-50%);
  width:78%; height:60%;
  border-radius:999px;
  border:1px dashed rgba(238,242,255,.20);
  background: rgba(0,0,0,.12);
  overflow:hidden;
}
.pigBelly .inside{
  position:absolute; inset:10px;
  display:flex; flex-wrap:wrap; gap:8px;
  align-content:flex-start;
  opacity:.95;
}
.insCoin{
  width:34px; height:34px; border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.07);
  overflow:hidden;
}
.insCoin img{width:100%; height:100%; object-fit:cover;}
.insNote{
  width:60px; height:34px; border-radius:10px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.07);
  overflow:hidden;
}
.insNote img{width:100%; height:100%; object-fit:cover;}
.dropGhost{
  position:absolute;
  inset:0;
  pointer-events:none;
}
.floating{
  position:fixed;
  left:0; top:0;
  width:80px; height:80px;
  z-index:9999;
  pointer-events:none;
  transform: translate(-9999px,-9999px);
  transition: transform 0.05s linear;
}
.floating.note{ width:150px; height:84px; border-radius:16px; }
.floating img{width:100%; height:100%; object-fit:cover; border-radius:16px;}
.floating.coin img{border-radius:999px;}
.spark{
  position:absolute;
  width:8px; height:8px;
  border-radius:999px;
  background: rgba(253,224,71,.85);
  box-shadow: 0 0 12px rgba(253,224,71,.55);
  animation: spark 600ms ease-out forwards;
}
@keyframes spark{
  from{ transform: translate(0,0) scale(.8); opacity:1;}
  to{ transform: translate(var(--dx), var(--dy)) scale(0); opacity:0;}
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <a class="brand" href="index.html" aria-label="Primary Steps home">
        <img src="assets/logo.png" alt="Primary Steps">
        <div class="title">
          Primary Steps
          <span class="sub">Simple, calm learning activities</span>
        </div>
      </a>
      <nav>
        <a href="index.html">Home</a>
        <a class="active" href="games.html">Games</a>
      </nav>
    </div>
  </div>
</header>

<section class="hero">
  <div class="hwrap">
    <h1>Games</h1>
    <p class="lead">Pick a game, choose a difficulty, then press <strong>New</strong>. Keep it calm, clear, and fun.</p>
  </div>
</section>

<div class="grid">
  <!-- Left: Stage -->
  <div class="card">
    <div class="head">
      <div class="pill" id="gamePill">Game</div>
      <div class="row">
        <button class="btn primary" id="newBtn">New</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
    </div>
    <div class="body">
      <div class="stage" id="stage"></div>
      <div class="msg" id="msg" style="display:none;"></div>
    </div>
  </div>

  <!-- Right: Controls + selector -->
  <div class="card">
    <div class="head">
      <div class="pill">Choose</div>
      <button class="btn" id="soundBtn" aria-pressed="true">Sound: On</button>
    </div>
    <div class="body">
      <div class="row" style="margin-bottom:12px;">
        <div class="field" style="flex:1;">
          <label for="gameSelect">Activity</label>
          <select id="gameSelect"></select>
        </div>
        <div class="field" style="width:220px;">
          <label for="difficulty">Difficulty</label>
          <select id="difficulty">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
      </div>

      <div class="stat">
        <span id="prompt" class="small">Choose a game card or use the menu.</span>
        <span class="small" id="status">Ready</span>
      </div>

      <div style="height:12px"></div>

      <div class="selectorGrid" id="cards"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const ui = {
    stage: document.getElementById('stage'),
    msg: document.getElementById('msg'),
    gamePill: document.getElementById('gamePill'),
    gameSelect: document.getElementById('gameSelect'),
    difficulty: document.getElementById('difficulty'),
    cards: document.getElementById('cards'),
    prompt: document.getElementById('prompt'),
    status: document.getElementById('status'),
    newBtn: document.getElementById('newBtn'),
    resetBtn: document.getElementById('resetBtn'),
    soundBtn: document.getElementById('soundBtn')
  };

  // ---- sound ----
  let soundOn = true;
  const audioCtx = () => new (window.AudioContext || window.webkitAudioContext)();
  let ctx = null;
  function beep(freq=520, dur=70, gain=0.04, type='sine'){
    if(!soundOn) return;
    try{
      if(!ctx) ctx = audioCtx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + dur/1000);
    }catch(e){}
  }
  function clink(){
    if(!soundOn) return;
    try{
      if(!ctx) ctx = audioCtx();
      // small layered percussive sound
      const now = ctx.currentTime;
      const o1 = ctx.createOscillator();
      const o2 = ctx.createOscillator();
      const g = ctx.createGain();
      const f = ctx.createBiquadFilter();
      f.type = 'highpass'; f.frequency.value = 500;
      o1.type = 'triangle'; o2.type = 'sine';
      o1.frequency.setValueAtTime(900, now);
      o2.frequency.setValueAtTime(600, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.08, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
      o1.connect(f); o2.connect(f); f.connect(g); g.connect(ctx.destination);
      o1.start(now); o2.start(now);
      o1.stop(now+0.2); o2.stop(now+0.2);
    }catch(e){}
  }
  function paperDrop(){
    if(!soundOn) return;
    try{
      if(!ctx) ctx = audioCtx();
      const now = ctx.currentTime;
      // noise burst
      const bufferSize = ctx.sampleRate * 0.18;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i=0;i<bufferSize;i++){
        data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
      }
      const noise = ctx.createBufferSource();
      noise.buffer = buffer;
      const biq = ctx.createBiquadFilter();
      biq.type = 'lowpass';
      biq.frequency.setValueAtTime(1800, now);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.10, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.16);
      noise.connect(biq); biq.connect(g); g.connect(ctx.destination);
      noise.start(now); noise.stop(now + 0.18);
    }catch(e){}
  }

  // ---- helpers ----
  const randInt = (a,b) => Math.floor(a + Math.random()*(b-a+1));
  const choice = arr => arr[randInt(0, arr.length-1)];
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const deepCopy = obj => JSON.parse(JSON.stringify(obj));
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }
  function setMsg(kind, html){
    if(!html){
      ui.msg.style.display='none';
      ui.msg.className='msg';
      ui.msg.innerHTML='';
      return;
    }
    ui.msg.style.display='block';
    ui.msg.className = 'msg' + (kind ? ' ' + kind : '');
    ui.msg.innerHTML = html;
  }
  function setStatus(text){ ui.status.textContent = text; }
  function setPill(text){ ui.gamePill.textContent = text; }

  // ---- Money assets ----
  const MONEY = [
    { id:'1p', type:'coin', v:1, label:'1p', img:'1p coin.jpeg' },
    { id:'2p', type:'coin', v:2, label:'2p', img:'2p coin.jpeg' },
    { id:'5p', type:'coin', v:5, label:'5p', img:'5p coin.jpeg' },
    { id:'10p', type:'coin', v:10, label:'10p', img:'10p coin.jpeg' },
    { id:'20p', type:'coin', v:20, label:'20p', img:'20p coin.webp' },
    { id:'50p', type:'coin', v:50, label:'50p', img:'ironside-new-pence-50p-r.jpg' },
    { id:'Â£1', type:'coin', v:100, label:'Â£1', img:'1 pound coin.webp' },
    { id:'Â£2', type:'coin', v:200, label:'Â£2', img:'2 pound coin.jpg' },
    { id:'Â£5', type:'note', v:500, label:'Â£5', img:'5 pound note.jpg' },
    { id:'Â£10', type:'note', v:1000, label:'Â£10', img:'10 pound note.jpg' },
    { id:'Â£20', type:'note', v:2000, label:'Â£20', img:'20 pound note.jpg' },
    { id:'Â£50', type:'note', v:5000, label:'Â£50', img:'50 pound note.jpg' }
  ];

  // ---- Games definitions ----
  const GAMES = [
    {
      key:'connect4',
      name:'Connect 4',
      tag:'Strategy',
      desc:'Tap a circle to drop a counter. Play vs a friend or CPU (Easy/Medium/Hard).',
      buildState: () => ({
        board: Array.from({length:6}, ()=>Array(7).fill(0)),
        turn: 1, // 1 = Red, 2 = Yellow
        over:false,
        vs:'cpu', // 'cpu' or 'friend'
        cpu:'easy', // easy/medium/hard
        first:'you', // you/cpu
        lastMove:null
      }),
      render: (st) => {
        setPill('Connect 4');
        ui.stage.innerHTML = `
          <div class="c4Wrap">
            <div class="row" style="justify-content:space-between; width:100%; max-width:420px;">
              <div class="seg" id="vsSeg">
                <button class="btn ${st.vs==='friend'?'on':''}" data-vs="friend" type="button">2 Players</button>
                <button class="btn ${st.vs==='cpu'?'on':''}" data-vs="cpu" type="button">Vs CPU</button>
              </div>
              <div class="seg" id="cpuSeg" style="${st.vs==='cpu'?'':'opacity:.45; pointer-events:none;'}">
                <button class="btn ${st.cpu==='easy'?'on':''}" data-cpu="easy" type="button">Easy</button>
                <button class="btn ${st.cpu==='medium'?'on':''}" data-cpu="medium" type="button">Medium</button>
                <button class="btn ${st.cpu==='hard'?'on':''}" data-cpu="hard" type="button">Hard</button>
              </div>
            </div>

            <div class="row" style="justify-content:space-between; width:100%; max-width:420px;">
              <div class="small" id="c4Turn"></div>
              <div class="seg" id="firstSeg" style="${st.vs==='cpu'?'':'display:none;'}">
                <button class="btn ${st.first==='you'?'on':''}" data-first="you" type="button">You first</button>
                <button class="btn ${st.first==='cpu'?'on':''}" data-first="cpu" type="button">CPU first</button>
              </div>
            </div>

            <div class="c4Board" id="c4Board" aria-label="Connect 4 board"></div>
            <div class="row" style="max-width:420px; width:100%; justify-content:space-between;">
              <button class="btn" id="c4Undo" type="button">Undo</button>
              <button class="btn good" id="c4New" type="button">New round</button>
            </div>
          </div>
        `;

        const boardEl = document.getElementById('c4Board');
        const turnEl = document.getElementById('c4Turn');
        const vsSeg = document.getElementById('vsSeg');
        const cpuSeg = document.getElementById('cpuSeg');
        const firstSeg = document.getElementById('firstSeg');
        const undoBtn = document.getElementById('c4Undo');
        const newBtn = document.getElementById('c4New');

        function updateTurnLabel(){
          if(st.over){
            turnEl.innerHTML = `<strong>Round over.</strong>`;
            return;
          }
          if(st.vs==='cpu'){
            const isYouTurn = (st.first==='you') ? (st.turn===1) : (st.turn===2);
            turnEl.innerHTML = isYouTurn ? `<strong>Your turn</strong> (tap a circle)` : `<strong>CPU thinkingâ€¦</strong>`;
          }else{
            turnEl.innerHTML = (st.turn===1) ? `<strong>Red</strong> to play` : `<strong>Yellow</strong> to play`;
          }
        }

        function draw(){
          boardEl.innerHTML = '';
          for(let r=0;r<6;r++){
            for(let c=0;c<7;c++){
              const cell = document.createElement('div');
              cell.className = 'c4Cell';
              cell.dataset.col = c;
              const disc = document.createElement('div');
              disc.className = 'c4Disc ' + (st.board[r][c]===1 ? 'r' : st.board[r][c]===2 ? 'y' : '');
              cell.appendChild(disc);
              cell.addEventListener('click', () => handleMove(c));
              cell.addEventListener('mouseenter', () => boardEl.style.outline = '2px solid rgba(125,211,252,.25)');
              cell.addEventListener('mouseleave', () => boardEl.style.outline = 'none');
              boardEl.appendChild(cell);
            }
          }
          updateTurnLabel();
        }

        function dropInCol(col, player){
          for(let r=5;r>=0;r--){
            if(st.board[r][col]===0){
              st.board[r][col]=player;
              st.lastMove = {r, col, player};
              return r;
            }
          }
          return -1;
        }

        function checkWin(player){
          const b = st.board;
          const H=6,W=7;
          const need=4;
          const dirs = [[1,0],[0,1],[1,1],[1,-1]];
          for(let r=0;r<H;r++){
            for(let c=0;c<W;c++){
              if(b[r][c]!==player) continue;
              for(const [dr,dc] of dirs){
                let k=1;
                while(k<need){
                  const rr=r+dr*k, cc=c+dc*k;
                  if(rr<0||rr>=H||cc<0||cc>=W) break;
                  if(b[rr][cc]!==player) break;
                  k++;
                }
                if(k===need) return true;
              }
            }
          }
          return false;
        }
        function isFull(){
          return st.board[0].every(x=>x!==0);
        }

        function endRound(text, good=true){
          st.over = true;
          setMsg(good?'good':'bad', text);
          setStatus('Finished');
          beep(good?880:240, 120, 0.05, good?'sine':'sawtooth');
        }

        function handleMove(col){
          if(st.over) return;
          // if cpu mode and not your turn, ignore
          if(st.vs==='cpu'){
            const isYouTurn = (st.first==='you') ? (st.turn===1) : (st.turn===2);
            if(!isYouTurn) return;
          }
          const r = dropInCol(col, st.turn);
          if(r<0){ beep(260,70,0.03); return; }
          clink();
          draw();
          if(checkWin(st.turn)){
            const who = (st.vs==='cpu')
              ? (((st.first==='you') ? (st.turn===1) : (st.turn===2)) ? 'You win! ðŸŽ‰' : 'CPU wins ðŸ˜®')
              : (st.turn===1 ? 'Red wins! ðŸŽ‰' : 'Yellow wins! ðŸŽ‰');
            endRound(who, true);
            return;
          }
          if(isFull()){
            endRound('Draw! Try again ðŸ™‚', true);
            return;
          }
          st.turn = (st.turn===1?2:1);
          updateTurnLabel();
          if(st.vs==='cpu'){
            // trigger cpu move if needed
            const isYouTurnNow = (st.first==='you') ? (st.turn===1) : (st.turn===2);
            if(!isYouTurnNow) setTimeout(cpuMove, 380);
          }
        }

        function undo(){
          if(!st.lastMove) return;
          if(st.vs==='cpu'){
            // undo two plies if possible (your move + cpu move)
            // remove last, then previous last
            let removed=0;
            while(removed<2 && st.lastMove){
              const {r,col} = st.lastMove;
              st.board[r][col]=0;
              // find previous move by scanning? easiest: store history.
              // We'll keep a simple history list in state on first use.
              removed++;
              if(st.history && st.history.length){
                st.history.pop(); // remove current
                const prev = st.history[st.history.length-1] || null;
                st.lastMove = prev;
              }else{
                st.lastMove = null;
              }
            }
            st.over=false;
            setMsg('', '');
            draw();
            // restore turn (your turn)
            st.turn = (st.first==='you') ? 1 : 2;
          }else{
            const {r,col} = st.lastMove;
            st.board[r][col]=0;
            if(st.history && st.history.length){
              st.history.pop();
              st.lastMove = st.history[st.history.length-1] || null;
            }else st.lastMove = null;
            st.turn = (st.turn===1?2:1);
            st.over=false;
            setMsg('', '');
            draw();
          }
        }

        function cpuMove(){
          if(st.over) return;
          // ensure history exists
          if(!st.history) st.history = [];
          const cpuPlayer = (st.first==='you') ? 2 : 1;
          if(st.turn !== cpuPlayer) return;

          setStatus('CPUâ€¦');

          const legal = [];
          for(let c=0;c<7;c++){
            if(st.board[0][c]===0) legal.push(c);
          }
          if(!legal.length) return;

          // Helper: simulate
          const simDrop = (b, col, player) => {
            for(let r=5;r>=0;r--){
              if(b[r][col]===0){ b[r][col]=player; return r; }
            }
            return -1;
          };
          const simWin = (b, player) => {
            const H=6,W=7, need=4;
            const dirs=[[1,0],[0,1],[1,1],[1,-1]];
            for(let r=0;r<H;r++){
              for(let c=0;c<W;c++){
                if(b[r][c]!==player) continue;
                for(const [dr,dc] of dirs){
                  let k=1;
                  while(k<need){
                    const rr=r+dr*k, cc=c+dc*k;
                    if(rr<0||rr>=H||cc<0||cc>=W) break;
                    if(b[rr][cc]!==player) break;
                    k++;
                  }
                  if(k===need) return true;
                }
              }
            }
            return false;
          };

          const youPlayer = (cpuPlayer===1?2:1);

          // easy: random
          let pick = choice(legal);

          // medium/hard: basic lookahead
          if(st.cpu==='medium' || st.cpu==='hard'){
            // 1) winning move
            for(const c of legal){
              const b = deepCopy(st.board);
              simDrop(b,c,cpuPlayer);
              if(simWin(b,cpuPlayer)){ pick=c; break; }
            }
            // 2) block your win
            if(pick===undefined){
              for(const c of legal){
                const b = deepCopy(st.board);
                simDrop(b,c,youPlayer);
                if(simWin(b,youPlayer)){ pick=c; break; }
              }
            }
            if(pick===undefined) pick = choice(legal);
          }

          // hard: prefer center + minimize giving you wins (tiny scoring)
          if(st.cpu==='hard'){
            const scoreCol = (c) => {
              let s = 0;
              s -= Math.abs(3-c) * 2; // center bonus
              // don't allow immediate opponent win next
              const b1 = deepCopy(st.board);
              simDrop(b1,c,cpuPlayer);
              for(const oc of legal){
                const b2 = deepCopy(b1);
                simDrop(b2, oc, youPlayer);
                if(simWin(b2,youPlayer)) s -= 50;
              }
              return s + Math.random(); // small randomness
            };
            pick = legal.slice().sort((a,b)=>scoreCol(b)-scoreCol(a))[0];
          }

          // apply
          if(!st.history) st.history = [];
          const r = dropInCol(pick, cpuPlayer);
          st.history.push(st.lastMove);
          clink();
          draw();
          setStatus('Ready');
          if(checkWin(cpuPlayer)){
            endRound('CPU wins ðŸ˜®', false);
            return;
          }
          if(isFull()){
            endRound('Draw! Try again ðŸ™‚', true);
            return;
          }
          st.turn = youPlayer;
          updateTurnLabel();
        }

        // hook segments
        vsSeg.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            st.vs = btn.dataset.vs;
            if(st.vs==='friend'){
              st.first='you';
            }
            setMsg('', '');
            draw();
            // refresh UI segments
            setActiveFromSelect(false);
            newRound();
          });
        });
        cpuSeg.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            st.cpu = btn.dataset.cpu;
            setActiveFromSelect(false);
            newRound();
          });
        });
        firstSeg.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            st.first = btn.dataset.first;
            setActiveFromSelect(false);
            newRound();
          });
        });

        undoBtn.addEventListener('click', undo);
        newBtn.addEventListener('click', ()=>{
          // reset state cleanly
          st.board = Array.from({length:6}, ()=>Array(7).fill(0));
          st.turn = (st.vs==='cpu' && st.first==='cpu') ? ((st.first==='you')?1:2) : 1;
          st.over=false;
          st.lastMove=null;
          st.history=[];
          setMsg('', '');
          draw();
          // if cpu first, play
          if(st.vs==='cpu' && st.first==='cpu'){
            st.turn = (st.first==='you') ? 2 : 1;
            setTimeout(()=>cpuMove(), 450);
          }
        });

        // initialize history
        st.history = st.history || [];
        // if CPU first, make a move
        draw();
        if(st.vs==='cpu' && st.first==='cpu'){
          const cpuPlayer = (st.first==='you') ? 2 : 1;
          st.turn = cpuPlayer;
          setTimeout(()=>cpuMove(), 480);
        }
      },
      newRound: (st)=> {
        st.board = Array.from({length:6}, ()=>Array(7).fill(0));
        st.over=false;
        st.lastMove=null;
        st.history=[];
        // decide starting turn
        if(st.vs==='cpu'){
          if(st.first==='you'){
            st.turn = 1; // you = red by convention
          }else{
            st.turn = 2; // cpu starts (yellow)
          }
        }else{
          st.turn = 1;
        }
        setMsg('', '');
        setStatus('Ready');
      },
      reset: (st)=> {
        st.board = Array.from({length:6}, ()=>Array(7).fill(0));
        st.turn=1;
        st.over=false;
        st.lastMove=null;
        st.history=[];
        setMsg('', '');
      }
    },

    {
      key:'coins',
      name:'Coin Piggy Bank',
      tag:'Money',
      desc:'Drag UK coins and notes into the piggy bank. Count, sort, and hit goals with voice prompts.',
      buildState: () => ({
        // gameplay settings
        mode: 'count', // count/sort/order
        moneyFilter: 'mixed', // mixed/coins/notes
        // round state
        countTray: [],
        pigCoins: [],
        sortCoins: [],
        placed: 0,
        orderIds: [],
        _allCoins: [],
        total: 0,
        options: [],
        pick: null,
        done:false,
        // goals
        saved: 0,
        goalTargets: [100, 500, 1000, 2000, 5000], // pence
        lastGoalHit: 0,
        // voice
        voiceOn: true
      }),
      render: (st, difficulty) => {
        setPill('Coin Piggy Bank');
        ui.stage.innerHTML = `
          <div class="moneyWrap">
            <div class="moneyTop">
              <div class="seg" id="moneyModeSeg">
                <button class="btn ${st.mode==='count'?'on':''}" data-mode="count" type="button">Count</button>
                <button class="btn ${st.mode==='sort'?'on':''}" data-mode="sort" type="button">Sort</button>
                <button class="btn ${st.mode==='order'?'on':''}" data-mode="order" type="button">Order</button>
              </div>

              <div class="seg" id="moneyFilterSeg">
                <button class="btn ${st.moneyFilter==='mixed'?'on':''}" data-filter="mixed" type="button">Mixed</button>
                <button class="btn ${st.moneyFilter==='coins'?'on':''}" data-filter="coins" type="button">Coins</button>
                <button class="btn ${st.moneyFilter==='notes'?'on':''}" data-filter="notes" type="button">Notes</button>
              </div>

              <div class="seg" id="voiceSeg">
                <button class="btn ${st.voiceOn?'on':''}" id="voiceToggle" type="button">Voice: ${st.voiceOn?'On':'Off'}</button>
                <button class="btn" id="sayBtn" type="button">ðŸ”Š Say it</button>
              </div>
            </div>

            <div class="stat">
              <span class="small" id="moneyPrompt">Drag the money into the piggy bank slot.</span>
              <span class="small"><strong>Total saved:</strong> <span id="savedTotal">Â£0.00</span></span>
            </div>

            <div class="meter" aria-label="goal meter"><span id="goalBar"></span></div>

            <div class="moneyPanel" id="moneyPanel">
              <div class="celebrate" id="celebrate"></div>
              <div class="moneyTray">
                <h3 id="trayTitle">Tray</h3>
                <div class="moneyItems" id="moneyItems"></div>
                <div class="row" id="countOptions" style="margin-top:10px; display:none;"></div>
              </div>

              <div class="pigArea">
                <div class="pigTop">
                  <div class="totalBig">Piggy Bank</div>
                  <div class="small"><strong>Round total:</strong> <span id="roundTotal">Â£0.00</span></div>
                </div>
                <div class="pig" id="pig">
                  <div class="slot" id="slot" aria-label="Piggy bank slot"></div>
                  <div class="pigBelly">
                    <div class="inside" id="inside"></div>
                  </div>
                </div>
                <div class="small" style="margin-top:8px; color:rgba(238,242,255,.72);">
                  Tip: On touch devices, tap money then tap the pig.
                </div>
              </div>
            </div>
          </div>
        `;

        // ---- Voice ----
        function say(text){
          if(!st.voiceOn) return;
          try{
            if(!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            // Prefer UK English if available
            u.lang = 'en-GB';
            u.rate = 0.95;
            u.pitch = 1.05;
            window.speechSynthesis.speak(u);
          }catch(e){}
        }

        // ---- Elements ----
        const modeSeg = document.getElementById('moneyModeSeg');
        const filterSeg = document.getElementById('moneyFilterSeg');
        const voiceToggle = document.getElementById('voiceToggle');
        const sayBtn = document.getElementById('sayBtn');
        const moneyPrompt = document.getElementById('moneyPrompt');
        const savedTotal = document.getElementById('savedTotal');
        const roundTotal = document.getElementById('roundTotal');
        const goalBar = document.getElementById('goalBar');
        const trayTitle = document.getElementById('trayTitle');
        const moneyItems = document.getElementById('moneyItems');
        const inside = document.getElementById('inside');
        const slot = document.getElementById('slot');
        const celebrate = document.getElementById('celebrate');
        const countOptions = document.getElementById('countOptions');
        const pig = document.getElementById('pig');

        // touch helper
        let selectedTouchItem = null;

        // Formatting
        const fmtPence = (p) => {
          const pounds = (p/100).toFixed(2);
          return 'Â£' + pounds;
        };

        // Build pool based on difficulty + filter
        function moneyPool(diff, filter){
          let pool = MONEY.slice();
          if(filter==='coins') pool = pool.filter(x=>x.type==='coin');
          if(filter==='notes') pool = pool.filter(x=>x.type==='note');

          if(diff==='easy'){
            // small values
            pool = pool.filter(x=>x.v<=50);
            if(!pool.length) pool = MONEY.filter(x=>x.type==='coin' && x.v<=50);
          }else if(diff==='medium'){
            pool = pool.filter(x=>x.v<=500); // include Â£5
            if(!pool.length) pool = MONEY.filter(x=>x.v<=500);
          }else{
            // all
          }
          return pool;
        }

        // Celebration
        function popConfetti(){
          for(let i=0;i<22;i++){
            const d = document.createElement('div');
            d.className='conf';
            d.style.left = randInt(10,90)+'%';
            d.style.top = randInt(-10,10)+'px';
            d.style.background = `hsla(${randInt(160,280)}, 85%, 70%, .95)`;
            celebrate.appendChild(d);
            setTimeout(()=>d.remove(), 950);
          }
        }
        function sparkAt(el){
          const rect = el.getBoundingClientRect();
          for(let i=0;i<10;i++){
            const s = document.createElement('div');
            s.className='spark';
            s.style.left = (rect.left + rect.width/2) + 'px';
            s.style.top = (rect.top + rect.height/2) + 'px';
            s.style.setProperty('--dx', randInt(-60,60)+'px');
            s.style.setProperty('--dy', randInt(-40,40)+'px');
            document.body.appendChild(s);
            setTimeout(()=>s.remove(), 650);
          }
        }

        // Goal meter
        function updateGoal(){
          const next = st.goalTargets.find(g => g > st.saved) || (st.saved + 1000);
          const prev = st.goalTargets.slice().reverse().find(g => g <= st.saved) || 0;
          const pct = next===prev ? 100 : ((st.saved - prev) / (next - prev)) * 100;
          goalBar.style.width = clamp(pct,0,100) + '%';
        }

        function checkGoals(){
          const hit = st.goalTargets.filter(g => g <= st.saved).slice(-1)[0] || 0;
          if(hit > st.lastGoalHit){
            st.lastGoalHit = hit;
            popConfetti();
            beep(920,90,0.06,'sine');
            setMsg('good', `Goal reached: <strong>${fmtPence(hit)}</strong> ðŸŽ‰`);
            say(`Well done! You reached ${fmtPence(hit)}.`);
          }
        }

        function updateTotals(){
          savedTotal.textContent = fmtPence(st.saved);
          roundTotal.textContent = fmtPence(st.total);
          updateGoal();
        }

        // Render inside pig
        function renderInside(){
          inside.innerHTML = '';
          const items = st.pigCoins || [];
          items.slice(-16).forEach(it=>{
            const div = document.createElement('div');
            div.className = it.type==='note' ? 'insNote' : 'insCoin';
            div.innerHTML = `<img src="${it.img}" alt="${it.label}">`;
            inside.appendChild(div);
          });
        }

        // Make draggable item
        function makeMoneyEl(item){
          const el = document.createElement('div');
          el.className = 'moneyItem ' + (item.type==='note' ? 'note':'coin');
          el.setAttribute('role','button');
          el.setAttribute('tabindex','0');
          el.dataset.id = item.id;
          el.innerHTML = `<img src="${item.img}" alt="${item.label}"><span class="val">${item.label}</span>`;

          // Drag (pointer)
          let dragging = false;
          let floatEl = null;

          function startDrag(clientX, clientY){
            dragging = true;
            el.style.opacity = '0.45';
            // floating preview
            floatEl = document.createElement('div');
            floatEl.className = 'floating ' + (item.type==='note' ? 'note':'coin');
            floatEl.classList.add(item.type==='note' ? 'note':'coin');
            floatEl.innerHTML = `<img src="${item.img}" alt="">`;
            document.body.appendChild(floatEl);
            moveDrag(clientX, clientY);
          }
          function moveDrag(clientX, clientY){
            if(!dragging || !floatEl) return;
            floatEl.style.transform = `translate(${clientX - (item.type==='note'?75:40)}px, ${clientY - (item.type==='note'?42:40)}px)`;
          }
          function endDrag(clientX, clientY){
            if(!dragging) return;
            dragging = false;
            el.style.opacity = '1';
            if(floatEl){ floatEl.remove(); floatEl = null; }

            // check drop over slot
            const s = slot.getBoundingClientRect();
            if(clientX>=s.left && clientX<=s.right && clientY>=s.top && clientY<=s.bottom){
              // accept drop
              dropIntoPig(item, el);
            }else{
              beep(260,60,0.03);
            }
          }

          // pointer events
          el.addEventListener('pointerdown', (e)=>{
            if(e.pointerType==='touch'){
              // touch-friendly: tap to select
              selectedTouchItem = item;
              moneyPrompt.textContent = `Selected ${item.label}. Now tap the pig to drop it in.`;
              say(`Put the ${item.label} in the piggy bank.`);
              highlightSelection(el);
              return;
            }
            el.setPointerCapture(e.pointerId);
            startDrag(e.clientX, e.clientY);
          });
          el.addEventListener('pointermove', (e)=> moveDrag(e.clientX, e.clientY));
          el.addEventListener('pointerup', (e)=> endDrag(e.clientX, e.clientY));
          el.addEventListener('pointercancel', (e)=> endDrag(e.clientX, e.clientY));

          // keyboard
          el.addEventListener('keydown', (e)=>{
            if(e.key==='Enter' || e.key===' '){
              selectedTouchItem = item;
              moneyPrompt.textContent = `Selected ${item.label}. Now press Enter on the pig to drop it in.`;
              say(`Put the ${item.label} in the piggy bank.`);
              e.preventDefault();
            }
          });

          return el;
        }

        function highlightSelection(activeEl){
          // outline selected in tray
          [...moneyItems.children].forEach(ch=>{
            ch.style.outline = (ch===activeEl) ? '2px solid rgba(125,211,252,.6)' : 'none';
            ch.style.outlineOffset = (ch===activeEl) ? '3px' : '0';
          });
        }

        // Drop logic per mode
        function dropIntoPig(item, sourceEl){
          // animate spark at pig
          sparkAt(pig);

          // play sound
          if(item.type==='note') paperDrop();
          else clink();

          // Count mode: move from tray to pig
          if(st.mode==='count'){
            const idx = st.countTray.findIndex(x=>x.id===item.id);
            if(idx>=0){
              st.pigCoins.push(item);
              st.countTray.splice(idx,1);
              st.saved += item.v;
              renderCoinsGame();
              // if all dropped, show options
              if(st.countTray.length===0){
                countOptions.style.display = 'flex';
                moneyPrompt.textContent = `How much did you put in the piggy bank?`;
                say('How much did you put in the piggy bank? Choose the correct amount.');
              }
            }
          }

          // Sort mode: just count placed, saved total still increases
          if(st.mode==='sort'){
            // They can place coins into pig in ascending order (visual prompt)
            // We'll accept only if it's >= last placed value.
            const last = (st.pigCoins.length ? st.pigCoins[st.pigCoins.length-1].v : -1);
            if(item.v < last){
              beep(240,90,0.05,'sawtooth');
              setMsg('bad', `Try again: put the money in <strong>smallest to biggest</strong>.`);
              say('Try again. Put the money in from smallest to biggest.');
              return;
            }
            const idx = st.sortCoins.findIndex(x=>x.id===item.id);
            if(idx>=0){
              st.pigCoins.push(item);
              st.sortCoins.splice(idx,1);
              st.saved += item.v;
              renderCoinsGame();
              if(st.sortCoins.length===0){
                setMsg('good', `Great sorting! ðŸŽ‰`);
                say('Great sorting!');
              }
            }
          }

          // Order mode: swaps in list, not piggy drop
          if(st.mode==='order'){
            // In order mode, dropping is not used
          }

          checkGoals();
          updateTotals();
        }

        // Pig tap (touch)
        pig.addEventListener('click', ()=>{
          if(!selectedTouchItem) return;
          // find element in current tray
          const item = selectedTouchItem;
          selectedTouchItem = null;
          moneyPrompt.textContent = `Dropping ${item.label}â€¦`;
          dropIntoPig(item);
          // clear highlights
          [...moneyItems.children].forEach(ch=>{ ch.style.outline='none'; ch.style.outlineOffset='0'; });
        });
        pig.setAttribute('tabindex','0');
        pig.addEventListener('keydown', (e)=>{
          if((e.key==='Enter' || e.key===' ') && selectedTouchItem){
            const item = selectedTouchItem;
            selectedTouchItem = null;
            dropIntoPig(item);
            e.preventDefault();
          }
        });

        // Mode & Filter handlers
        modeSeg.querySelectorAll('button').forEach(b=>{
          b.addEventListener('click', ()=>{
            st.mode = b.dataset.mode;
            setMsg('', '');
            say(`Mode: ${st.mode}.`);
            GAMES.find(g=>g.key==='coins').newRound(st, difficulty);
            renderCoinsGame();
          });
        });
        filterSeg.querySelectorAll('button').forEach(b=>{
          b.addEventListener('click', ()=>{
            st.moneyFilter = b.dataset.filter;
            setMsg('', '');
            say(`${st.moneyFilter} selected.`);
            GAMES.find(g=>g.key==='coins').newRound(st, difficulty);
            renderCoinsGame();
          });
        });

        voiceToggle.addEventListener('click', ()=>{
          st.voiceOn = !st.voiceOn;
          voiceToggle.classList.toggle('on', st.voiceOn);
          voiceToggle.textContent = `Voice: ${st.voiceOn?'On':'Off'}`;
          beep(820,60,0.03);
        });
        sayBtn.addEventListener('click', ()=>{
          say(moneyPrompt.textContent);
          beep(740,60,0.03);
        });

        // Main render switch
        function renderCoinsGame(){
          // update seg buttons state
          modeSeg.querySelectorAll('button').forEach(btn=>{
            btn.classList.toggle('on', btn.dataset.mode===st.mode);
          });
          filterSeg.querySelectorAll('button').forEach(btn=>{
            btn.classList.toggle('on', btn.dataset.filter===st.moneyFilter);
          });

          // titles + prompt
          if(st.mode==='count'){
            trayTitle.textContent = 'Money tray (drag into pig)';
            moneyPrompt.textContent = 'Drag each coin/note into the slot. Then choose the total.';
          }else if(st.mode==='sort'){
            trayTitle.textContent = 'Sort tray (smallest to biggest)';
            moneyPrompt.textContent = 'Drag money into the pig from smallest to biggest.';
          }else{
            trayTitle.textContent = 'Order the money (tap two to swap)';
            moneyPrompt.textContent = 'Tap two items to swap them until they are smallest to biggest.';
          }

          // build items
          moneyItems.innerHTML = '';
          inside.innerHTML = '';
          countOptions.innerHTML = '';
          countOptions.style.display = 'none';

          // reset tray highlights
          selectedTouchItem = null;

          // render based on mode
          if(st.mode==='count'){
            st.countTray.forEach(item=>{
              moneyItems.appendChild(makeMoneyEl(item));
            });
            renderInside();
            // options
            const opts = st.options || [];
            countOptions.style.display = (st.countTray.length===0) ? 'flex' : 'none';
            if(st.countTray.length===0){
              opts.forEach(val=>{
                const b = document.createElement('button');
                b.className = 'btn';
                b.type = 'button';
                b.textContent = fmtPence(val);
                b.addEventListener('click', ()=>{
                  st.pick = val;
                  if(val===st.total){
                    setMsg('good', `Correct! ðŸŽ‰ It was <strong>${fmtPence(st.total)}</strong>.`);
                    say(`Correct. It was ${fmtPence(st.total)}.`);
                    popConfetti();
                    beep(920,90,0.06,'sine');
                  }else{
                    setMsg('bad', `Not quite. Try again ðŸ™‚`);
                    say('Not quite. Try again.');
                    beep(240,120,0.05,'sawtooth');
                  }
                });
                countOptions.appendChild(b);
              });
            }
          }

          if(st.mode==='sort'){
            st.sortCoins.forEach(item=>{
              moneyItems.appendChild(makeMoneyEl(item));
            });
            renderInside();
          }

          if(st.mode==='order'){
            // order mode: list that can swap by tapping items
            const list = document.createElement('div');
            list.className = 'moneyItems';
            list.style.gap = '10px';
            list.style.flexWrap = 'wrap';

            const orderSet = st._allCoins || [];
            const getById = (id)=>orderSet.find(x=>x.id===id);

            st.orderIds.forEach((id)=>{
              const item = getById(id);
              if(!item) return;
              const el = document.createElement('div');
              el.className = 'moneyItem ' + (item.type==='note' ? 'note':'coin');
              el.innerHTML = `<img src="${item.img}" alt="${item.label}"><span class="val">${item.label}</span>`;
              el.style.cursor='pointer';
              el.addEventListener('click', ()=>{
                if(st.selectedIdx==null){
                  st.selectedIdx = st.orderIds.indexOf(id);
                  highlightSelectionOrder();
                  beep(720,60,0.03);
                }else{
                  const i1 = st.selectedIdx;
                  const i2 = st.orderIds.indexOf(id);
                  [st.orderIds[i1], st.orderIds[i2]] = [st.orderIds[i2], st.orderIds[i1]];
                  st.selectedIdx = null;
                  highlightSelectionOrder();
                  beep(860,60,0.03);
                  // check
                  if(isCorrectOrder(st)){
                    setMsg('good', 'Perfect order! ðŸŽ‰');
                    say('Perfect order!');
                    popConfetti();
                    beep(980,90,0.06,'sine');
                  }
                }
              });
              list.appendChild(el);
            });

            moneyItems.appendChild(list);
            renderInside();

            function highlightSelectionOrder(){
              const items = list.querySelectorAll('.moneyItem');
              items.forEach((el, idx)=>{
                el.style.outline = (st.selectedIdx===idx) ? '2px solid rgba(125,211,252,.6)' : 'none';
                el.style.outlineOffset = (st.selectedIdx===idx) ? '3px' : '0';
              });
            }
            function isCorrectOrder(st){
              const values = st.orderIds.map(id => (st._allCoins.find(c=>c.id===id) || {}).v);
              const sorted = [...values].slice().sort((a,b)=>a-b);
              for(let i=0;i<sorted.length;i++) if(sorted[i]!==values[i]) return false;
              return true;
            }
          }

          updateTotals();
        }

        // initial render
        renderCoinsGame();
      },
      newRound: (st, difficulty)=> {
        const pool = (function(){
          let p = MONEY.slice();
          if(st.moneyFilter==='coins') p = p.filter(x=>x.type==='coin');
          if(st.moneyFilter==='notes') p = p.filter(x=>x.type==='note');
          if(difficulty==='easy'){
            p = p.filter(x=>x.v<=50);
            if(!p.length) p = MONEY.filter(x=>x.type==='coin' && x.v<=50);
          }else if(difficulty==='medium'){
            p = p.filter(x=>x.v<=500);
            if(!p.length) p = MONEY.filter(x=>x.v<=500);
          }
          return p;
        })();

        const nMin = difficulty==='easy' ? 4 : difficulty==='medium' ? 5 : 6;
        const nMax = difficulty==='easy' ? 7 : difficulty==='medium' ? 9 : 11;
        const n = randInt(nMin, nMax);

        const roundCoins = Array.from({length:n}, (_,i)=>{
          const c = pool[randInt(0,pool.length-1)];
          return {...c, id:'m' + Math.random().toString(16).slice(2) + i};
        });

        st.countTray = roundCoins.slice();
        st.pigCoins = [];
        st.sortCoins = roundCoins.slice().sort(()=>Math.random()-0.5);
        st.total = roundCoins.reduce((s,c)=>s+c.v,0);

        // options for count
        const opts = new Set([st.total]);
        const wiggles = Array.from(new Set(pool.map(x=>x.v))).sort((a,b)=>a-b);
        while(opts.size < 4){
          const w = wiggles[randInt(0, wiggles.length-1)] * (Math.random() < .5 ? -1 : 1);
          let cand = st.total + w;
          if(cand < 0) cand = st.total + Math.abs(w);
          opts.add(Math.max(0, cand));
        }
        st.options = shuffle([...opts]);

        // order mode set: unique values to make ordering clear
        const uniq = [];
        const seen = new Set();
        for(const c of pool){
          if(!seen.has(c.v)){ uniq.push(c); seen.add(c.v); }
        }
        const orderCount = difficulty==='easy' ? 5 : difficulty==='medium' ? 6 : 8;
        const orderSet = shuffle(uniq.slice()).slice(0, orderCount).map((c,i)=>({...c, id:'o'+Math.random().toString(16).slice(2)+i}));
        st._allCoins = orderSet.slice();
        st.orderIds = shuffle(orderSet.map(c=>c.id));
        st.selectedIdx = null;

        setMsg('', `Coin Piggy Bank: choose Count / Sort / Order, then play.`);
      },
      reset: (st, difficulty)=> {
        GAMES.find(g=>g.key==='coins').newRound(st, difficulty);
        setMsg('', `Reset done. Start again.`);
      }
    }
  ];

  // ---- chooser UI ----
  function rebuildChooser(){
    ui.gameSelect.innerHTML = '';
    GAMES.forEach(g=>{
      const o = document.createElement('option');
      o.value = g.key;
      o.textContent = g.name;
      ui.gameSelect.appendChild(o);
    });

    ui.cards.innerHTML = '';
    GAMES.forEach(g=>{
      const div = document.createElement('div');
      div.className = 'gameCard';
      div.dataset.key = g.key;
      div.innerHTML = `
        <div>
          <strong>${g.name}</strong>
          <div class="desc">${g.desc}</div>
        </div>
        <span class="tag">${g.tag}</span>
      `;
      div.addEventListener('click', ()=>{
        ui.gameSelect.value = g.key;
        setActiveFromSelect(true);
      });
      ui.cards.appendChild(div);
    });
  }

  let active = null;
  let state = null;

  function markActiveCard(){
    [...ui.cards.querySelectorAll('.gameCard')].forEach(c=>{
      c.classList.toggle('active', c.dataset.key === active?.key);
    });
  }

  function setActiveFromSelect(runNew=false){
    const key = ui.gameSelect.value;
    active = GAMES.find(g=>g.key===key) || GAMES[0];
    state = active.buildState();
    markActiveCard();
    renderActive();
    if(runNew) newRound();
    else setMsg('', `Press <strong>New</strong> to start ${active.name}.`);
    beep(720,60,0.02);
  }

  function renderActive(){
    active.render(state, ui.difficulty.value);
  }

  function newRound(){
    active.newRound?.(state, ui.difficulty.value);
    renderActive();
    beep(820,60,0.03);
  }
  function reset(){
    active.reset?.(state, ui.difficulty.value);
    renderActive();
    beep(520,60,0.02);
  }

  ui.newBtn.addEventListener('click', newRound);
  ui.resetBtn.addEventListener('click', reset);

  ui.gameSelect.addEventListener('change', ()=> setActiveFromSelect(true));
  ui.difficulty.addEventListener('change', ()=>{
    if(!active) return;
    newRound();
  });

  ui.soundBtn.addEventListener('click', ()=>{
    soundOn = !soundOn;
    ui.soundBtn.setAttribute('aria-pressed', String(soundOn));
    ui.soundBtn.textContent = 'Sound: ' + (soundOn ? 'On' : 'Off');
    beep(880,60,0.03);
  });

  // init
  rebuildChooser();
  if (ui.gameSelect && ui.gameSelect.options && ui.gameSelect.options.length === 0) {
    ui.prompt.textContent = "No games loaded â€” please refresh or re-upload games-play.html.";
  }
  ui.difficulty.value = 'medium';

  // Preselect from URL e.g. games-play.html?game=connect4 or ?game=coins
  const qs = new URLSearchParams(location.search);
  const pre = (qs.get('game') || '').toLowerCase();
  const exists = GAMES.some(g => g.key === pre);
  ui.gameSelect.value = exists ? pre : 'connect4';
  setActiveFromSelect(false);
  // Auto-start the selected game
  try { newRound(); } catch(e) { console.warn(e); }
})();
</script>
</body>
</html>
